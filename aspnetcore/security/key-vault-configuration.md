---
title: Provedor de configuração de Cofre de chaves do Azure no ASP.NET Core
author: guardrex
description: Saiba como usar o provedor de configuração do Cofre de chave do Azure para configurar um aplicativo usando pares de nome-valor carregados no tempo de execução.
monikerRange: '>= aspnetcore-1.1'
ms.author: riande
ms.custom: mvc
ms.date: 10/24/2018
uid: security/key-vault-configuration
ms.openlocfilehash: c6dc8b9c462841351b3ada72deeae727da356a6c
ms.sourcegitcommit: 375e9a67f5e1f7b0faaa056b4b46294cc70f55b7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/29/2018
ms.locfileid: "50207882"
---
# <a name="azure-key-vault-configuration-provider-in-aspnet-core"></a><span data-ttu-id="3da70-103">Provedor de configuração de Cofre de chaves do Azure no ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="3da70-103">Azure Key Vault configuration provider in ASP.NET Core</span></span>

<span data-ttu-id="3da70-104">Por [Luke Latham](https://github.com/guardrex) e [Andrew Stanton-Nurse](https://github.com/anurse)</span><span class="sxs-lookup"><span data-stu-id="3da70-104">By [Luke Latham](https://github.com/guardrex) and [Andrew Stanton-Nurse](https://github.com/anurse)</span></span>

<span data-ttu-id="3da70-105">Este documento explica como usar o [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) provedor de configuração para carregar valores de configuração de aplicativo de segredos do Cofre de chaves do Azure.</span><span class="sxs-lookup"><span data-stu-id="3da70-105">This document explains how to use the [Microsoft Azure Key Vault](https://azure.microsoft.com/services/key-vault/) configuration provider to load app configuration values from Azure Key Vault secrets.</span></span> <span data-ttu-id="3da70-106">O Azure Key Vault é um serviço baseado em nuvem que ajuda você a proteger chaves criptográficas e segredos usados por aplicativos e serviços.</span><span class="sxs-lookup"><span data-stu-id="3da70-106">Azure Key Vault is a cloud-based service that helps you safeguard cryptographic keys and secrets used by apps and services.</span></span> <span data-ttu-id="3da70-107">Cenários comuns incluem controlar o acesso aos dados de configuração confidenciais e atender o requisito para FIPS 140-2 nível 2 validados módulos de segurança de Hardware (HSM) ao armazenar dados de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-107">Common scenarios include controlling access to sensitive configuration data and meeting the requirement for FIPS 140-2 Level 2 validated Hardware Security Modules (HSM's) when storing configuration data.</span></span> <span data-ttu-id="3da70-108">Esse recurso está disponível para aplicativos que usam o ASP.NET Core 1.1 ou superior.</span><span class="sxs-lookup"><span data-stu-id="3da70-108">This feature is available for apps that target ASP.NET Core 1.1 or higher.</span></span>

<span data-ttu-id="3da70-109">[Exibir ou baixar código de exemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([como baixar](xref:index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="3da70-109">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples) ([how to download](xref:index#how-to-download-a-sample))</span></span>

## <a name="package"></a><span data-ttu-id="3da70-110">Pacote</span><span class="sxs-lookup"><span data-stu-id="3da70-110">Package</span></span>

<span data-ttu-id="3da70-111">Para usar o provedor, adicione uma referência para o [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) pacote.</span><span class="sxs-lookup"><span data-stu-id="3da70-111">To use the provider, add a reference to the [Microsoft.Extensions.Configuration.AzureKeyVault](https://www.nuget.org/packages/Microsoft.Extensions.Configuration.AzureKeyVault/) package.</span></span>

## <a name="app-configuration"></a><span data-ttu-id="3da70-112">Configuração de aplicativo</span><span class="sxs-lookup"><span data-stu-id="3da70-112">App configuration</span></span>

<span data-ttu-id="3da70-113">Você pode explorar o provedor com o [aplicativos de exemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span><span class="sxs-lookup"><span data-stu-id="3da70-113">You can explore the provider with the [sample apps](https://github.com/aspnet/Docs/tree/master/aspnetcore/security/key-vault-configuration/samples).</span></span> <span data-ttu-id="3da70-114">Depois de estabelecer um cofre de chaves e crie os segredos no cofre, os aplicativos de exemplo carregar os valores secretos em suas configurações e exibem-las em páginas da Web com segurança.</span><span class="sxs-lookup"><span data-stu-id="3da70-114">Once you establish a key vault and create secrets in the vault, the sample apps securely load the secret values into their configurations and display them in webpages.</span></span>

<span data-ttu-id="3da70-115">O provedor é adicionado à configuração do aplicativo com o `AddAzureKeyVault` extensão.</span><span class="sxs-lookup"><span data-stu-id="3da70-115">The provider is added to the app's configuration with the `AddAzureKeyVault` extension.</span></span> <span data-ttu-id="3da70-116">Em aplicativos de exemplo, a extensão usa três valores de configuração carregados a partir de *appSettings. JSON* arquivo.</span><span class="sxs-lookup"><span data-stu-id="3da70-116">In the sample apps, the extension uses three configuration values loaded from the *appsettings.json* file.</span></span>

| <span data-ttu-id="3da70-117">Configuração de aplicativo</span><span class="sxs-lookup"><span data-stu-id="3da70-117">App Setting</span></span>    | <span data-ttu-id="3da70-118">Descrição</span><span class="sxs-lookup"><span data-stu-id="3da70-118">Description</span></span>                    | <span data-ttu-id="3da70-119">Exemplo</span><span class="sxs-lookup"><span data-stu-id="3da70-119">Example</span></span>                                      |
| -------------- | ------------------------------ | -------------------------------------------- |
| `Vault`        | <span data-ttu-id="3da70-120">Nome do Cofre de chaves do Azure</span><span class="sxs-lookup"><span data-stu-id="3da70-120">Azure Key Vault name</span></span>           | <span data-ttu-id="3da70-121">contosovault</span><span class="sxs-lookup"><span data-stu-id="3da70-121">contosovault</span></span>                                 |
| `ClientId`     | <span data-ttu-id="3da70-122">Id do aplicativo do Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3da70-122">Azure Active Directory App Id</span></span>  | <span data-ttu-id="3da70-123">627e911e-43cc-61d4-992e-12db9c81b413</span><span class="sxs-lookup"><span data-stu-id="3da70-123">627e911e-43cc-61d4-992e-12db9c81b413</span></span>         |
| `ClientSecret` | <span data-ttu-id="3da70-124">Chave do aplicativo do Azure Active Directory</span><span class="sxs-lookup"><span data-stu-id="3da70-124">Azure Active Directory App Key</span></span> | <span data-ttu-id="3da70-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span><span class="sxs-lookup"><span data-stu-id="3da70-125">g58K3dtg59o1Pa+e59v2Tx829w6VxTB2yv9sv/101di=</span></span> |

[!code-csharp[Program](key-vault-configuration/samples/basic-sample/2.x/Program.cs?name=snippet1)]

## <a name="create-key-vault-secrets-and-load-configuration-values-basic-sample"></a><span data-ttu-id="3da70-126">Crie os segredos do Cofre de chaves e carregar valores de configuração (exemplo basic)</span><span class="sxs-lookup"><span data-stu-id="3da70-126">Create key vault secrets and load configuration values (basic-sample)</span></span>

1. <span data-ttu-id="3da70-127">Criar um cofre de chaves e configurar o Azure Active Directory (Azure AD) para o aplicativo seguindo as orientações em [Introdução ao Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="3da70-127">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="3da70-128">Adicionar segredos no cofre de chaves usando o [módulo do PowerShell do AzureRM chave cofre](/powershell/module/azurerm.keyvault) disponível na [Galeria do PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), o [API REST do Azure Key Vault](/rest/api/keyvault/), ou o [Portal do azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="3da70-128">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="3da70-129">Segredos são criados como um *Manual* ou *certificado* segredos.</span><span class="sxs-lookup"><span data-stu-id="3da70-129">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="3da70-130">*Certificado* segredos são certificados para uso por aplicativos e serviços, mas não são suportados pelo provedor de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-130">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="3da70-131">Você deve usar o *Manual* opção para criar os segredos de par nome-valor para uso com o provedor de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-131">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="3da70-132">Segredos simples são criados como pares nome-valor.</span><span class="sxs-lookup"><span data-stu-id="3da70-132">Simple secrets are created as name-value pairs.</span></span> <span data-ttu-id="3da70-133">Nomes de segredos de Cofre de chaves do Azure são limitados a caracteres alfanuméricos e traços.</span><span class="sxs-lookup"><span data-stu-id="3da70-133">Azure Key Vault secret names are limited to alphanumeric characters and dashes.</span></span>
     * <span data-ttu-id="3da70-134">Usam valores hierárquicos (seções de configuração) `--` (dois traços) como um separador no exemplo.</span><span class="sxs-lookup"><span data-stu-id="3da70-134">Hierarchical values (configuration sections) use `--` (two dashes) as a separator in the sample.</span></span> <span data-ttu-id="3da70-135">Dois-pontos, que normalmente são usadas para delimitar uma seção de uma subchave no [configuração do ASP.NET Core](xref:fundamentals/configuration/index), não são permitidos em nomes de segredos.</span><span class="sxs-lookup"><span data-stu-id="3da70-135">Colons, which are normally used to delimit a section from a subkey in [ASP.NET Core configuration](xref:fundamentals/configuration/index), aren't allowed in secret names.</span></span> <span data-ttu-id="3da70-136">Portanto, os dois traços são usados e trocados para dois-pontos quando os segredos são carregados para a configuração do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-136">Therefore, two dashes are used and swapped for a colon when the secrets are loaded into the app's configuration.</span></span>
     * <span data-ttu-id="3da70-137">Criar duas *Manual* segredos com os seguintes pares de nome-valor.</span><span class="sxs-lookup"><span data-stu-id="3da70-137">Create two *Manual* secrets with the following name-value pairs.</span></span> <span data-ttu-id="3da70-138">O segredo do primeiro é um nome simples e um valor, e o segredo do segundo cria um valor do segredo com uma seção e a subchave no nome do segredo:</span><span class="sxs-lookup"><span data-stu-id="3da70-138">The first secret is a simple name and value, and the second secret creates a secret value with a section and subkey in the secret name:</span></span>
       * <span data-ttu-id="3da70-139">`SecretName`: `secret_value_1`</span><span class="sxs-lookup"><span data-stu-id="3da70-139">`SecretName`: `secret_value_1`</span></span>
       * <span data-ttu-id="3da70-140">`Section--SecretName`: `secret_value_2`</span><span class="sxs-lookup"><span data-stu-id="3da70-140">`Section--SecretName`: `secret_value_2`</span></span>
   * <span data-ttu-id="3da70-141">Registre o aplicativo de exemplo com o Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3da70-141">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="3da70-142">Autorize o aplicativo para acessar o Cofre de chaves.</span><span class="sxs-lookup"><span data-stu-id="3da70-142">Authorize the app to access the key vault.</span></span> <span data-ttu-id="3da70-143">Quando você usa o `Set-AzureRmKeyVaultAccessPolicy` cmdlet do PowerShell para autorizar o aplicativo para acessar o Cofre de chaves, forneça `List` e `Get` acesso aos segredos com `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="3da70-143">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="3da70-144">Atualizar o aplicativo *appSettings. JSON* arquivo com os valores de `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="3da70-144">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="3da70-145">Executar o aplicativo de exemplo que obtém seus valores de configuração de `IConfigurationRoot` com o mesmo nome que o nome do segredo.</span><span class="sxs-lookup"><span data-stu-id="3da70-145">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the secret name.</span></span>
   * <span data-ttu-id="3da70-146">Valores não são hierárquicos: O valor para `SecretName` é obtido com `config["SecretName"]`.</span><span class="sxs-lookup"><span data-stu-id="3da70-146">Non-hierarchical values: The value for `SecretName` is obtained with `config["SecretName"]`.</span></span>
   * <span data-ttu-id="3da70-147">Valores hierárquicos (seções): Use `:` notação (dois-pontos) ou o `GetSection` método de extensão.</span><span class="sxs-lookup"><span data-stu-id="3da70-147">Hierarchical values (sections): Use `:` (colon) notation or the `GetSection` extension method.</span></span> <span data-ttu-id="3da70-148">Use qualquer uma dessas abordagens para obter o valor de configuração:</span><span class="sxs-lookup"><span data-stu-id="3da70-148">Use either of these approaches to obtain the configuration value:</span></span>
     * `config["Section:SecretName"]`
     * `config.GetSection("Section")["SecretName"]`

<span data-ttu-id="3da70-149">Quando você executa o aplicativo, uma página da Web mostra os valores secretos carregados:</span><span class="sxs-lookup"><span data-stu-id="3da70-149">When you run the app, a webpage shows the loaded secret values:</span></span>

![Janela do navegador mostrando os valores secretos carregado via o provedor de configuração do Azure Key Vault](key-vault-configuration/_static/sample1.png)

## <a name="bind-an-array-to-a-class"></a><span data-ttu-id="3da70-151">Associar uma matriz a uma classe</span><span class="sxs-lookup"><span data-stu-id="3da70-151">Bind an array to a class</span></span>

<span data-ttu-id="3da70-152">O provedor é capaz de ler os valores de configuração em uma matriz para a associação para uma matriz POCO.</span><span class="sxs-lookup"><span data-stu-id="3da70-152">The provider is capable of reading configuration values into an array for binding to a POCO array.</span></span>

<span data-ttu-id="3da70-153">Durante a leitura de uma fonte de configuração que permite que as chaves conter dois-pontos (`:`) separadores, um segmento de chave numérico é usado para distinguir as chaves que compõem uma matriz (`:0:`, `:1:`,...</span><span class="sxs-lookup"><span data-stu-id="3da70-153">When reading from a configuration source that allows keys to contain colon (`:`) separators, a numeric key segment is used to distinguish the keys that make up an array (`:0:`, `:1:`, …</span></span> <span data-ttu-id="3da70-154">`:{n}:`).</span><span class="sxs-lookup"><span data-stu-id="3da70-154">`:{n}:`).</span></span> <span data-ttu-id="3da70-155">Para obter mais informações, consulte [configuração: associar uma matriz a uma classe](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span><span class="sxs-lookup"><span data-stu-id="3da70-155">For more information, see [Configuration: Bind an array to a class](xref:fundamentals/configuration/index#bind-an-array-to-a-class).</span></span>

<span data-ttu-id="3da70-156">Chaves do Azure Key Vault não podem usar dois-pontos como um separador.</span><span class="sxs-lookup"><span data-stu-id="3da70-156">Azure Key Vault keys can't use a colon as a separator.</span></span> <span data-ttu-id="3da70-157">A abordagem descrita neste tópico usa double traços (`--`) como separador de valores hierárquicos (seções).</span><span class="sxs-lookup"><span data-stu-id="3da70-157">The approach described in this topic uses double dashes (`--`) as a separator for hierarchical values (sections).</span></span> <span data-ttu-id="3da70-158">As chaves de matriz são armazenadas no Azure Key Vault com double traços e segmentos de chave numéricos (`--0--`, `--1--`,...</span><span class="sxs-lookup"><span data-stu-id="3da70-158">Array keys are stored in Azure Key Vault with double dashes and numeric key segments (`--0--`, `--1--`, …</span></span> <span data-ttu-id="3da70-159">`--{n}--`).</span><span class="sxs-lookup"><span data-stu-id="3da70-159">`--{n}--`).</span></span>

<span data-ttu-id="3da70-160">Examine o seguinte [Serilog](https://serilog.net/) fornecida por um arquivo JSON de configuração do provedor de log.</span><span class="sxs-lookup"><span data-stu-id="3da70-160">Examine the following [Serilog](https://serilog.net/) logging provider configuration provided by a JSON file.</span></span> <span data-ttu-id="3da70-161">Há dois objetos literais definidos na `WriteTo` matriz que refletem os dois Serilog *coletores*, que descrevem os destinos para saída de log:</span><span class="sxs-lookup"><span data-stu-id="3da70-161">There are two object literals defined in the `WriteTo` array that reflect two Serilog *sinks*, which describe destinations for logging output:</span></span>

```json
"Serilog": {
  "WriteTo": [
    {
      "Name": "AzureTableStorage",
      "Args": {
        "storageTableName": "logs",
        "connectionString": "DefaultEnd...ountKey=Eby8...GMGw=="
      }
    },
    {
      "Name": "AzureDocumentDB",
      "Args": {
        "endpointUrl": "https://contoso.documents.azure.com:443",
        "authorizationKey": "Eby8...GMGw=="
      }
    }
  ]
}
```

<span data-ttu-id="3da70-162">A configuração mostrada no arquivo JSON anterior é armazenada no Azure Key Vault usando o traço duplo (`--`) segmentos notação e numérico:</span><span class="sxs-lookup"><span data-stu-id="3da70-162">The configuration shown in the preceding JSON file is stored in Azure Key Vault using double dash (`--`) notation and numeric segments:</span></span>

| <span data-ttu-id="3da70-163">Chave</span><span class="sxs-lookup"><span data-stu-id="3da70-163">Key</span></span> | <span data-ttu-id="3da70-164">Valor</span><span class="sxs-lookup"><span data-stu-id="3da70-164">Value</span></span> |
| --- | ----- |
| `Serilog--WriteTo--0--Name` | `AzureTableStorage` |
| `Serilog--WriteTo--0--Args--storageTableName` | `logs` |
| `Serilog--WriteTo--0--Args--connectionString` | `DefaultEnd...ountKey=Eby8...GMGw==` |
| `Serilog--WriteTo--1--Name` | `AzureDocumentDB` |
| `Serilog--WriteTo--1--Args--endpointUrl` | `https://contoso.documents.azure.com:443` |
| `Serilog--WriteTo--1--Args--authorizationKey` | `Eby8...GMGw==` |

## <a name="create-prefixed-key-vault-secrets-and-load-configuration-values-key-name-prefix-sample"></a><span data-ttu-id="3da70-165">Segredos do Cofre de chaves prefixados de criar e carregar valores de configuração (chave-nome-prefixo-sample)</span><span class="sxs-lookup"><span data-stu-id="3da70-165">Create prefixed key vault secrets and load configuration values (key-name-prefix-sample)</span></span>

<span data-ttu-id="3da70-166">`AddAzureKeyVault` também fornece uma sobrecarga que aceita uma implementação de `IKeyVaultSecretManager`, que permite que você controle como os principais segredos do cofre são convertidas em chaves de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-166">`AddAzureKeyVault` also provides an overload that accepts an implementation of `IKeyVaultSecretManager`, which allows you to control how key vault secrets are converted into configuration keys.</span></span> <span data-ttu-id="3da70-167">Por exemplo, você pode implementar a interface para carregar os valores do segredo com base em um valor de prefixo que você fornece na inicialização do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-167">For example, you can implement the interface to load secret values based on a prefix value you provide at app startup.</span></span> <span data-ttu-id="3da70-168">Isso permite que você, por exemplo, para carregar segredos de acordo com a versão do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-168">This allows you, for example, to load secrets based on the version of the app.</span></span>

> [!WARNING]
> <span data-ttu-id="3da70-169">Não usar prefixos de segredos do Cofre de chaves para colocar segredos para vários aplicativos no mesmo Cofre de chaves ou para colocar segredos ambientais (por exemplo, *development* versus *produção* segredos) no mesmo cofre.</span><span class="sxs-lookup"><span data-stu-id="3da70-169">Don't use prefixes on key vault secrets to place secrets for multiple apps into the same key vault or to place environmental secrets (for example, *development* versus *production* secrets) into the same vault.</span></span> <span data-ttu-id="3da70-170">É recomendável que diferentes aplicativos e ambientes de desenvolvimento/produção usam cofres de chaves separados para isolar os ambientes de aplicativo para o nível mais alto de segurança.</span><span class="sxs-lookup"><span data-stu-id="3da70-170">We recommend that different apps and development/production environments use separate key vaults to isolate app environments for the highest level of security.</span></span>

<span data-ttu-id="3da70-171">Usando o segundo aplicativo de exemplo, criar um segredo no cofre de chaves para `5000-AppSecret` (períodos não são permitidos em nomes de segredos do Cofre de chaves) que representa um segredo do aplicativo para versão Version=5.0.0.0 do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-171">Using the second sample app, you create a secret in the key vault for `5000-AppSecret` (periods aren't allowed in key vault secret names) representing an app secret for version 5.0.0.0 of your app.</span></span> <span data-ttu-id="3da70-172">Para obter outra versão, 5.1.0.0, você cria um segredo para `5100-AppSecret`.</span><span class="sxs-lookup"><span data-stu-id="3da70-172">For another version, 5.1.0.0, you create a secret for `5100-AppSecret`.</span></span> <span data-ttu-id="3da70-173">Cada versão do aplicativo carrega seu próprio valor do segredo em sua configuração como `AppSecret`, remoção desativar a versão ele carrega o segredo.</span><span class="sxs-lookup"><span data-stu-id="3da70-173">Each app version loads its own secret value into its configuration as `AppSecret`, stripping off the version as it loads the secret.</span></span> <span data-ttu-id="3da70-174">A implementação da amostra é mostrada abaixo:</span><span class="sxs-lookup"><span data-stu-id="3da70-174">The sample's implementation is shown below:</span></span>

[!code-csharp[Configuration builder](key-vault-configuration/samples/key-name-prefix-sample/2.x/Program.cs?name=snippet1&highlight=18)]

[!code-csharp[PrefixKeyVaultSecretManager](key-vault-configuration/samples/key-name-prefix-sample/2.x/Startup.cs?name=snippet1)]

<span data-ttu-id="3da70-175">O `Load` método é chamado por um algoritmo de provedor que itera os segredos do cofre para encontrar aqueles que têm o prefixo de versão.</span><span class="sxs-lookup"><span data-stu-id="3da70-175">The `Load` method is called by a provider algorithm that iterates through the vault secrets to find the ones that have the version prefix.</span></span> <span data-ttu-id="3da70-176">Quando um prefixo de versão é encontrado com `Load`, o algoritmo usa o `GetKey` método para retornar o nome da configuração do nome do segredo.</span><span class="sxs-lookup"><span data-stu-id="3da70-176">When a version prefix is found with `Load`, the algorithm uses the `GetKey` method to return the configuration name of the secret name.</span></span> <span data-ttu-id="3da70-177">Ele ignora o prefixo de versão do nome do segredo e retorna o restante do nome do segredo para carregamento na configuração do aplicativo pares nome-valor.</span><span class="sxs-lookup"><span data-stu-id="3da70-177">It strips off the version prefix from the secret's name and returns the rest of the secret name for loading into the app's configuration name-value pairs.</span></span>

<span data-ttu-id="3da70-178">Ao implementar essa abordagem:</span><span class="sxs-lookup"><span data-stu-id="3da70-178">When you implement this approach:</span></span>

1. <span data-ttu-id="3da70-179">Os segredos do Cofre de chaves são carregados.</span><span class="sxs-lookup"><span data-stu-id="3da70-179">The key vault secrets are loaded.</span></span>
2. <span data-ttu-id="3da70-180">O segredo de cadeia de caracteres para `5000-AppSecret` é correspondido.</span><span class="sxs-lookup"><span data-stu-id="3da70-180">The string secret for `5000-AppSecret` is matched.</span></span>
3. <span data-ttu-id="3da70-181">A versão `5000` (com o traço) é removidos de deixar o nome da chave `AppSecret` carregar com o valor do segredo para a configuração do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-181">The version, `5000` (with the dash), is stripped off of the key name leaving `AppSecret` to load with the secret value into the app's configuration.</span></span>

> [!NOTE]
> <span data-ttu-id="3da70-182">Você também pode fornecer seus próprios `KeyVaultClient` implementação para `AddAzureKeyVault`.</span><span class="sxs-lookup"><span data-stu-id="3da70-182">You can also provide your own `KeyVaultClient` implementation to `AddAzureKeyVault`.</span></span> <span data-ttu-id="3da70-183">Fornecer um cliente personalizado permite que você compartilhe uma única instância do cliente entre o provedor de configuração e outras partes do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="3da70-183">Supplying a custom client allows you to share a single instance of the client between the configuration provider and other parts of your app.</span></span>

1. <span data-ttu-id="3da70-184">Criar um cofre de chaves e configurar o Azure Active Directory (Azure AD) para o aplicativo seguindo as orientações em [Introdução ao Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span><span class="sxs-lookup"><span data-stu-id="3da70-184">Create a key vault and set up Azure Active Directory (Azure AD) for the app following the guidance in [Get started with Azure Key Vault](https://azure.microsoft.com/documentation/articles/key-vault-get-started/).</span></span>
   * <span data-ttu-id="3da70-185">Adicionar segredos no cofre de chaves usando o [módulo do PowerShell do AzureRM chave cofre](/powershell/module/azurerm.keyvault) disponível na [Galeria do PowerShell](https://www.powershellgallery.com/packages/AzureRM.KeyVault), o [API REST do Azure Key Vault](/rest/api/keyvault/), ou o [Portal do azure](https://portal.azure.com/).</span><span class="sxs-lookup"><span data-stu-id="3da70-185">Add secrets to the key vault using the [AzureRM Key Vault PowerShell Module](/powershell/module/azurerm.keyvault) available from the [PowerShell Gallery](https://www.powershellgallery.com/packages/AzureRM.KeyVault), the [Azure Key Vault REST API](/rest/api/keyvault/), or the [Azure Portal](https://portal.azure.com/).</span></span> <span data-ttu-id="3da70-186">Segredos são criados como um *Manual* ou *certificado* segredos.</span><span class="sxs-lookup"><span data-stu-id="3da70-186">Secrets are created as either *Manual* or *Certificate* secrets.</span></span> <span data-ttu-id="3da70-187">*Certificado* segredos são certificados para uso por aplicativos e serviços, mas não são suportados pelo provedor de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-187">*Certificate* secrets are certificates for use by apps and services but are not supported by the configuration provider.</span></span> <span data-ttu-id="3da70-188">Você deve usar o *Manual* opção para criar os segredos de par nome-valor para uso com o provedor de configuração.</span><span class="sxs-lookup"><span data-stu-id="3da70-188">You should use the *Manual* option to create name-value pair secrets for use with the configuration provider.</span></span>
     * <span data-ttu-id="3da70-189">Usam valores hierárquicos (seções de configuração) `--` (dois traços) como um separador.</span><span class="sxs-lookup"><span data-stu-id="3da70-189">Hierarchical values (configuration sections) use `--` (two dashes) as a separator.</span></span>
     * <span data-ttu-id="3da70-190">Criar duas *Manual* segredos com os seguintes pares de nome-valor:</span><span class="sxs-lookup"><span data-stu-id="3da70-190">Create two *Manual* secrets with the following name-value pairs:</span></span>
       * <span data-ttu-id="3da70-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="3da70-191">`5000-AppSecret`: `5.0.0.0_secret_value`</span></span>
       * <span data-ttu-id="3da70-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span><span class="sxs-lookup"><span data-stu-id="3da70-192">`5100-AppSecret`: `5.1.0.0_secret_value`</span></span>
   * <span data-ttu-id="3da70-193">Registre o aplicativo de exemplo com o Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3da70-193">Register the sample app with Azure Active Directory.</span></span>
   * <span data-ttu-id="3da70-194">Autorize o aplicativo para acessar o Cofre de chaves.</span><span class="sxs-lookup"><span data-stu-id="3da70-194">Authorize the app to access the key vault.</span></span> <span data-ttu-id="3da70-195">Quando você usa o `Set-AzureRmKeyVaultAccessPolicy` cmdlet do PowerShell para autorizar o aplicativo para acessar o Cofre de chaves, forneça `List` e `Get` acesso aos segredos com `-PermissionsToSecrets list,get`.</span><span class="sxs-lookup"><span data-stu-id="3da70-195">When you use the `Set-AzureRmKeyVaultAccessPolicy` PowerShell cmdlet to authorize the app to access the key vault, provide `List` and `Get` access to secrets with `-PermissionsToSecrets list,get`.</span></span>

2. <span data-ttu-id="3da70-196">Atualizar o aplicativo *appSettings. JSON* arquivo com os valores de `Vault`, `ClientId`, e `ClientSecret`.</span><span class="sxs-lookup"><span data-stu-id="3da70-196">Update the app's *appsettings.json* file with the values of `Vault`, `ClientId`, and `ClientSecret`.</span></span>
3. <span data-ttu-id="3da70-197">Executar o aplicativo de exemplo que obtém seus valores de configuração de `IConfigurationRoot` com o mesmo nome que o nome do segredo prefixado.</span><span class="sxs-lookup"><span data-stu-id="3da70-197">Run the sample app, which obtains its configuration values from `IConfigurationRoot` with the same name as the prefixed secret name.</span></span> <span data-ttu-id="3da70-198">Neste exemplo, o prefixo é a versão do aplicativo, que você forneceu para o `PrefixKeyVaultSecretManager` quando você adicionou o provedor de configuração do Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="3da70-198">In this sample, the prefix is the app's version, which you provided to the `PrefixKeyVaultSecretManager` when you added the Azure Key Vault configuration provider.</span></span> <span data-ttu-id="3da70-199">O valor para `AppSecret` é obtido com `config["AppSecret"]`.</span><span class="sxs-lookup"><span data-stu-id="3da70-199">The value for `AppSecret` is obtained with `config["AppSecret"]`.</span></span> <span data-ttu-id="3da70-200">A página da Web gerada pelo aplicativo mostra o valor carregado:</span><span class="sxs-lookup"><span data-stu-id="3da70-200">The webpage generated by the app shows the loaded value:</span></span>

   ![Janela do navegador mostrando um valor do segredo carregados por meio do provedor de configuração da chave cofre do Azure, quando a versão do aplicativo é Version=5.0.0.0](key-vault-configuration/_static/sample2-1.png)

4. <span data-ttu-id="3da70-202">Alterar a versão do assembly no arquivo de projeto de aplicativo `5.0.0.0` para `5.1.0.0` e execute o aplicativo novamente.</span><span class="sxs-lookup"><span data-stu-id="3da70-202">Change the version of the app assembly in the project file from `5.0.0.0` to `5.1.0.0` and run the app again.</span></span> <span data-ttu-id="3da70-203">Esse tempo, o valor do segredo retornado é `5.1.0.0_secret_value`.</span><span class="sxs-lookup"><span data-stu-id="3da70-203">This time, the secret value returned is `5.1.0.0_secret_value`.</span></span> <span data-ttu-id="3da70-204">A página da Web gerada pelo aplicativo mostra o valor carregado:</span><span class="sxs-lookup"><span data-stu-id="3da70-204">The webpage generated by the app shows the loaded value:</span></span>

   ![Janela do navegador mostrando um valor do segredo carregados por meio do provedor de configuração da chave cofre do Azure, quando a versão do aplicativo é 5.1.0.0](key-vault-configuration/_static/sample2-2.png)

## <a name="control-access-to-the-clientsecret"></a><span data-ttu-id="3da70-206">Controlar o acesso para o segredo do cliente</span><span class="sxs-lookup"><span data-stu-id="3da70-206">Control access to the ClientSecret</span></span>

<span data-ttu-id="3da70-207">Use o [ferramenta Secret Manager](xref:security/app-secrets) para manter o `ClientSecret` fora de sua árvore de origem do projeto.</span><span class="sxs-lookup"><span data-stu-id="3da70-207">Use the [Secret Manager tool](xref:security/app-secrets) to maintain the `ClientSecret` outside of your project source tree.</span></span> <span data-ttu-id="3da70-208">Com o Secret Manager, você associar a um projeto específico de segredos do aplicativo e compartilhá-los em vários projetos.</span><span class="sxs-lookup"><span data-stu-id="3da70-208">With Secret Manager, you associate app secrets with a specific project and share them across multiple projects.</span></span>

<span data-ttu-id="3da70-209">Ao desenvolver um aplicativo do .NET Framework em um ambiente que dá suporte a certificados, você pode autenticar para o Azure Key Vault com um certificado X.509.</span><span class="sxs-lookup"><span data-stu-id="3da70-209">When developing a .NET Framework app in an environment that supports certificates, you can authenticate to Azure Key Vault with an X.509 certificate.</span></span> <span data-ttu-id="3da70-210">Chave privada do certificado X.509 é gerenciado pelo sistema operacional.</span><span class="sxs-lookup"><span data-stu-id="3da70-210">The X.509 certificate's private key is managed by the OS.</span></span> <span data-ttu-id="3da70-211">Para obter mais informações, consulte [autenticar com um certificado em vez de um segredo do cliente](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span><span class="sxs-lookup"><span data-stu-id="3da70-211">For more information, see [Authenticate with a Certificate instead of a Client Secret](/azure/key-vault/key-vault-use-from-web-application#authenticate-with-a-certificate-instead-of-a-client-secret).</span></span> <span data-ttu-id="3da70-212">Use o `AddAzureKeyVault` sobrecarga que aceita um `X509Certificate2` (`_env` no exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="3da70-212">Use the `AddAzureKeyVault` overload that accepts an `X509Certificate2` (`_env` in the following example :</span></span>

```csharp
var builtConfig = config.Build();

var store = new X509Store(StoreLocation.CurrentUser);
store.Open(OpenFlags.ReadOnly);
var cert = store.Certificates
    .Find(X509FindType.FindByThumbprint, 
        config["CertificateThumbprint"], false);

config.AddAzureKeyVault(
    builtConfig["Vault"],
    builtConfig["ClientId"],
    cert.OfType<X509Certificate2>().Single(),
    new EnvironmentSecretManager(context.HostingEnvironment.ApplicationName));

store.Close();
```

## <a name="reload-secrets"></a><span data-ttu-id="3da70-213">Recarregue os segredos</span><span class="sxs-lookup"><span data-stu-id="3da70-213">Reload secrets</span></span>

<span data-ttu-id="3da70-214">Segredos são armazenados em cache até `IConfigurationRoot.Reload()` é chamado.</span><span class="sxs-lookup"><span data-stu-id="3da70-214">Secrets are cached until `IConfigurationRoot.Reload()` is called.</span></span> <span data-ttu-id="3da70-215">Expirado, desabilitado, e atualizados segredos no cofre de chaves não serão respeitados pelo aplicativo até `Reload` é executado.</span><span class="sxs-lookup"><span data-stu-id="3da70-215">Expired, disabled, and updated secrets in the key vault are not respected by the app until `Reload` is executed.</span></span>

```csharp
Configuration.Reload();
```

## <a name="disabled-and-expired-secrets"></a><span data-ttu-id="3da70-216">Segredos desabilitados e expirados</span><span class="sxs-lookup"><span data-stu-id="3da70-216">Disabled and expired secrets</span></span>

<span data-ttu-id="3da70-217">Segredos desabilitados e expirados lançar um `KeyVaultClientException`.</span><span class="sxs-lookup"><span data-stu-id="3da70-217">Disabled and expired secrets throw a `KeyVaultClientException`.</span></span> <span data-ttu-id="3da70-218">Para impedir que seu aplicativo acione, substitua o seu aplicativo ou atualizar o segredo desabilitado/expirado.</span><span class="sxs-lookup"><span data-stu-id="3da70-218">To prevent your app from throwing, replace your app or update the disabled/expired secret.</span></span>

## <a name="troubleshoot"></a><span data-ttu-id="3da70-219">Solução de problemas</span><span class="sxs-lookup"><span data-stu-id="3da70-219">Troubleshoot</span></span>

<span data-ttu-id="3da70-220">Quando o aplicativo falha ao carregar a configuração usando o provedor, uma mensagem de erro é gravada para o [infra-estrutura de log do ASP.NET Core](xref:fundamentals/logging/index).</span><span class="sxs-lookup"><span data-stu-id="3da70-220">When the app fails to load configuration using the provider, an error message is written to the [ASP.NET Core Logging infrastructure](xref:fundamentals/logging/index).</span></span> <span data-ttu-id="3da70-221">As seguintes condições impedirá que a configuração de carregamento:</span><span class="sxs-lookup"><span data-stu-id="3da70-221">The following conditions will prevent configuration from loading:</span></span>

* <span data-ttu-id="3da70-222">O aplicativo não está configurado corretamente no Azure Active Directory.</span><span class="sxs-lookup"><span data-stu-id="3da70-222">The app isn't configured correctly in Azure Active Directory.</span></span>
* <span data-ttu-id="3da70-223">O Cofre de chaves não existe no Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="3da70-223">The key vault doesn't exist in Azure Key Vault.</span></span>
* <span data-ttu-id="3da70-224">O aplicativo não está autorizado a acessar o Cofre de chaves.</span><span class="sxs-lookup"><span data-stu-id="3da70-224">The app isn't authorized to access the key vault.</span></span>
* <span data-ttu-id="3da70-225">A política de acesso não inclui `Get` e `List` permissões.</span><span class="sxs-lookup"><span data-stu-id="3da70-225">The access policy doesn't include `Get` and `List` permissions.</span></span>
* <span data-ttu-id="3da70-226">No cofre de chaves, os dados de configuração (par nome-valor) estão nomeados incorretamente, ausente, desabilitado ou expirado.</span><span class="sxs-lookup"><span data-stu-id="3da70-226">In the key vault, the configuration data (name-value pair) is incorrectly named, missing, disabled, or expired.</span></span>
* <span data-ttu-id="3da70-227">O aplicativo tem o nome do cofre da chave incorreta (`Vault`), Id do aplicativo do Azure AD (`ClientId`), ou a chave do Azure AD (`ClientSecret`).</span><span class="sxs-lookup"><span data-stu-id="3da70-227">The app has the wrong key vault name (`Vault`), Azure AD App Id (`ClientId`), or Azure AD Key (`ClientSecret`).</span></span>
* <span data-ttu-id="3da70-228">A chave do AD do Azure (`ClientSecret`) expirou.</span><span class="sxs-lookup"><span data-stu-id="3da70-228">The Azure AD Key (`ClientSecret`) is expired.</span></span>
* <span data-ttu-id="3da70-229">A chave de configuração (nome) está incorreta no aplicativo para o valor que você está tentando carregar.</span><span class="sxs-lookup"><span data-stu-id="3da70-229">The configuration key (name) is incorrect in the app for the value you're trying to load.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="3da70-230">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="3da70-230">Additional resources</span></span>

* <xref:fundamentals/configuration/index>
* [<span data-ttu-id="3da70-231">Microsoft Azure: Cofre de chaves</span><span class="sxs-lookup"><span data-stu-id="3da70-231">Microsoft Azure: Key Vault</span></span>](https://azure.microsoft.com/services/key-vault/)
* [<span data-ttu-id="3da70-232">Microsoft Azure: Documentação de Cofre de chaves</span><span class="sxs-lookup"><span data-stu-id="3da70-232">Microsoft Azure: Key Vault Documentation</span></span>](/azure/key-vault/)
* [<span data-ttu-id="3da70-233">Como gerar e transferir protegida por HSM chaves para o Azure Key Vault</span><span class="sxs-lookup"><span data-stu-id="3da70-233">How to generate and transfer HSM-protected keys for Azure Key Vault</span></span>](/azure/key-vault/key-vault-hsm-protected-keys)
* [<span data-ttu-id="3da70-234">Classe KeyVaultClient</span><span class="sxs-lookup"><span data-stu-id="3da70-234">KeyVaultClient Class</span></span>](/dotnet/api/microsoft.azure.keyvault.keyvaultclient)
