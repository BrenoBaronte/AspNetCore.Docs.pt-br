---
title: Gerenciamento e tempo de vida de chaves da proteção de dados no ASP.NET Core
author: rick-anderson
description: Saiba mais sobre o gerenciamento de chaves de proteção de dados e o tempo de vida em ASP.NET Core.
ms.author: riande
ms.date: 10/14/2016
no-loc:
- ':::no-loc(appsettings.json):::'
- ':::no-loc(ASP.NET Core Identity):::'
- ':::no-loc(cookie):::'
- ':::no-loc(Cookie):::'
- ':::no-loc(Blazor):::'
- ':::no-loc(Blazor Server):::'
- ':::no-loc(Blazor WebAssembly):::'
- ':::no-loc(Identity):::'
- ":::no-loc(Let's Encrypt):::"
- ':::no-loc(Razor):::'
- ':::no-loc(SignalR):::'
uid: security/data-protection/configuration/default-settings
ms.openlocfilehash: 1303c5c2c993f1d20383457666aebfa2a583e938
ms.sourcegitcommit: ca34c1ac578e7d3daa0febf1810ba5fc74f60bbf
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 10/30/2020
ms.locfileid: "93053001"
---
# <a name="data-protection-key-management-and-lifetime-in-aspnet-core"></a><span data-ttu-id="0b6cd-103">Gerenciamento e tempo de vida de chaves da proteção de dados no ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="0b6cd-103">Data Protection key management and lifetime in ASP.NET Core</span></span>

<span data-ttu-id="0b6cd-104">De [Rick Anderson](https://twitter.com/RickAndMSFT)</span><span class="sxs-lookup"><span data-stu-id="0b6cd-104">By [Rick Anderson](https://twitter.com/RickAndMSFT)</span></span>

## <a name="key-management"></a><span data-ttu-id="0b6cd-105">Gerenciamento de chaves</span><span class="sxs-lookup"><span data-stu-id="0b6cd-105">Key management</span></span>

<span data-ttu-id="0b6cd-106">O aplicativo tenta detectar seu ambiente operacional e manipular a configuração da chave por conta própria.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-106">The app attempts to detect its operational environment and handle key configuration on its own.</span></span>

1. <span data-ttu-id="0b6cd-107">Se o aplicativo estiver hospedado em [aplicativos do Azure](https://azure.microsoft.com/services/app-service/), as chaves serão mantidas na pasta *%Home%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="0b6cd-107">If the app is hosted in [Azure Apps](https://azure.microsoft.com/services/app-service/), keys are persisted to the *%HOME%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="0b6cd-108">Essa pasta é apoiada pelo repositório de rede e é sincronizada em todos os computadores que hospedam o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-108">This folder is backed by network storage and is synchronized across all machines hosting the app.</span></span>
   * <span data-ttu-id="0b6cd-109">As chaves não são protegidas em repouso.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-109">Keys aren't protected at rest.</span></span>
   * <span data-ttu-id="0b6cd-110">A pasta *dataprotection-Keys* fornece o anel de chave para todas as instâncias de um aplicativo em um único slot de implantação.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-110">The *DataProtection-Keys* folder supplies the key ring to all instances of an app in a single deployment slot.</span></span>
   * <span data-ttu-id="0b6cd-111">Slots de implantação separados, como de preparo e produção, não compartilham um anel de chave.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-111">Separate deployment slots, such as Staging and Production, don't share a key ring.</span></span> <span data-ttu-id="0b6cd-112">Quando você alterna entre os slots de implantação, por exemplo, trocando preparo para produção ou usando testes A/B, qualquer aplicativo usando a proteção de dados não será capaz de descriptografar dados armazenados usando o anel de chave dentro do slot anterior.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-112">When you swap between deployment slots, for example swapping Staging to Production or using A/B testing, any app using Data Protection won't be able to decrypt stored data using the key ring inside the previous slot.</span></span> <span data-ttu-id="0b6cd-113">Isso leva aos usuários que estão sendo desconectados de um aplicativo que usa a autenticação de ASP.NET Core padrão :::no-loc(cookie)::: , pois usa a proteção de dados para proteger seus :::no-loc(cookie)::: s.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-113">This leads to users being logged out of an app that uses the standard ASP.NET Core :::no-loc(cookie)::: authentication, as it uses Data Protection to protect its :::no-loc(cookie):::s.</span></span> <span data-ttu-id="0b6cd-114">Se você quiser anéis de chave independentes de slot, use um provedor de anel de chave externa, como o armazenamento de BLOBs do Azure, Azure Key Vault, um repositório SQL ou cache Redis.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-114">If you desire slot-independent key rings, use an external key ring provider, such as Azure Blob Storage, Azure Key Vault, a SQL store, or Redis cache.</span></span>

1. <span data-ttu-id="0b6cd-115">Se o perfil do usuário estiver disponível, as chaves serão mantidas na pasta *%LocalAppData%\ASP.NET\DataProtection-Keys* .</span><span class="sxs-lookup"><span data-stu-id="0b6cd-115">If the user profile is available, keys are persisted to the *%LOCALAPPDATA%\ASP.NET\DataProtection-Keys* folder.</span></span> <span data-ttu-id="0b6cd-116">Se o sistema operacional for Windows, as chaves serão criptografadas em repouso usando DPAPI.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-116">If the operating system is Windows, the keys are encrypted at rest using DPAPI.</span></span>

   <span data-ttu-id="0b6cd-117">O [atributo setProfileEnvironment](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) do pool de aplicativos também deve ser habilitado.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-117">The app pool's [setProfileEnvironment attribute](/iis/configuration/system.applicationhost/applicationpools/add/processmodel#configuration) must also be enabled.</span></span> <span data-ttu-id="0b6cd-118">O valor padrão de `setProfileEnvironment` é `true`.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-118">The default value of `setProfileEnvironment` is `true`.</span></span> <span data-ttu-id="0b6cd-119">Em alguns cenários (por exemplo, um SO Windows), `setProfileEnvironment` é definido como `false`.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-119">In some scenarios (for example, Windows OS), `setProfileEnvironment` is set to `false`.</span></span> <span data-ttu-id="0b6cd-120">Se as chaves não estiverem armazenadas no diretório do perfil do usuário como esperado:</span><span class="sxs-lookup"><span data-stu-id="0b6cd-120">If keys aren't stored in the user profile directory as expected:</span></span>

   1. <span data-ttu-id="0b6cd-121">navegue até a pasta *%windir%/system32/inetsrv/config* .</span><span class="sxs-lookup"><span data-stu-id="0b6cd-121">Navigate to the *%windir%/system32/inetsrv/config* folder.</span></span>
   1. <span data-ttu-id="0b6cd-122">Abra o arquivo *applicationHost.config* .</span><span class="sxs-lookup"><span data-stu-id="0b6cd-122">Open the *applicationHost.config* file.</span></span>
   1. <span data-ttu-id="0b6cd-123">Localize o elemento `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>`.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-123">Locate the `<system.applicationHost><applicationPools><applicationPoolDefaults><processModel>` element.</span></span>
   1. <span data-ttu-id="0b6cd-124">Confirme se o atributo `setProfileEnvironment` não está presente, que tem como padrão o valor `true`, ou defina explicitamente o valor do atributo como `true`.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-124">Confirm that the `setProfileEnvironment` attribute isn't present, which defaults the value to `true`, or explicitly set the attribute's value to `true`.</span></span>

1. <span data-ttu-id="0b6cd-125">Se o aplicativo estiver hospedado no IIS, as chaves serão mantidas no registro HKLM em uma chave de registro especial que é ACLed apenas para a conta de processo de trabalho.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-125">If the app is hosted in IIS, keys are persisted to the HKLM registry in a special registry key that's ACLed only to the worker process account.</span></span> <span data-ttu-id="0b6cd-126">As chaves são criptografadas em repouso usando a DPAPI.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-126">Keys are encrypted at rest using DPAPI.</span></span>

1. <span data-ttu-id="0b6cd-127">Se nenhuma dessas condições corresponder, as chaves não serão mantidas fora do processo atual.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-127">If none of these conditions match, keys aren't persisted outside of the current process.</span></span> <span data-ttu-id="0b6cd-128">Quando o processo é desligado, todas as chaves geradas são perdidas.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-128">When the process shuts down, all generated keys are lost.</span></span>

<span data-ttu-id="0b6cd-129">O desenvolvedor está sempre no controle total e pode substituir como e onde as chaves são armazenadas.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-129">The developer is always in full control and can override how and where keys are stored.</span></span> <span data-ttu-id="0b6cd-130">As três primeiras opções acima devem fornecer bons padrões para a maioria dos aplicativos semelhantes a como as **\<machineKey>** rotinas de geração automática de ASP.net funcionaram no passado.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-130">The first three options above should provide good defaults for most apps similar to how the ASP.NET **\<machineKey>** auto-generation routines worked in the past.</span></span> <span data-ttu-id="0b6cd-131">A opção final, fallback é o único cenário que exige que o desenvolvedor especifique a [configuração](xref:security/data-protection/configuration/overview) antecipada se quiser a persistência da chave, mas esse fallback só ocorre em situações raras.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-131">The final, fallback option is the only scenario that requires the developer to specify [configuration](xref:security/data-protection/configuration/overview) upfront if they want key persistence, but this fallback only occurs in rare situations.</span></span>

<span data-ttu-id="0b6cd-132">Ao hospedar em um contêiner do Docker, as chaves devem ser mantidas em uma pasta que seja um volume do Docker (um volume compartilhado ou um volume montado pelo host que persiste além do tempo de vida do contêiner) ou em um provedor externo, como [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) ou [Redis](https://redis.io/).</span><span class="sxs-lookup"><span data-stu-id="0b6cd-132">When hosting in a Docker container, keys should be persisted in a folder that's a Docker volume (a shared volume or a host-mounted volume that persists beyond the container's lifetime) or in an external provider, such as [Azure Key Vault](https://azure.microsoft.com/services/key-vault/) or [Redis](https://redis.io/).</span></span> <span data-ttu-id="0b6cd-133">Um provedor externo também será útil em cenários de web farm se os aplicativos não puderem acessar um volume de rede compartilhada (consulte [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) para obter mais informações).</span><span class="sxs-lookup"><span data-stu-id="0b6cd-133">An external provider is also useful in web farm scenarios if apps can't access a shared network volume (see [PersistKeysToFileSystem](xref:security/data-protection/configuration/overview#persistkeystofilesystem) for more information).</span></span>

> [!WARNING]
> <span data-ttu-id="0b6cd-134">Se o desenvolvedor substituir as regras descritas acima e apontar o sistema de proteção de dados em um repositório de chaves específico, a criptografia automática de chaves em repouso será desabilitada.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-134">If the developer overrides the rules outlined above and points the Data Protection system at a specific key repository, automatic encryption of keys at rest is disabled.</span></span> <span data-ttu-id="0b6cd-135">A proteção em repouso pode ser habilitada novamente por meio da [configuração](xref:security/data-protection/configuration/overview).</span><span class="sxs-lookup"><span data-stu-id="0b6cd-135">At-rest protection can be re-enabled via [configuration](xref:security/data-protection/configuration/overview).</span></span>

## <a name="key-lifetime"></a><span data-ttu-id="0b6cd-136">Tempo de vida da chave</span><span class="sxs-lookup"><span data-stu-id="0b6cd-136">Key lifetime</span></span>

<span data-ttu-id="0b6cd-137">As chaves têm um tempo de vida de 90 dias por padrão.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-137">Keys have a 90-day lifetime by default.</span></span> <span data-ttu-id="0b6cd-138">Quando uma chave expira, o aplicativo gera automaticamente uma nova chave e define a nova chave como a chave ativa.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-138">When a key expires, the app automatically generates a new key and sets the new key as the active key.</span></span> <span data-ttu-id="0b6cd-139">Desde que as chaves desativadas permaneçam no sistema, seu aplicativo poderá descriptografar os dados protegidos com eles.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-139">As long as retired keys remain on the system, your app can decrypt any data protected with them.</span></span> <span data-ttu-id="0b6cd-140">Consulte [Gerenciamento de chaves](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-140">See [key management](xref:security/data-protection/implementation/key-management#key-expiration-and-rolling) for more information.</span></span>

## <a name="default-algorithms"></a><span data-ttu-id="0b6cd-141">Algoritmos padrão</span><span class="sxs-lookup"><span data-stu-id="0b6cd-141">Default algorithms</span></span>

<span data-ttu-id="0b6cd-142">O algoritmo de proteção de carga padrão usado é o AES-256-CBC para confidencialidade e HMACSHA256 para autenticidade.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-142">The default payload protection algorithm used is AES-256-CBC for confidentiality and HMACSHA256 for authenticity.</span></span> <span data-ttu-id="0b6cd-143">Uma chave mestra de 512 bits, alterada a cada 90 dias, é usada para derivar as duas subchaves usadas para esses algoritmos em uma base por carga.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-143">A 512-bit master key, changed every 90 days, is used to derive the two sub-keys used for these algorithms on a per-payload basis.</span></span> <span data-ttu-id="0b6cd-144">Consulte [derivação de subchave](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="0b6cd-144">See [subkey derivation](xref:security/data-protection/implementation/subkeyderivation#additional-authenticated-data-and-subkey-derivation) for more information.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="0b6cd-145">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="0b6cd-145">Additional resources</span></span>

* <xref:security/data-protection/extensibility/key-management>
* <xref:host-and-deploy/web-farm>
