---
title: Lógica do controlador de teste no ASP.NET Core
author: ardalis
description: Saiba como testar a lógica do controlador no ASP.NET Core com o Moq e o xUnit.
ms.author: riande
ms.date: 10/14/2016
uid: mvc/controllers/testing
ms.openlocfilehash: d0b2a25d00187c088671be147844aa892f824c6e
ms.sourcegitcommit: 64c2ca86fff445944b155635918126165ee0f8aa
ms.translationtype: HT
ms.contentlocale: pt-BR
ms.lasthandoff: 08/18/2018
ms.locfileid: "41751685"
---
# <a name="test-controller-logic-in-aspnet-core"></a><span data-ttu-id="89db9-103">Lógica do controlador de teste no ASP.NET Core</span><span class="sxs-lookup"><span data-stu-id="89db9-103">Test controller logic in ASP.NET Core</span></span>

<span data-ttu-id="89db9-104">Por [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="89db9-104">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="89db9-105">Os controladores são uma parte central de qualquer aplicativo ASP.NET Core MVC.</span><span class="sxs-lookup"><span data-stu-id="89db9-105">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="89db9-106">Assim, você deve estar confiante de que eles se comportam conforme o esperado para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="89db9-106">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="89db9-107">Testes automatizados podem fornecer essa confiança e podem detectar erros antes que eles atinjam a produção.</span><span class="sxs-lookup"><span data-stu-id="89db9-107">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="89db9-108">É importante evitar colocar responsabilidades desnecessárias dentro dos controladores e garantir que o teste tenha como foco somente as responsabilidades do controlador.</span><span class="sxs-lookup"><span data-stu-id="89db9-108">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="89db9-109">A lógica do controlador deve ser mínima e não estar voltada para a lógica de negócios ou interesses de infraestrutura (por exemplo, acesso a dados).</span><span class="sxs-lookup"><span data-stu-id="89db9-109">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="89db9-110">Teste a lógica do controlador, não a estrutura.</span><span class="sxs-lookup"><span data-stu-id="89db9-110">Test controller logic, not the framework.</span></span> <span data-ttu-id="89db9-111">Teste como o controlador *se comporta* de acordo com as entradas válidas ou inválidas.</span><span class="sxs-lookup"><span data-stu-id="89db9-111">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="89db9-112">Teste as respostas do controlador de acordo com o resultado da operação de negócios executada por ele.</span><span class="sxs-lookup"><span data-stu-id="89db9-112">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="89db9-113">Responsabilidades típicas do controlador:</span><span class="sxs-lookup"><span data-stu-id="89db9-113">Typical controller responsibilities:</span></span>

* <span data-ttu-id="89db9-114">Verificar `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="89db9-114">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="89db9-115">Retornar uma resposta de erro se `ModelState` for inválido.</span><span class="sxs-lookup"><span data-stu-id="89db9-115">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="89db9-116">Recuperar uma entidade de negócios da persistência.</span><span class="sxs-lookup"><span data-stu-id="89db9-116">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="89db9-117">Executar uma ação na entidade de negócios.</span><span class="sxs-lookup"><span data-stu-id="89db9-117">Perform an action on the business entity.</span></span>
* <span data-ttu-id="89db9-118">Salvar a entidade de negócios para persistência.</span><span class="sxs-lookup"><span data-stu-id="89db9-118">Save the business entity to persistence.</span></span>
* <span data-ttu-id="89db9-119">Retornar um `IActionResult` apropriado.</span><span class="sxs-lookup"><span data-stu-id="89db9-119">Return an appropriate `IActionResult`.</span></span>

<span data-ttu-id="89db9-120">[Exibir ou baixar código de exemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([como baixar](xref:tutorials/index#how-to-download-a-sample))</span><span class="sxs-lookup"><span data-stu-id="89db9-120">[View or download sample code](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample) ([how to download](xref:tutorials/index#how-to-download-a-sample))</span></span>

## <a name="unit-tests-of-controller-logic"></a><span data-ttu-id="89db9-121">Testes de unidade da lógica do controlador</span><span class="sxs-lookup"><span data-stu-id="89db9-121">Unit tests of controller logic</span></span>

<span data-ttu-id="89db9-122">Os [testes de unidade](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) envolvem o teste de uma parte de um aplicativo isoladamente em relação à sua infraestrutura e às suas dependências.</span><span class="sxs-lookup"><span data-stu-id="89db9-122">[Unit tests](/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involve testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="89db9-123">Ao executar o teste de unidade na lógica do controlador, somente o conteúdo de uma única ação é testada, não o comportamento de suas dependências ou da própria estrutura.</span><span class="sxs-lookup"><span data-stu-id="89db9-123">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="89db9-124">Ao executar o teste de unidade nas ações do controlador, concentre-se apenas em seu comportamento.</span><span class="sxs-lookup"><span data-stu-id="89db9-124">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="89db9-125">Um teste de unidade do controlador evita itens como [filtros](xref:mvc/controllers/filters), [roteamento](xref:fundamentals/routing) ou [associação de modelos](xref:mvc/models/model-binding).</span><span class="sxs-lookup"><span data-stu-id="89db9-125">A controller unit test avoids things like [filters](xref:mvc/controllers/filters), [routing](xref:fundamentals/routing), or [model binding](xref:mvc/models/model-binding).</span></span> <span data-ttu-id="89db9-126">Ao se concentrarem no teste de apenas uma coisa, os testes de unidade geralmente são simples de serem escritos e rápidos de serem executados.</span><span class="sxs-lookup"><span data-stu-id="89db9-126">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="89db9-127">Um conjunto bem escrito de testes de unidade pode ser executado com frequência sem muita sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="89db9-127">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="89db9-128">No entanto, os testes de unidade não detectam problemas na interação entre os componentes, que é a finalidade dos [testes de integração](xref:test/integration-tests).</span><span class="sxs-lookup"><span data-stu-id="89db9-128">However, unit tests don't detect issues in the interaction between components, which is the purpose of [integration tests](xref:test/integration-tests).</span></span>

<span data-ttu-id="89db9-129">Se você estiver escrevendo filtros personalizados e rotas, execute o teste de unidade neles de forma isolada, mas não como parte dos testes em uma ação do controlador específica.</span><span class="sxs-lookup"><span data-stu-id="89db9-129">If you're writing custom filters and routes, you should unit test them in isolation, not as part of your tests on a particular controller action.</span></span>

> [!TIP]
> <span data-ttu-id="89db9-130">[Crie e execute testes de unidade com o Visual Studio](/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="89db9-130">[Create and run unit tests with Visual Studio](/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="89db9-131">Para demonstrar o teste de unidade, examine o controlador a seguir.</span><span class="sxs-lookup"><span data-stu-id="89db9-131">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="89db9-132">Ele exibe uma lista de sessões de debate e permite que novas sessões de debate sejam criadas com um POST:</span><span class="sxs-lookup"><span data-stu-id="89db9-132">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="89db9-133">O controlador está seguindo o [princípio de dependências explícitas](http://deviq.com/explicit-dependencies-principle/), esperando receber da injeção de dependência uma instância de `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="89db9-133">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="89db9-134">Isso facilita muito o teste com o uso de uma estrutura de objeto fictício, como o [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="89db9-134">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="89db9-135">O método `HTTP GET Index` não tem nenhum loop ou branch e chama apenas um método.</span><span class="sxs-lookup"><span data-stu-id="89db9-135">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="89db9-136">Para testar este método `Index`, precisamos verificar se um `ViewResult` for retornado, com um `ViewModel` do método `List` do repositório.</span><span class="sxs-lookup"><span data-stu-id="89db9-136">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="89db9-137">O método `HomeController` `HTTP POST Index` (mostrado acima) deve verificar se:</span><span class="sxs-lookup"><span data-stu-id="89db9-137">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="89db9-138">O método de ação retorna um `ViewResult` de Solicitação Inválida com os dados apropriados quando `ModelState.IsValid` é `false`.</span><span class="sxs-lookup"><span data-stu-id="89db9-138">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`.</span></span>

* <span data-ttu-id="89db9-139">O método `Add` no repositório é chamado e um `RedirectToActionResult` é retornado com os argumentos corretos quando `ModelState.IsValid` é verdadeiro.</span><span class="sxs-lookup"><span data-stu-id="89db9-139">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="89db9-140">O estado de modelo inválido pode ser testado com a adição de erros usando `AddModelError`, conforme mostrado no primeiro teste abaixo.</span><span class="sxs-lookup"><span data-stu-id="89db9-140">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="89db9-141">O primeiro teste confirma que quando `ModelState` não é válido, o mesmo `ViewResult` é retornado como para uma solicitação `GET`.</span><span class="sxs-lookup"><span data-stu-id="89db9-141">The first test confirms when `ModelState` isn't valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="89db9-142">Observe que o teste não tenta passar um modelo inválido.</span><span class="sxs-lookup"><span data-stu-id="89db9-142">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="89db9-143">Isso não funcionará de qualquer forma, pois a associação de modelos não está em execução (embora um [teste de integração](xref:test/integration-tests) use a associação de modelos de exercícios).</span><span class="sxs-lookup"><span data-stu-id="89db9-143">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:test/integration-tests) would use exercise model binding).</span></span> <span data-ttu-id="89db9-144">Nesse caso, a associação de modelos não está sendo testada.</span><span class="sxs-lookup"><span data-stu-id="89db9-144">In this case, model binding isn't being tested.</span></span> <span data-ttu-id="89db9-145">Esses testes de unidade estão testando apenas o que o código faz no método de ação.</span><span class="sxs-lookup"><span data-stu-id="89db9-145">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="89db9-146">O segundo teste verifica que quando `ModelState` é válido, um novo `BrainstormSession` é adicionado (por meio do repositório) e o método retorna um `RedirectToActionResult` com as propriedades esperadas.</span><span class="sxs-lookup"><span data-stu-id="89db9-146">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="89db9-147">Chamadas fictícias que não são chamadas são normalmente ignoradas, mas a chamada a `Verifiable` no final da chamada de instalação permite que ele seja verificada no teste.</span><span class="sxs-lookup"><span data-stu-id="89db9-147">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="89db9-148">Isso é feito com a chamada a `mockRepo.Verify`, que não será aprovado no teste se o método esperado não tiver sido chamado.</span><span class="sxs-lookup"><span data-stu-id="89db9-148">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method wasn't called.</span></span>

> [!NOTE]
> <span data-ttu-id="89db9-149">A biblioteca do Moq usada nesta amostra facilita a combinação de simulações verificáveis ou "estritas" com simulações não verificáveis (também chamadas de simulações "flexíveis" ou stubs).</span><span class="sxs-lookup"><span data-stu-id="89db9-149">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="89db9-150">Saiba mais sobre como [personalizar o comportamento de Simulação com o Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="89db9-150">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="89db9-151">Outro controlador no aplicativo exibe informações relacionadas a uma sessão de debate específica.</span><span class="sxs-lookup"><span data-stu-id="89db9-151">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="89db9-152">Ele inclui uma lógica para lidar com valores de ID inválidos:</span><span class="sxs-lookup"><span data-stu-id="89db9-152">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="89db9-153">A ação do controlador tem três casos a serem testados, um para cada instrução `return`:</span><span class="sxs-lookup"><span data-stu-id="89db9-153">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="89db9-154">O aplicativo expõe a funcionalidade como uma API Web (uma lista de ideias associadas a uma sessão de debate e um método para adicionar novas ideias a uma sessão):</span><span class="sxs-lookup"><span data-stu-id="89db9-154">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="89db9-155">O método `ForSession` retorna uma lista de tipos `IdeaDTO`.</span><span class="sxs-lookup"><span data-stu-id="89db9-155">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="89db9-156">Evite retornar as entidades de domínio de negócios diretamente por meio de chamadas à API, pois, com frequência, elas incluem mais dados do que o cliente de API exige e acoplam desnecessariamente o modelo de domínio interno do aplicativo à API exposta externamente.</span><span class="sxs-lookup"><span data-stu-id="89db9-156">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="89db9-157">O mapeamento entre entidades de domínio e os tipos que você retornará de forma eletrônica pode ser feito manualmente (usando um LINQ `Select`, conforme mostrado aqui) ou uma biblioteca como a [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span><span class="sxs-lookup"><span data-stu-id="89db9-157">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper).</span></span>

<span data-ttu-id="89db9-158">Os testes de unidade para os métodos de API `Create` e `ForSession`:</span><span class="sxs-lookup"><span data-stu-id="89db9-158">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="89db9-159">Conforme mencionado anteriormente, para testar o comportamento do método quando `ModelState` é inválido, adicione um erro de modelo ao controlador como parte do teste.</span><span class="sxs-lookup"><span data-stu-id="89db9-159">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="89db9-160">Não tente testar a validação ou a associação de modelos nos testes de unidade – teste apenas o comportamento do método de ação quando houver um valor `ModelState` específico.</span><span class="sxs-lookup"><span data-stu-id="89db9-160">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="89db9-161">O segundo teste depende do repositório retornar nulo. Portanto, o repositório fictício é configurado para retornar nulo.</span><span class="sxs-lookup"><span data-stu-id="89db9-161">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="89db9-162">Não é necessário criar um banco de dados de teste (em memória ou de outra forma) e construir uma consulta que retornará esse resultado – isso pode ser feito em uma única instrução, conforme mostrado.</span><span class="sxs-lookup"><span data-stu-id="89db9-162">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="89db9-163">O último teste verifica se o método `Update` do repositório é chamado.</span><span class="sxs-lookup"><span data-stu-id="89db9-163">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="89db9-164">Como fizemos anteriormente, a simulação é chamada com `Verifiable` e, em seguida, o método `Verify` do repositório fictício é chamado para confirmar se o método verificável foi executado.</span><span class="sxs-lookup"><span data-stu-id="89db9-164">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="89db9-165">Não é responsabilidade do teste de unidade garantir que o método `Update` salva os dados; isso pode ser feito com um teste de integração.</span><span class="sxs-lookup"><span data-stu-id="89db9-165">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="additional-resources"></a><span data-ttu-id="89db9-166">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="89db9-166">Additional resources</span></span>

* <xref:test/integration-tests>
