---
title: Migrar do ASP.NET Core 2.0 para 2.1
author: rick-anderson
description: Este artigo aborda os conceitos básicos da migração de um aplicativo ASP.NET 2.0 de núcleo para 2.1.
ms.author: riande
ms.date: 05/30/2018
uid: migration/20_21
ms.openlocfilehash: 8d27d916b04c12c17c0054de8392408f751b6990
ms.sourcegitcommit: 1faf2525902236428dae6a59e375519bafd5d6d7
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 06/28/2018
ms.locfileid: "37089887"
---
# <a name="migrate-from-aspnet-core-20-to-21"></a>Migrar do ASP.NET Core 2.0 para 2.1

Por [Rick Anderson](https://twitter.com/RickAndMSFT)

Consulte [o que há de novo no ASP.NET Core 2.1](xref:aspnetcore-2.1) para obter uma visão geral dos novos recursos no ASP.NET Core 2.1.

Este artigo:

* Aborda os conceitos básicos da migração de um aplicativo ASP.NET 2.0 de núcleo para 2.1.
* Fornece uma visão geral das alterações para os modelos do aplicativo web ASP.NET Core.

É uma maneira rápida de obter uma visão geral das alterações em 2.1:

* Crie um aplicativo web do ASP.NET Core 2.0 chamado WebApp1.
* Confirme o WebApp1 em um sistema de controle de origem.
* Excluir WebApp1 e criar um aplicativo web do ASP.NET Core 2.1 chamado WebApp1 no mesmo local.
* Revise as alterações na versão 2.1.

Este artigo fornece uma visão geral sobre a migração para o ASP.NET Core 2.1. Ele não contém uma lista completa de todas as alterações necessárias para migrar para a versão 2.1. Alguns projetos podem exigir mais etapas dependendo da opções selecionadas quando o projeto foi criado e as modificações feitas ao projeto.

## <a name="update-the-project-file-to-use-21-versions"></a>Atualize o arquivo de projeto para usar 2.1 versões

Atualização de *. csproj* arquivo de projeto:

* Alterar `<TargetFramework>netcoreapp2.0</TargetFramework>` para a versão 2.1, que é `<TargetFramework>netcoreapp2.1</TargetFramework>`.
* Substituir a versão especificada "Microsoft.AspNetCore.All" referência de pacote com a referência de pacote automáticas sem versão "Microsoft.AspNetCore.App". Talvez seja necessário adicionar dependências que foram removidas da "Microsoft.AspNetCore.All". Consulte [Migrando do Microsoft.AspNetCore.All para Microsoft.AspNetCore.App](xref:fundamentals/metapackage#migrate) e [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app). Se você estiver direcionando o .NET Framework:

  * Adicione referências de pacote individuais em vez de uma referência de pacote meta.
  * Atualize cada referência de pacote para 2.1.
* Remova todas as referências a `<DotNetCliToolReference>` elementos para pacotes "Microsoft.AspNetCore", "Microsoft.VisualStudio" e "Microsoft.EntityFrameworkCore". Essas ferramentas foram substituídas por ferramentas global.

A marcação a seguir mostra o modelo gerado 2.0 *. csproj* arquivo de projeto:

[!code-xml[Main](20_21/sample/WebApp20.csproj)]

A marcação a seguir mostra o modelo gerado 2.1 *. csproj* arquivo de projeto:

[!code-xml[Main](20_21/sample/WebApp21.csproj)]

## <a name="rules-for-projects-targeting-the-shared-runtime"></a>Regras para projetos que visam o tempo de execução compartilhado

ASP.NET Core inclui os tempos de execução compartilhados seguintes:

* [Microsoft.AspNetCore.App](xref:fundamentals/metapackage-app)
* [Microsoft.AspNetCore.All](xref:fundamentals/metapackage)

Regras para projetos que visam o tempo de execução compartilhado:

* Projetos referenciando o `Microsoft.AspNetCore.All` ou `Microsoft.AspNetCore.App` pacotes Configure o SDK do projeto para `Microsoft.NET.Sdk.Web` na parte superior do arquivo de projeto (`<Project Sdk="Microsoft.NET.Sdk.Web">`).
* Projetos referenciando pacotes ou projetos que fazem referência a transitivamente `Microsoft.AspNetCore.All` ou `Microsoft.AspNetCore.App`:
  * Configure o SDK do projeto para `Microsoft.NET.Sdk.Web` na parte superior do arquivo de projeto (`<Project Sdk="Microsoft.NET.Sdk.Web">`).
  * Deve referenciar o mesmo pacote de tempo de execução compartilhado. Se fizer referência a LibraryA `Microsoft.AspNetCore.App`, também devem fazer referência a qualquer projetos referenciando LibraryA `Microsoft.AspNetCore.App`.
* Executável projetos (projetos que contêm aplicativos que são iniciados com `dotnet run` ou aplicativos que executam o e projetos para aplicativos de teste) não deve especificar uma versão para `Microsoft.AspNetCore.App`. O SDK Especifica a versão implicitamente por meio `<PackageReference Include="Microsoft.AspNetCore.App" />`.
* Referenciado projetos (projetos que não são o ponto de entrada e as referências de projeto `Microsoft.AspNetCore.All` ou `Microsoft.AspNetCore.App`) deve especificar uma versão do pacote.

## <a name="changes-to-take-advantage-of-the-new-code-based-idioms-that-are-recommended-in-aspnet-core-21"></a>Alterações para aproveitar os novos idiomas baseada em código recomendados ASP.NET Core 2.1

### <a name="changes-to-main"></a>Alterações no principal

As imagens a seguir mostram as alterações feitas para o modelo gerado *Program.cs* arquivo.

![diferenças de versão antiga](20_21/_static/main20.png)

A imagem anterior mostra a versão 2.0 com as exclusões em vermelho.

A imagem a seguir mostra o código 2.1. O código em verde substituído a versão 2.0:

![diferenças de versão nova](20_21/_static/main21.png)

O código a seguir mostra a versão 2.1 do *Program.cs*:

[!code-csharp[Main](20_21/sample/Program.cs?name=snippet)]

O novo `Main` substitui a chamada para `BuildWebHost` com [CreateWebHostBuilder](/dotnet/api/microsoft.aspnetcore.mvc.testing.webapplicationfactory-1.createwebhostbuilder). [IWebHostBuilder](/dotnet/api/microsoft.aspnetcore.hosting.iwebhostbuilder) foi adicionado para suportar um novo [infraestrutura de teste de integração](xref:test/integration-tests).

### <a name="changes-to-startup"></a>Alterações de inicialização

O código a seguir mostra as alterações ao código 2.1 modelo gerado. Todas as alterações são adicionadas recentemente código, exceto que `UseBrowserLink` foi removido:

[!code-csharp[Main](20_21/sample/Startup.cs?highlight=3,4,21-26,30,42,45,47)]

As alterações de código anteriores são detalhadas no:

* [Suporte a GDPR no ASP.NET Core](xref:security/gdpr) para `CookiePolicyOptions` e `UseCookiePolicy`.
* [Protocolo de segurança de transporte estrito de HTTP (HSTS)](xref:security/enforcing-ssl#http-strict-transport-security-protocol-hsts) para `UseHsts`.
* [Exigir HTTPS](xref:security/enforcing-ssl#require-https) para `UseHttpsRedirection`.
* [SetCompatibilityVersion](xref:fundamentals/startup#setcompatibilityversion) para `SetCompatibilityVersion(CompatibilityVersion.Version_2_1)`.

## <a name="changes-to-authentication-code"></a>Alterações no código de autenticação

ASP.NET Core 2.1 fornece [a identidade do ASP.NET Core](xref:security/authentication/identity) como um [biblioteca de classes do Razor](xref:razor-pages/ui-class) (RCL).

O padrão 2.1 identidade de interface do usuário atualmente não fornece novos recursos significativos em relação à versão 2.0. A substituição da identidade com o pacote RCL é opcional. As vantagens para substituir o modelo gerado identidade código com a versão RCL incluem:

* Número de arquivos é movido fora da sua árvore de origem.
* Qualquer correções de bugs ou novos recursos de identidade são incluídos no [Microsoft.AspNetCore.App metapackage](xref:fundamentals/metapackage-app). Você obtém a identidade atualizada automaticamente quando `Microsoft.AspNetCore.App` é atualizada.

Se você fez não trivial alterações para o modelo de código de identidade gerado:

* As vantagens anteriores não podem justificar a conversão para o a versão RCL.
* Você pode manter seu código de identidade do ASP.NET Core 2.0, há suporte total.

Identidade 2.1 expõe pontos de extremidade com o `Identity` área. Por exemplo, a tabela a seguir mostra exemplos de pontos de extremidade de identidade que são alteradas do 2.0 para 2.1:

| 2.0 URL         | 2.1 URL |
| --------------- | ------------ |
| / / Logon da conta  | Identidade/logon/conta |
| / Conta/Logout | Identidade/logoff/conta |
| / Conta/gerenciar | / Identidade/conta/gerenciar |

Interface de usuário de identidade com a necessidade de biblioteca de identidade 2.1 para levar em conta as URLs de identidade os aplicativos que têm código usando a identidade e substitua 2.0 têm `/Identity` acrescentado para os URIs de segmento. Uma maneira de lidar com os novos pontos de extremidade de identidade é configurar a redirecionamentos, por exemplo, do `/Account/Login` para `/Identity/Account/Login`.

### <a name="update-identity-to-version-21"></a>Identidade de atualização à versão 2.1

As seguintes opções estão disponíveis para atualizar a identidade para 2.1.

* Use o código de identidade da interface do usuário 2.0 sem alterações. Usando o código de identidade da interface do usuário 2.0 tem suporte total. Isso é uma boa abordagem quando significativo alterações foram feitas para o código de identidade gerado.
* Excluir o código existente do 2.0 de identidade e [Scaffold identidade](xref:security/authentication/scaffold-identity) em seu projeto. Seu projeto usará o [a identidade do ASP.NET Core](xref:security/authentication/identity) [biblioteca de classes do Razor](xref:razor-pages/ui-class). Você pode gerar o código e a interface do usuário para qualquer código de interface de usuário da identidade que você modificou. Aplica as alterações de código para o código de interface do usuário recentemente scaffolding.
* Excluir o código existente do 2.0 de identidade e [Scaffold identidade](xref:security/authentication/scaffold-identity) em seu projeto com a opção de **substituir todos os arquivos**.

### <a name="replace-identity-20-ui-with-the-identity-21-razor-class-library"></a>Substituir identidade 2.0 interface do usuário com a biblioteca de classes do Razor identidade 2.1

Esta seção descreve as etapas para substituir o código de identidade do ASP.NET Core 2.0 modelo gerado com o [a identidade do ASP.NET Core](xref:security/authentication/identity) [biblioteca de classes do Razor](xref:razor-pages/ui-class). As etapas a seguir são para um projeto de páginas Razor, mas a abordagem para um projeto MVC é semelhante.

* Verifique se o [arquivo de projeto é atualizado para usar 2.1 versões](#update-the-project-file-to-use-21-versions)
* Exclua as seguintes pastas e todos os arquivos neles:
  * *Controladores*
  * *Páginas/conta /*
  * *Extensões*
* Compile o projeto.
* [Scaffold identidade](xref:security/authentication/scaffold-identity) em seu projeto:
  * Selecione os projetos saindo *cshtml* arquivo.
  * Selecione o **+** ícone no lado direito do **classe de contexto de dados**. Aceite o nome padrão.
  * Selecione **adicionar** para criar uma nova classe de contexto de dados. Criar um novo contexto de dados é necessária para Scaffold. Você pode remover o novo contexto de dados na próxima seção.

### <a name="update-after-scaffolding-identity"></a>Atualizar após a estrutura de identidade

* Excluir o scaffolder de identidade gerado `IdentityDbContext` derivaram classe o *identidade/áreas/dados/* pasta.
* Excluir *Areas/Identity/IdentityHostingStartup.cs*
* Atualização de *loginpartial. cshtml* arquivo:
  * Mover *Pages/_LoginPartial.cshtml* para *Pages/Shared/_LoginPartial.cshtml*
  * Adicionar `asp-area="Identity"` os links de formulário e âncora.
  * Atualização de `<form />` elemento `    <form asp-area="Identity" asp-page="/Account/Logout" asp-route-returnUrl="@Url.Page("/Index", new { area = "" })" method="post" id="logoutForm" class="navbar-right">`

  O código a seguir mostra a atualização *loginpartial. cshtml* arquivo:

  [!code-cshtml[Main](20_21/sample/_LoginPartial.cshtml?highlight=8,11,22,23)]

Atualização `ConfigureServices` com o código a seguir:

[!code-csharp[Main](20_21/sample/Startup2.cs?name=snippet)]

## <a name="changes-to-razor-pages-projects-razor-files"></a>Altera a páginas Razor projetos arquivos do Razor

### <a name="the-layout-file"></a>O arquivo de layout

* Mover *Pages/_Layout.cshtml* para *Pages/Shared/_Layout.cshtml*
* O *cshtml* arquivo tem as seguintes alterações:

  * `<partial name="_CookieConsentPartial" />` é adicionado. Para obter mais informações, veja [Suporte RGPD no ASP.NET Core](xref:security/gdpr).
  * alterações de jQuery do 2.2.0 para 3.3.1

### <a name="validationscriptspartialcshtml"></a>_ValidationScriptsPartial.cshtml

* *Pages/_ValidationScriptsPartial.cshtml* move para *Pages/Shared/_ValidationScriptsPartial.cshtml*
* *jQuery.Validate/1.14.0* alterações *jquery.validate/1.17.0*

### <a name="new-files"></a>Novos arquivos

Os seguintes arquivos são adicionados:

* *Privacy.cshtml*
* *Privacy.cshtml.cs*

Consulte [GDPR suporte no ASP.NET Core](xref:security/gdpr) para obter informações sobre os arquivos acima.

## <a name="changes-to-mvc-projects-razor-files"></a>Alterações nos arquivos de Razor projetos MVC

### <a name="the-layout-file"></a>O arquivo de layout

O *cshtml* arquivo tem as seguintes alterações:

* `<partial name="_CookieConsentPartial" />` é adicionado.
* alterações de jQuery do 2.2.0 para 3.3.1

### <a name="validationscriptspartialcshtml"></a>_ValidationScriptsPartial.cshtml

*jQuery.Validate/1.14.0* alterações *jquery.validate/1.17.0*

### <a name="new-files-and-action-methods"></a>Novos arquivos e os métodos de ação

A seguir é adicionados:

* *Views/Home/Privacy.cshtml*
* O `Privacy` método de ação é adicionado ao controlador de Home.

Consulte [GDPR suporte no ASP.NET Core](xref:security/gdpr) para obter informações sobre os arquivos acima.

## <a name="additional-changes"></a>Alterações adicionais

* [SetCompatibilityVersion](xref:fundamentals/startup#setcompatibilityversion)
* [Configuração de transporte](xref:fundamentals/servers/kestrel#transport-configuration)
