---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
title: "Usando o Entity Framework 4.0 e o controle ObjectDataSource, parte 2: adicionar uma camada de lógica de negócios e testes de unidade | Microsoft Docs"
author: tdykstra
description: "Esta série de tutorial se baseia no aplicativo web Contoso Universidade que é criado pelo guia de Introdução com a série de tutoriais do Entity Framework 4.0. I..."
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: efb0e677-10b8-48dc-93d3-9ba3902dd807
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests
msc.type: authoredcontent
ms.openlocfilehash: df37acd8901b457f7887afe767d42d53e45e4815
ms.sourcegitcommit: 060879fcf3f73d2366b5c811986f8695fff65db8
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 01/24/2018
---
<a name="using-the-entity-framework-40-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests"></a><span data-ttu-id="a4e59-104">Usando o Entity Framework 4.0 e o controle ObjectDataSource, parte 2: adicionar uma camada de lógica de negócios e testes de unidade</span><span class="sxs-lookup"><span data-stu-id="a4e59-104">Using the Entity Framework 4.0 and the ObjectDataSource Control, Part 2: Adding a Business Logic Layer and Unit Tests</span></span>
====================
<span data-ttu-id="a4e59-105">Por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="a4e59-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="a4e59-106">Esta série de tutoriais se baseia no aplicativo da web Contoso Universidade que é criado pelo [guia de Introdução com o Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) série de tutoriais.</span><span class="sxs-lookup"><span data-stu-id="a4e59-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="a4e59-107">Se você não concluir os tutoriais anteriores, como um ponto de partida para este tutorial você pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que você pode ter sido criado.</span><span class="sxs-lookup"><span data-stu-id="a4e59-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="a4e59-108">Você também pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) que é criado pela série tutorial completo.</span><span class="sxs-lookup"><span data-stu-id="a4e59-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="a4e59-109">Se você tiver dúvidas sobre os tutoriais, você poderá postá-los para o [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="a4e59-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="a4e59-110">No tutorial anterior, você criou um aplicativo web de n camadas usando o Entity Framework e o `ObjectDataSource` controle.</span><span class="sxs-lookup"><span data-stu-id="a4e59-110">In the previous tutorial you created an n-tier web application using the Entity Framework and the `ObjectDataSource` control.</span></span> <span data-ttu-id="a4e59-111">Este tutorial mostra como adicionar lógica de negócios, mantendo a camada de lógica de negócios (BLL) e a camada de acesso a dados (DAL) separados, e ele mostra como criar testes de unidade automatizados para BLL.</span><span class="sxs-lookup"><span data-stu-id="a4e59-111">This tutorial shows how to add business logic while keeping the business-logic layer (BLL) and the data-access layer (DAL) separate, and it shows how to create automated unit tests for the BLL.</span></span>

<span data-ttu-id="a4e59-112">Neste tutorial, você concluirá as seguintes tarefas:</span><span class="sxs-lookup"><span data-stu-id="a4e59-112">In this tutorial you'll complete the following tasks:</span></span>

- <span data-ttu-id="a4e59-113">Crie uma interface de repositório que declara os métodos de acesso a dados que você precisa.</span><span class="sxs-lookup"><span data-stu-id="a4e59-113">Create a repository interface that declares the data-access methods you need.</span></span>
- <span data-ttu-id="a4e59-114">Implemente a interface do repositório na classe do repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-114">Implement the repository interface in the repository class.</span></span>
- <span data-ttu-id="a4e59-115">Crie uma classe de lógica de negócios que chama a classe de repositório para executar funções de acesso a dados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-115">Create a business-logic class that calls the repository class to perform data-access functions.</span></span>
- <span data-ttu-id="a4e59-116">Conecte-se a `ObjectDataSource` controle à classe em vez de lógica de negócios para a classe do repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-116">Connect the `ObjectDataSource` control to the business-logic class instead of to the repository class.</span></span>
- <span data-ttu-id="a4e59-117">Crie um projeto de teste de unidade e uma classe de repositório que usa coleções na memória para seu repositório de dados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-117">Create a unit-test project and a repository class that uses in-memory collections for its data store.</span></span>
- <span data-ttu-id="a4e59-118">Crie um teste de unidade lógica de negócios que você deseja adicionar à classe de lógica de negócios, em seguida, execute o teste e vê-lo a falhar.</span><span class="sxs-lookup"><span data-stu-id="a4e59-118">Create a unit test for business logic that you want to add to the business-logic class, then run the test and see it fail.</span></span>
- <span data-ttu-id="a4e59-119">Implementar a lógica de negócios na classe de lógica de negócios, em seguida, execute novamente a unidade de teste e vê-lo a passar.</span><span class="sxs-lookup"><span data-stu-id="a4e59-119">Implement the business logic in the business-logic class, then re-run the unit test and see it pass.</span></span>

<span data-ttu-id="a4e59-120">Você trabalhará com o *Departments.aspx* e *DepartmentsAdd.aspx* páginas que você criou no tutorial anterior.</span><span class="sxs-lookup"><span data-stu-id="a4e59-120">You'll work with the *Departments.aspx* and *DepartmentsAdd.aspx* pages that you created in the previous tutorial.</span></span>

## <a name="creating-a-repository-interface"></a><span data-ttu-id="a4e59-121">Criando uma Interface do repositório</span><span class="sxs-lookup"><span data-stu-id="a4e59-121">Creating a Repository Interface</span></span>

<span data-ttu-id="a4e59-122">Você começará criando a interface do repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-122">You'll begin by creating the repository interface.</span></span>

<span data-ttu-id="a4e59-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-123">[![Image08](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image2.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image1.png)</span></span>

<span data-ttu-id="a4e59-124">No *DAL* pasta, crie um novo arquivo de classe, nomeie-o *ISchoolRepository.cs*e substitua o código existente pelo seguinte código:</span><span class="sxs-lookup"><span data-stu-id="a4e59-124">In the *DAL* folder, create a new class file, name it *ISchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample1.cs)]

<span data-ttu-id="a4e59-125">A interface define um método para cada o CRUD (criar, ler, atualizar e excluir) métodos que você criou na classe do repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-125">The interface defines one method for each of the CRUD (create, read, update, delete) methods that you created in the repository class.</span></span>

<span data-ttu-id="a4e59-126">No `SchoolRepository` classe em *SchoolRepository.cs*, indicar que esta classe implementa o `ISchoolRepository` interface:</span><span class="sxs-lookup"><span data-stu-id="a4e59-126">In the `SchoolRepository` class in *SchoolRepository.cs*, indicate that this class implements the `ISchoolRepository` interface:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample2.cs)]

## <a name="creating-a-business-logic-class"></a><span data-ttu-id="a4e59-127">Criando uma classe de lógica de negócios</span><span class="sxs-lookup"><span data-stu-id="a4e59-127">Creating a Business-Logic Class</span></span>

<span data-ttu-id="a4e59-128">Em seguida, você criará a classe de lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="a4e59-128">Next, you'll create the business-logic class.</span></span> <span data-ttu-id="a4e59-129">Fazer isso para que você possa adicionar lógica de negócios que será executada pelo `ObjectDataSource` controlar, embora você não fará isso ainda.</span><span class="sxs-lookup"><span data-stu-id="a4e59-129">You do this so that you can add business logic that will be executed by the `ObjectDataSource` control, although you will not do that yet.</span></span> <span data-ttu-id="a4e59-130">Agora, a nova classe de lógica de negócios executará somente as operações CRUD mesmo que o repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-130">For now, the new business-logic class will only perform the same CRUD operations that the repository does.</span></span>

<span data-ttu-id="a4e59-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-131">[![Image09](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image4.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image3.png)</span></span>

<span data-ttu-id="a4e59-132">Crie uma nova pasta e nomeie- *BLL*.</span><span class="sxs-lookup"><span data-stu-id="a4e59-132">Create a new folder and name it *BLL*.</span></span> <span data-ttu-id="a4e59-133">(Em um aplicativo do mundo real, a camada de lógica de negócios normalmente seria implementada como uma biblioteca de classe — um projeto separado, mas para simplificar este tutorial, classes BLL serão mantidos em uma pasta de projeto.)</span><span class="sxs-lookup"><span data-stu-id="a4e59-133">(In a real-world application, the business-logic layer would typically be implemented as a class library — a separate project — but to keep this tutorial simple, BLL classes will be kept in a project folder.)</span></span>

<span data-ttu-id="a4e59-134">No *BLL* pasta, crie um novo arquivo de classe, nomeie-o *SchoolBL.cs*e substitua o código existente pelo seguinte código:</span><span class="sxs-lookup"><span data-stu-id="a4e59-134">In the *BLL* folder, create a new class file, name it *SchoolBL.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample3.cs)]

<span data-ttu-id="a4e59-135">Esse código cria os mesmos métodos CRUD visto anteriormente na classe de repositório, mas em vez de acessar diretamente os métodos Entity Framework, ele chama o repositório métodos da classe.</span><span class="sxs-lookup"><span data-stu-id="a4e59-135">This code creates the same CRUD methods you saw earlier in the repository class, but instead of accessing the Entity Framework methods directly, it calls the repository class methods.</span></span>

<span data-ttu-id="a4e59-136">A variável de classe que contém uma referência para a classe de repositório é definida como um tipo de interface e o código que cria uma instância da classe do repositório está contido em dois construtores.</span><span class="sxs-lookup"><span data-stu-id="a4e59-136">The class variable that holds a reference to the repository class is defined as an interface type, and the code that instantiates the repository class is contained in two constructors.</span></span> <span data-ttu-id="a4e59-137">O construtor sem parâmetro será usado pelo `ObjectDataSource` controle.</span><span class="sxs-lookup"><span data-stu-id="a4e59-137">The parameterless constructor will be used by the `ObjectDataSource` control.</span></span> <span data-ttu-id="a4e59-138">Ele cria uma instância do `SchoolRepository` classe que você criou anteriormente.</span><span class="sxs-lookup"><span data-stu-id="a4e59-138">It creates an instance of the `SchoolRepository` class that you created earlier.</span></span> <span data-ttu-id="a4e59-139">O outro construtor permite que qualquer código que cria uma instância da classe de lógica de negócios para transmitir qualquer objeto que implementa a interface do repositório.</span><span class="sxs-lookup"><span data-stu-id="a4e59-139">The other constructor allows whatever code that instantiates the business-logic class to pass in any object that implements the repository interface.</span></span>

<span data-ttu-id="a4e59-140">Os métodos CRUD que chamam a classe do repositório e dois construtores tornam possível usar a classe de lógica de negócios com qualquer repositório de dados de back-end que você escolher.</span><span class="sxs-lookup"><span data-stu-id="a4e59-140">The CRUD methods that call the repository class and the two constructors make it possible to use the business-logic class with whatever back-end data store you choose.</span></span> <span data-ttu-id="a4e59-141">A classe de lógica de negócios não precisa estar ciente de como a classe que está chamando persiste os dados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-141">The business-logic class does not need to be aware of how the class that it's calling persists the data.</span></span> <span data-ttu-id="a4e59-142">(Isso é geralmente chamado *ignorância de persistência*.) Isso facilita o teste de unidade, como a classe de lógica de negócios podem se conectar a uma implementação de repositório que use algo como simples como na memória `List` coleções para armazenar dados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-142">(This is often called *persistence ignorance*.) This facilitates unit testing, because you can connect the business-logic class to a repository implementation that uses something as simple as in-memory `List` collections to store data.</span></span>

> [!NOTE]
> <span data-ttu-id="a4e59-143">Tecnicamente, os objetos de entidade são ainda não persistência desconhecem, porque eles estiverem instanciados a partir de classes que herdam o Entity Framework `EntityObject` classe.</span><span class="sxs-lookup"><span data-stu-id="a4e59-143">Technically, the entity objects are still not persistence-ignorant, because they're instantiated from classes that inherit from the Entity Framework's `EntityObject` class.</span></span> <span data-ttu-id="a4e59-144">Para ignorância de persistência concluída, você pode usar *simples objetos CLR antigos*, ou *POCOs*, em vez de objetos que herdam o `EntityObject` classe.</span><span class="sxs-lookup"><span data-stu-id="a4e59-144">For complete persistence ignorance, you can use *plain old CLR objects*, or *POCOs*, in place of objects that inherit from the `EntityObject` class.</span></span> <span data-ttu-id="a4e59-145">Usar POCOs está além do escopo deste tutorial.</span><span class="sxs-lookup"><span data-stu-id="a4e59-145">Using POCOs is beyond the scope of this tutorial.</span></span> <span data-ttu-id="a4e59-146">Para obter mais informações, consulte [capacidade de teste e o Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) no site do MSDN.)</span><span class="sxs-lookup"><span data-stu-id="a4e59-146">For more information, see [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx) on the MSDN website.)</span></span>


<span data-ttu-id="a4e59-147">Agora você pode se conectar a `ObjectDataSource` controles para a lógica de negócios de classe em vez de para o repositório e verificar se tudo está funcionando como antes.</span><span class="sxs-lookup"><span data-stu-id="a4e59-147">Now you can connect the `ObjectDataSource` controls to the business-logic class instead of to the repository and verify that everything works as it did before.</span></span>

<span data-ttu-id="a4e59-148">Em *Departments.aspx* e *DepartmentsAdd.aspx*, alterar cada ocorrência de `TypeName="ContosoUniversity.DAL.SchoolRepository"` para `TypeName="ContosoUniversity.BLL.SchoolBL`".</span><span class="sxs-lookup"><span data-stu-id="a4e59-148">In *Departments.aspx* and *DepartmentsAdd.aspx*, change each occurrence of `TypeName="ContosoUniversity.DAL.SchoolRepository"` to `TypeName="ContosoUniversity.BLL.SchoolBL`".</span></span> <span data-ttu-id="a4e59-149">(Há quatro instâncias em todas.)</span><span class="sxs-lookup"><span data-stu-id="a4e59-149">(There are four instances in all.)</span></span>

<span data-ttu-id="a4e59-150">Execute o *Departments.aspx* e *DepartmentsAdd.aspx* páginas para verificar se eles ainda funcionam como antes.</span><span class="sxs-lookup"><span data-stu-id="a4e59-150">Run the *Departments.aspx* and *DepartmentsAdd.aspx* pages to verify that they still work as they did before.</span></span>

<span data-ttu-id="a4e59-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-151">[![Image01](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image6.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image5.png)</span></span>

<span data-ttu-id="a4e59-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-152">[![Image02](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image8.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image7.png)</span></span>

## <a name="creating-a-unit-test-project-and-repository-implementation"></a><span data-ttu-id="a4e59-153">Criando um projeto de teste de unidade e a implementação do repositório</span><span class="sxs-lookup"><span data-stu-id="a4e59-153">Creating a Unit-Test Project and Repository Implementation</span></span>

<span data-ttu-id="a4e59-154">Adicionar um novo projeto à solução usando o **projeto de teste** modelo e nomeie-o `ContosoUniversity.Tests`.</span><span class="sxs-lookup"><span data-stu-id="a4e59-154">Add a new project to the solution using the **Test Project** template, and name it `ContosoUniversity.Tests`.</span></span>

<span data-ttu-id="a4e59-155">No projeto de teste, adicione uma referência a `System.Data.Entity` e adicione uma referência de projeto para o `ContosoUniversity` projeto.</span><span class="sxs-lookup"><span data-stu-id="a4e59-155">In the test project, add a reference to `System.Data.Entity` and add a project reference to the `ContosoUniversity` project.</span></span>

<span data-ttu-id="a4e59-156">Agora você pode criar a classe de repositório que você usará com testes de unidade.</span><span class="sxs-lookup"><span data-stu-id="a4e59-156">You can now create the repository class that you'll use with unit tests.</span></span> <span data-ttu-id="a4e59-157">O repositório de dados para este repositório será dentro da classe.</span><span class="sxs-lookup"><span data-stu-id="a4e59-157">The data store for this repository will be within the class.</span></span>

<span data-ttu-id="a4e59-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-158">[![Image12](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image10.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image9.png)</span></span>

<span data-ttu-id="a4e59-159">No projeto de teste, crie um novo arquivo de classe, nomeie-o *MockSchoolRepository.cs*e substitua o código existente pelo seguinte código:</span><span class="sxs-lookup"><span data-stu-id="a4e59-159">In the test project, create a new class file, name it *MockSchoolRepository.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample4.cs)]

<span data-ttu-id="a4e59-160">Essa classe de repositório tem os mesmos métodos CRUD que acessa o Entity Framework diretamente, mas elas funcionam com `List` coleções na memória, em vez de um banco de dados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-160">This repository class has the same CRUD methods as the one that accesses the Entity Framework directly, but they work with `List` collections in memory instead of with a database.</span></span> <span data-ttu-id="a4e59-161">Isso torna mais fácil para uma classe de teste configurar e validar testes de unidade para a classe de lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="a4e59-161">This makes it easier for a test class to set up and validate unit tests for the business-logic class.</span></span>

## <a name="creating-unit-tests"></a><span data-ttu-id="a4e59-162">Criar testes de unidade</span><span class="sxs-lookup"><span data-stu-id="a4e59-162">Creating Unit Tests</span></span>

<span data-ttu-id="a4e59-163">O **teste** modelo de projeto criado uma classe de teste de unidade de stub para você e a próxima tarefa é modificar essa classe adicionando métodos de teste de unidade a ele para lógica de negócios que você deseja adicionar à classe de lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="a4e59-163">The **Test** project template created a stub unit test class for you, and your next task is to modify this class by adding unit test methods to it for business logic that you want to add to the business-logic class.</span></span>

<span data-ttu-id="a4e59-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-164">[![Image13](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image12.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image11.png)</span></span>

<span data-ttu-id="a4e59-165">Universidade Contoso, qualquer instrutor individual só pode ser o administrador de um único departamento e você precisa adicionar lógica de negócios para impor essa regra.</span><span class="sxs-lookup"><span data-stu-id="a4e59-165">At Contoso University, any individual instructor can only be the administrator of a single department, and you need to add business logic to enforce this rule.</span></span> <span data-ttu-id="a4e59-166">Você começará adicionando testes e executar os testes para vê-los a falhar.</span><span class="sxs-lookup"><span data-stu-id="a4e59-166">You will start by adding tests and running the tests to see them fail.</span></span> <span data-ttu-id="a4e59-167">Em seguida, você adicionará o código e execute novamente os testes, esperando para vê-los passar.</span><span class="sxs-lookup"><span data-stu-id="a4e59-167">You'll then add the code and rerun the tests, expecting to see them pass.</span></span>

<span data-ttu-id="a4e59-168">Abra o *UnitTest1.cs* de arquivos e adicionar `using` instruções para as camadas de acesso a dados e de lógica de negócios que você criou no projeto ContosoUniversity:</span><span class="sxs-lookup"><span data-stu-id="a4e59-168">Open the *UnitTest1.cs* file and add `using` statements for the business logic and data-access layers that you created in the ContosoUniversity project:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample5.cs)]

<span data-ttu-id="a4e59-169">Substitua o `TestMethod1` método com os seguintes métodos:</span><span class="sxs-lookup"><span data-stu-id="a4e59-169">Replace the `TestMethod1` method with the following methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample6.cs)]

<span data-ttu-id="a4e59-170">O `CreateSchoolBL` método cria uma instância da classe de repositório que você criou para o teste de unidade projeto, o que ele passa para uma nova instância da classe de lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="a4e59-170">The `CreateSchoolBL` method creates an instance of the repository class that you created for the unit test project, which it then passes to a new instance of the business-logic class.</span></span> <span data-ttu-id="a4e59-171">O método usa a classe de lógica de negócios para inserir três departamentos que podem ser usados em métodos de teste.</span><span class="sxs-lookup"><span data-stu-id="a4e59-171">The method then uses the business-logic class to insert three departments that you can use in test methods.</span></span>

<span data-ttu-id="a4e59-172">Os métodos de teste, verifique se que a classe de lógica de negócios lança uma exceção se alguém tenta inserir um novo departamento com o mesmo administrador de um departamento existente, ou se alguém tentar atualizar o administrador do departamento definindo-o para a ID de uma pessoa que já é o administrador de outro departamento.</span><span class="sxs-lookup"><span data-stu-id="a4e59-172">The test methods verify that the business-logic class throws an exception if someone tries to insert a new department with the same administrator as an existing department, or if someone tries to update a department's administrator by setting it to the ID of a person who is already the administrator of another department.</span></span>

<span data-ttu-id="a4e59-173">Você não criou ainda, a classe de exceção para que esse código não será compilado.</span><span class="sxs-lookup"><span data-stu-id="a4e59-173">You haven't created the exception class yet, so this code will not compile.</span></span> <span data-ttu-id="a4e59-174">Para obter compilá-lo, clique com botão direito `DuplicateAdministratorException` e selecione **gerar**e, em seguida, **classe**.</span><span class="sxs-lookup"><span data-stu-id="a4e59-174">To get it to compile, right-click `DuplicateAdministratorException` and select **Generate**, and then **Class**.</span></span>

<span data-ttu-id="a4e59-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-175">[![Image14](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image14.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image13.png)</span></span>

<span data-ttu-id="a4e59-176">Isso cria uma classe no projeto de teste que você pode excluir depois de criar a classe de exceção no projeto principal.</span><span class="sxs-lookup"><span data-stu-id="a4e59-176">This creates a class in the test project which you can delete after you've created the exception class in the main project.</span></span> <span data-ttu-id="a4e59-177">e implementado a lógica de negócios.</span><span class="sxs-lookup"><span data-stu-id="a4e59-177">and implemented the business logic.</span></span>

<span data-ttu-id="a4e59-178">Execute o projeto de teste.</span><span class="sxs-lookup"><span data-stu-id="a4e59-178">Run the test project.</span></span> <span data-ttu-id="a4e59-179">Conforme o esperado, os testes falham.</span><span class="sxs-lookup"><span data-stu-id="a4e59-179">As expected, the tests fail.</span></span>

<span data-ttu-id="a4e59-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-180">[![Image03](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image16.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image15.png)</span></span>

## <a name="adding-business-logic-to-make-a-test-pass"></a><span data-ttu-id="a4e59-181">Adicionando lógica de negócios para fazer uma passagem de teste</span><span class="sxs-lookup"><span data-stu-id="a4e59-181">Adding Business Logic to Make a Test Pass</span></span>

<span data-ttu-id="a4e59-182">Em seguida, você irá implementar a lógica de negócios que torna impossível definir como o administrador de um departamento que alguém que já seja um administrador de outro departamento.</span><span class="sxs-lookup"><span data-stu-id="a4e59-182">Next, you'll implement the business logic that makes it impossible to set as the administrator of a department someone who is already administrator of another department.</span></span> <span data-ttu-id="a4e59-183">Você lançar uma exceção da camada de lógica de negócios e, em seguida, capturar na camada de apresentação se um usuário edita um departamento e clica em **atualização** depois de selecionar alguém que já seja um administrador.</span><span class="sxs-lookup"><span data-stu-id="a4e59-183">You'll throw an exception from the business-logic layer, and then catch it in the presentation layer if a user edits a department and clicks **Update** after selecting someone who is already an administrator.</span></span> <span data-ttu-id="a4e59-184">(Você também pode remover instrutores na lista suspensa que já são administradores antes de renderizar a página, mas a finalidade aqui é trabalhar com a camada de lógica de negócios).</span><span class="sxs-lookup"><span data-stu-id="a4e59-184">(You could also remove instructors from the drop-down list who are already administrators before you render the page, but the purpose here is to work with the business-logic layer.)</span></span>

<span data-ttu-id="a4e59-185">Comece criando a classe de exceção que você vai lançar quando um usuário tenta fazer um instrutor o administrador de mais de um departamento.</span><span class="sxs-lookup"><span data-stu-id="a4e59-185">Start by creating the exception class that you'll throw when a user tries to make an instructor the administrator of more than one department.</span></span> <span data-ttu-id="a4e59-186">No projeto principal, crie um novo arquivo de classe no *BLL* pasta, nomeie-o *DuplicateAdministratorException.cs*e substitua o código existente pelo seguinte código:</span><span class="sxs-lookup"><span data-stu-id="a4e59-186">In the main project, create a new class file in the *BLL* folder, name it *DuplicateAdministratorException.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample7.cs)]

<span data-ttu-id="a4e59-187">Excluir agora temporárias *DuplicateAdministratorException.cs* arquivo que você criou no projeto de teste anteriores para que seja possível compilar.</span><span class="sxs-lookup"><span data-stu-id="a4e59-187">Now delete the temporary *DuplicateAdministratorException.cs* file that you created in the test project earlier in order to be able to compile.</span></span>

<span data-ttu-id="a4e59-188">No projeto principal, abra o *SchoolBL.cs* de arquivo e adicione o seguinte método que contém a lógica de validação.</span><span class="sxs-lookup"><span data-stu-id="a4e59-188">In the main project, open the *SchoolBL.cs* file and add the following method that contains the validation logic.</span></span> <span data-ttu-id="a4e59-189">(O código se refere a um método que você criará mais tarde).</span><span class="sxs-lookup"><span data-stu-id="a4e59-189">(The code refers to a method that you'll create later.)</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample8.cs)]

<span data-ttu-id="a4e59-190">Você poderá chamar este método quando você inserir ou atualizar `Department` entidades para verificar se outro departamento já tem a mesma do administrador.</span><span class="sxs-lookup"><span data-stu-id="a4e59-190">You'll call this method when you're inserting or updating `Department` entities in order to check whether another department already has the same administrator.</span></span>

<span data-ttu-id="a4e59-191">O código chama um método para pesquisar o banco de dados para um `Department` entidade que tem o mesmo `Administrator` valor da propriedade da entidade que está sendo inserido ou atualizado.</span><span class="sxs-lookup"><span data-stu-id="a4e59-191">The code calls a method to search the database for a `Department` entity that has the same `Administrator` property value as the entity being inserted or updated.</span></span> <span data-ttu-id="a4e59-192">Se for encontrado, o código gera uma exceção.</span><span class="sxs-lookup"><span data-stu-id="a4e59-192">If one is found, the code throws an exception.</span></span> <span data-ttu-id="a4e59-193">Não há verificação de validação é necessária se a entidade que está sendo inserido ou atualizado não tem nenhum `Administrator` valor e nenhuma exceção é gerada se o método é chamado durante uma atualização e o `Department` entidade encontrada corresponde a `Department` entidade que está sendo atualizada.</span><span class="sxs-lookup"><span data-stu-id="a4e59-193">No validation check is required if the entity being inserted or updated has no `Administrator` value, and no exception is thrown if the method is called during an update and the `Department` entity found matches the `Department` entity being updated.</span></span>

<span data-ttu-id="a4e59-194">Chamar o novo método do `Insert` e `Update` métodos:</span><span class="sxs-lookup"><span data-stu-id="a4e59-194">Call the new method from the `Insert` and `Update` methods:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample9.cs)]

<span data-ttu-id="a4e59-195">Em *ISchoolRepository.cs*, adicione a declaração a seguir para o novo método de acesso a dados:</span><span class="sxs-lookup"><span data-stu-id="a4e59-195">In *ISchoolRepository.cs*, add the following declaration for the new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample10.cs)]

<span data-ttu-id="a4e59-196">Em *SchoolRepository.cs*, adicione o seguinte `using` instrução:</span><span class="sxs-lookup"><span data-stu-id="a4e59-196">In *SchoolRepository.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample11.cs)]

<span data-ttu-id="a4e59-197">Em *SchoolRepository.cs*, adicione o novo método de acesso a dados a seguir:</span><span class="sxs-lookup"><span data-stu-id="a4e59-197">In *SchoolRepository.cs*, add the following new data-access method:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample12.cs)]

<span data-ttu-id="a4e59-198">Este código recupera `Department` entidades que têm um administrador especificado.</span><span class="sxs-lookup"><span data-stu-id="a4e59-198">This code retrieves `Department` entities that have a specified administrator.</span></span> <span data-ttu-id="a4e59-199">Deve estar presente apenas um departamento (se houver).</span><span class="sxs-lookup"><span data-stu-id="a4e59-199">Only one department should be found (if any).</span></span> <span data-ttu-id="a4e59-200">No entanto, porque nenhuma restrição é criada no banco de dados, o tipo de retorno é uma coleção, no caso de vários departamentos são encontrados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-200">However, because no constraint is built into the database, the return type is a collection in case multiple departments are found.</span></span>

<span data-ttu-id="a4e59-201">Por padrão, quando o contexto de objeto recupera entidades de banco de dados, ele mantém o controle de-los em seu Gerenciador de estado do objeto.</span><span class="sxs-lookup"><span data-stu-id="a4e59-201">By default, when the object context retrieves entities from the database, it keeps track of them in its object state manager.</span></span> <span data-ttu-id="a4e59-202">O `MergeOption.NoTracking` parâmetro especifica que esse controle não será feito para esta consulta.</span><span class="sxs-lookup"><span data-stu-id="a4e59-202">The `MergeOption.NoTracking` parameter specifies that this tracking will not be done for this query.</span></span> <span data-ttu-id="a4e59-203">Isso é necessário porque a consulta pode retornar a entidade exata que você está tentando atualizar e, em seguida, você não poderá anexar essa entidade.</span><span class="sxs-lookup"><span data-stu-id="a4e59-203">This is necessary because the query might return the exact entity that you're trying to update, and then you would not be able to attach that entity.</span></span> <span data-ttu-id="a4e59-204">Por exemplo, se você editar o departamento de histórico no *Departments.aspx* página e deixe que o administrador inalterado, essa consulta retornará o departamento de histórico.</span><span class="sxs-lookup"><span data-stu-id="a4e59-204">For example, if you edit the History department in the *Departments.aspx* page and leave the administrator unchanged, this query will return the History department.</span></span> <span data-ttu-id="a4e59-205">Se `NoTracking` não estiver definido, o contexto de objeto já terá a entidade do departamento de histórico de seu Gerenciador de estado do objeto.</span><span class="sxs-lookup"><span data-stu-id="a4e59-205">If `NoTracking` is not set, the object context would already have the History department entity in its object state manager.</span></span> <span data-ttu-id="a4e59-206">Em seguida, quando você anexa a entidade de departamento de histórico é recriada do estado de exibição, o contexto de objeto lançaria uma exceção que diz `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span><span class="sxs-lookup"><span data-stu-id="a4e59-206">Then when you attach the History department entity that's re-created from view state, the object context would throw an exception that says `"An object with the same key already exists in the ObjectStateManager. The ObjectStateManager cannot track multiple objects with the same key"`.</span></span>

<span data-ttu-id="a4e59-207">(Como uma alternativa para especificar `MergeOption.NoTracking`, você pode criar um novo contexto de objeto para esta consulta.</span><span class="sxs-lookup"><span data-stu-id="a4e59-207">(As an alternative to specifying `MergeOption.NoTracking`, you could create a new object context just for this query.</span></span> <span data-ttu-id="a4e59-208">Porque o novo contexto de objeto tem seu próprio Gerenciador de estado do objeto, não haveria nenhum conflito quando você chamar o `Attach` método.</span><span class="sxs-lookup"><span data-stu-id="a4e59-208">Because the new object context would have its own object state manager, there would be no conflict when you call the `Attach` method.</span></span> <span data-ttu-id="a4e59-209">O novo contexto de objeto seria compartilhar conexão de banco de dados e metadados com o contexto de objeto original, para a degradação de desempenho dessa abordagem alternativa seria mínima.</span><span class="sxs-lookup"><span data-stu-id="a4e59-209">The new object context would share metadata and database connection with the original object context, so the performance penalty of this alternate approach would be minimal.</span></span> <span data-ttu-id="a4e59-210">A abordagem mostrada aqui, no entanto, apresenta o `NoTracking` opção que você encontrará úteis em outros contextos.</span><span class="sxs-lookup"><span data-stu-id="a4e59-210">The approach shown here, however, introduces the `NoTracking` option, which you'll find useful in other contexts.</span></span> <span data-ttu-id="a4e59-211">O `NoTracking` opção é discutida mais um tutorial posterior nesta série.)</span><span class="sxs-lookup"><span data-stu-id="a4e59-211">The `NoTracking` option is discussed further in a later tutorial in this series.)</span></span>

<span data-ttu-id="a4e59-212">No projeto teste, adicione o novo método de acesso a dados para *MockSchoolRepository.cs*:</span><span class="sxs-lookup"><span data-stu-id="a4e59-212">In the test project, add the new data-access method to *MockSchoolRepository.cs*:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample13.cs)]

<span data-ttu-id="a4e59-213">Esse código usa LINQ para executar a seleção de dados mesmo que o `ContosoUniversity` repositório do projeto usa LINQ to Entities para.</span><span class="sxs-lookup"><span data-stu-id="a4e59-213">This code uses LINQ to perform the same data selection that the `ContosoUniversity` project repository uses LINQ to Entities for.</span></span>

<span data-ttu-id="a4e59-214">Execute o projeto de teste novamente.</span><span class="sxs-lookup"><span data-stu-id="a4e59-214">Run the test project again.</span></span> <span data-ttu-id="a4e59-215">Dessa vez os testes são aprovados.</span><span class="sxs-lookup"><span data-stu-id="a4e59-215">This time the tests pass.</span></span>

<span data-ttu-id="a4e59-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-216">[![Image04](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image18.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image17.png)</span></span>

## <a name="handling-objectdatasource-exceptions"></a><span data-ttu-id="a4e59-217">Tratamento de exceções de ObjectDataSource</span><span class="sxs-lookup"><span data-stu-id="a4e59-217">Handling ObjectDataSource Exceptions</span></span>

<span data-ttu-id="a4e59-218">No `ContosoUniversity` projeto, execute o *Departments.aspx* página e tente alterar o administrador de um departamento para alguém que já seja um administrador para outro departamento.</span><span class="sxs-lookup"><span data-stu-id="a4e59-218">In the `ContosoUniversity` project, run the *Departments.aspx* page and try to change the administrator for a department to someone who is already administrator for another department.</span></span> <span data-ttu-id="a4e59-219">(Lembre-se de que você só pode editar os departamentos que você adicionou durante este tutorial, porque o banco de dados vem pré-carregado com dados inválidos.) Você obtém a página de erro de servidor a seguir:</span><span class="sxs-lookup"><span data-stu-id="a4e59-219">(Remember that you can only edit departments that you added during this tutorial, because the database comes preloaded with invalid data.) You get the following server error page:</span></span>

<span data-ttu-id="a4e59-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-220">[![Image05](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image20.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image19.png)</span></span>

<span data-ttu-id="a4e59-221">Não convém que os usuários vejam esse tipo de página de erro, portanto você precisa adicionar o código de tratamento de erros.</span><span class="sxs-lookup"><span data-stu-id="a4e59-221">You don't want users to see this kind of error page, so you need to add error-handling code.</span></span> <span data-ttu-id="a4e59-222">Abra *Departments.aspx* e especifique um manipulador para o `OnUpdated` eventos do `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a4e59-222">Open *Departments.aspx* and specify a handler for the `OnUpdated` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="a4e59-223">O `ObjectDataSource` à marca de abertura agora se parece com o exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="a4e59-223">The `ObjectDataSource` opening tag now resembles the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample14.aspx)]

<span data-ttu-id="a4e59-224">Em *Departments.aspx.cs*, adicione o seguinte `using` instrução:</span><span class="sxs-lookup"><span data-stu-id="a4e59-224">In *Departments.aspx.cs*, add the following `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample15.cs)]

<span data-ttu-id="a4e59-225">Adicione o seguinte manipulador para o `Updated` evento:</span><span class="sxs-lookup"><span data-stu-id="a4e59-225">Add the following handler for the `Updated` event:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample16.cs)]

<span data-ttu-id="a4e59-226">Se o `ObjectDataSource` controle captura uma exceção ao tentar executar a atualização, ele passa a exceção de argumento do evento (`e`) a esse manipulador.</span><span class="sxs-lookup"><span data-stu-id="a4e59-226">If the `ObjectDataSource` control catches an exception when it tries to perform the update, it passes the exception in the event argument (`e`) to this handler.</span></span> <span data-ttu-id="a4e59-227">O código no manipulador verifica se a exceção é a exceção do administrador duplicado.</span><span class="sxs-lookup"><span data-stu-id="a4e59-227">The code in the handler checks to see if the exception is the duplicate administrator exception.</span></span> <span data-ttu-id="a4e59-228">Se for, o código cria um controle de validação que contém uma mensagem de erro para o `ValidationSummary` controle para exibir.</span><span class="sxs-lookup"><span data-stu-id="a4e59-228">If it is, the code creates a validator control that contains an error message for the `ValidationSummary` control to display.</span></span>

<span data-ttu-id="a4e59-229">Execute a página e tente fazer a alguém a administrador de dois departamentos novamente.</span><span class="sxs-lookup"><span data-stu-id="a4e59-229">Run the page and attempt to make someone the administrator of two departments again.</span></span> <span data-ttu-id="a4e59-230">Neste momento o `ValidationSummary` controle exibe uma mensagem de erro.</span><span class="sxs-lookup"><span data-stu-id="a4e59-230">This time the `ValidationSummary` control displays an error message.</span></span>

<span data-ttu-id="a4e59-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="a4e59-231">[![Image06](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image22.png)](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/_static/image21.png)</span></span>

<span data-ttu-id="a4e59-232">Fazer alterações semelhantes para o *DepartmentsAdd.aspx* página.</span><span class="sxs-lookup"><span data-stu-id="a4e59-232">Make similar changes to the *DepartmentsAdd.aspx* page.</span></span> <span data-ttu-id="a4e59-233">Em *DepartmentsAdd.aspx*, especifique um manipulador para o `OnInserted` eventos do `DepartmentsObjectDataSource`.</span><span class="sxs-lookup"><span data-stu-id="a4e59-233">In *DepartmentsAdd.aspx*, specify a handler for the `OnInserted` event of the `DepartmentsObjectDataSource`.</span></span> <span data-ttu-id="a4e59-234">A marcação resultante será parecida com o exemplo a seguir.</span><span class="sxs-lookup"><span data-stu-id="a4e59-234">The resulting markup will resemble the following example.</span></span>

[!code-aspx[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample17.aspx)]

<span data-ttu-id="a4e59-235">Em *DepartmentsAdd.aspx.cs*, adicionar a mesma `using` instrução:</span><span class="sxs-lookup"><span data-stu-id="a4e59-235">In *DepartmentsAdd.aspx.cs*, add the same `using` statement:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample18.cs)]

<span data-ttu-id="a4e59-236">Adicione o manipulador de eventos a seguir:</span><span class="sxs-lookup"><span data-stu-id="a4e59-236">Add the following event handler:</span></span>

[!code-csharp[Main](using-the-entity-framework-and-the-objectdatasource-control-part-2-adding-a-business-logic-layer-and-unit-tests/samples/sample19.cs)]

<span data-ttu-id="a4e59-237">Agora você pode testar o *DepartmentsAdd.aspx.cs* página para verificar que manipula corretamente também tenta fazer uma pessoa que o administrador de mais de um departamento.</span><span class="sxs-lookup"><span data-stu-id="a4e59-237">You can now test the *DepartmentsAdd.aspx.cs* page to verify that it also correctly handles attempts to make one person the administrator of more than one department.</span></span>

<span data-ttu-id="a4e59-238">Isso conclui a introdução ao implementar o padrão de repositório para usar o `ObjectDataSource` controle com o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="a4e59-238">This completes the introduction to implementing the repository pattern for using the `ObjectDataSource` control with the Entity Framework.</span></span> <span data-ttu-id="a4e59-239">Para obter mais informações sobre o repositório padrão e a capacidade de teste, consulte o white paper MSDN [capacidade de teste e o Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span><span class="sxs-lookup"><span data-stu-id="a4e59-239">For more information about the repository pattern and testability, see the MSDN whitepaper [Testability and Entity Framework 4.0](https://msdn.microsoft.com/library/ff714955.aspx).</span></span>

<span data-ttu-id="a4e59-240">O tutorial a seguir, você verá como adicionar classificação e filtragem de funcionalidade para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="a4e59-240">In the following tutorial you'll see how to add sorting and filtering functionality to the application.</span></span>

>[!div class="step-by-step"]
<span data-ttu-id="a4e59-241">[Anterior](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Próximo](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span><span class="sxs-lookup"><span data-stu-id="a4e59-241">[Previous](using-the-entity-framework-and-the-objectdatasource-control-part-1-getting-started.md)
[Next](using-the-entity-framework-and-the-objectdatasource-control-part-3-sorting-and-filtering.md)</span></span>
