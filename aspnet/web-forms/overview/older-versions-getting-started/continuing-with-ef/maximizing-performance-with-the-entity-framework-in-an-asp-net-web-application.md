---
uid: web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
title: Maximizar o desempenho com o Entity Framework 4.0 em um aplicativo ASP.NET 4 | Microsoft Docs
author: tdykstra
description: Esta série de tutorial se baseia no aplicativo web Contoso Universidade que é criado pelo guia de Introdução com a série de tutoriais do Entity Framework 4.0. I...
ms.author: aspnetcontent
manager: wpickett
ms.date: 01/26/2011
ms.topic: article
ms.assetid: 4e43455e-dfa1-42db-83cb-c987703f04b5
ms.technology: dotnet-webforms
ms.prod: .net-framework
msc.legacyurl: /web-forms/overview/older-versions-getting-started/continuing-with-ef/maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application
msc.type: authoredcontent
ms.openlocfilehash: b85645eebf2822b33df944692736ea9d9b69b9aa
ms.sourcegitcommit: f8852267f463b62d7f975e56bea9aa3f68fbbdeb
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 04/06/2018
---
<a name="maximizing-performance-with-the-entity-framework-40-in-an-aspnet-4-web-application"></a><span data-ttu-id="21b7f-104">Maximizar o desempenho com o Entity Framework 4.0 em um aplicativo ASP.NET 4</span><span class="sxs-lookup"><span data-stu-id="21b7f-104">Maximizing Performance with the Entity Framework 4.0 in an ASP.NET 4 Web Application</span></span>
====================
<span data-ttu-id="21b7f-105">por [Tom Dykstra](https://github.com/tdykstra)</span><span class="sxs-lookup"><span data-stu-id="21b7f-105">by [Tom Dykstra](https://github.com/tdykstra)</span></span>

> <span data-ttu-id="21b7f-106">Esta série de tutoriais se baseia no aplicativo da web Contoso Universidade que é criado pelo [guia de Introdução com o Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) série de tutoriais.</span><span class="sxs-lookup"><span data-stu-id="21b7f-106">This tutorial series builds on the Contoso University web application that is created by the [Getting Started with the Entity Framework 4.0](https://asp.net/entity-framework/tutorials#Getting%20Started) tutorial series.</span></span> <span data-ttu-id="21b7f-107">Se você não concluir os tutoriais anteriores, como um ponto de partida para este tutorial você pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) que você pode ter sido criado.</span><span class="sxs-lookup"><span data-stu-id="21b7f-107">If you didn't complete the earlier tutorials, as a starting point for this tutorial you can [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-97f8ee9a) that you would have created.</span></span> <span data-ttu-id="21b7f-108">Você também pode [baixar o aplicativo](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) que é criado pela série tutorial completo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-108">You can also [download the application](https://code.msdn.microsoft.com/ASPNET-Web-Forms-6c7197aa) that is created by the complete tutorial series.</span></span> <span data-ttu-id="21b7f-109">Se você tiver dúvidas sobre os tutoriais, você poderá postá-los para o [fórum ASP.NET Entity Framework](https://forums.asp.net/1227.aspx).</span><span class="sxs-lookup"><span data-stu-id="21b7f-109">If you have questions about the tutorials, you can post them to the [ASP.NET Entity Framework forum](https://forums.asp.net/1227.aspx).</span></span>


<span data-ttu-id="21b7f-110">No tutorial anterior, você viu como lidar com conflitos de simultaneidade.</span><span class="sxs-lookup"><span data-stu-id="21b7f-110">In the previous tutorial, you saw how to handle concurrency conflicts.</span></span> <span data-ttu-id="21b7f-111">Este tutorial mostra opções para melhorar o desempenho de um aplicativo web ASP.NET que usa o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="21b7f-111">This tutorial shows options for improving the performance of an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="21b7f-112">Você aprenderá a vários métodos para maximizar o desempenho ou diagnosticar problemas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="21b7f-112">You'll learn several methods for maximizing performance or for diagnosing performance problems.</span></span>

<span data-ttu-id="21b7f-113">As informações apresentadas nas seções a seguir são provavelmente serão úteis em uma ampla variedade de cenários:</span><span class="sxs-lookup"><span data-stu-id="21b7f-113">Information presented in the following sections is likely to be useful in a broad variety of scenarios:</span></span>

- <span data-ttu-id="21b7f-114">Carregar com eficiência os dados relacionados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-114">Efficiently load related data.</span></span>
- <span data-ttu-id="21b7f-115">Gerencie o estado de exibição.</span><span class="sxs-lookup"><span data-stu-id="21b7f-115">Manage view state.</span></span>

<span data-ttu-id="21b7f-116">As informações apresentadas nas seções a seguir podem ser útil se você tiver consultas individuais que problemas de desempenho presentes:</span><span class="sxs-lookup"><span data-stu-id="21b7f-116">Information presented in the following sections might be useful if you have individual queries that present performance problems:</span></span>

- <span data-ttu-id="21b7f-117">Use o `NoTracking` opção de mesclagem.</span><span class="sxs-lookup"><span data-stu-id="21b7f-117">Use the `NoTracking` merge option.</span></span>
- <span data-ttu-id="21b7f-118">Pré-compile consultas LINQ.</span><span class="sxs-lookup"><span data-stu-id="21b7f-118">Pre-compile LINQ queries.</span></span>
- <span data-ttu-id="21b7f-119">Examine os comandos de consulta enviados para o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-119">Examine query commands sent to the database.</span></span>

<span data-ttu-id="21b7f-120">As informações apresentadas na seção a seguir são potencialmente útil para aplicativos que têm modelos de dados muito grande:</span><span class="sxs-lookup"><span data-stu-id="21b7f-120">Information presented in the following section is potentially useful for applications that have extremely large data models:</span></span>

- <span data-ttu-id="21b7f-121">Gere previamente modos de exibição.</span><span class="sxs-lookup"><span data-stu-id="21b7f-121">Pre-generate views.</span></span>

> [!NOTE]
> <span data-ttu-id="21b7f-122">Desempenho do aplicativo Web é afetado por muitos fatores, incluindo o tamanho dos dados de solicitação e resposta, a velocidade de consultas de banco de dados, quantas solicitações que o servidor pode enfileirar e rapidez pode servi-los e até mesmo a eficiência de qualquer bibliotecas de scripts de cliente que talvez você esteja usando.</span><span class="sxs-lookup"><span data-stu-id="21b7f-122">Web application performance is affected by many factors, including things like the size of request and response data, the speed of database queries, how many requests the server can queue and how quickly it can service them, and even the efficiency of any client-script libraries you might be using.</span></span> <span data-ttu-id="21b7f-123">Se o desempenho for crítico em seu aplicativo, ou se o teste ou a experiência mostra que o desempenho do aplicativo não é satisfatório, você deve seguir o protocolo normal para ajuste de desempenho.</span><span class="sxs-lookup"><span data-stu-id="21b7f-123">If performance is critical in your application, or if testing or experience shows that application performance isn't satisfactory, you should follow normal protocol for performance tuning.</span></span> <span data-ttu-id="21b7f-124">Medidas para determinar onde os afunilamentos de desempenho estão ocorrendo e resolva as áreas que terão o maior impacto no desempenho geral do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-124">Measure to determine where performance bottlenecks are occurring, and then address the areas that will have the greatest impact on overall application performance.</span></span>
> 
> <span data-ttu-id="21b7f-125">Este tópico se concentra principalmente em maneiras em que é possível melhorar o desempenho especificamente do Entity Framework no ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="21b7f-125">This topic focuses mainly on ways in which you can potentially improve the performance specifically of the Entity Framework in ASP.NET.</span></span> <span data-ttu-id="21b7f-126">As sugestões aqui são úteis se você determinar que o acesso a dados é um dos afunilamentos de desempenho em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-126">The suggestions here are useful if you determine that data access is one of the performance bottlenecks in your application.</span></span> <span data-ttu-id="21b7f-127">Exceto conforme observado, os métodos explicados aqui não devem ser considerados &quot;práticas recomendadas&quot; em geral, muitas delas são apropriadas somente em situações excepcionais ou a tipos de endereço muito específica de afunilamentos de desempenho.</span><span class="sxs-lookup"><span data-stu-id="21b7f-127">Except as noted, the methods explained here shouldn't be considered &quot;best practices&quot; in general — many of them are appropriate only in exceptional situations or to address very specific kinds of performance bottlenecks.</span></span>


<span data-ttu-id="21b7f-128">Para iniciar o tutorial, inicie o Visual Studio e abra o aplicativo web Contoso Universidade que você estava trabalhando no tutorial anterior.</span><span class="sxs-lookup"><span data-stu-id="21b7f-128">To start the tutorial, start Visual Studio and open the Contoso University web application that you were working with in the previous tutorial.</span></span>

## <a name="efficiently-loading-related-data"></a><span data-ttu-id="21b7f-129">Carregar com eficiência os dados relacionados</span><span class="sxs-lookup"><span data-stu-id="21b7f-129">Efficiently Loading Related Data</span></span>

<span data-ttu-id="21b7f-130">Há várias maneiras que o Entity Framework pode carregar dados relacionados para as propriedades de navegação de uma entidade:</span><span class="sxs-lookup"><span data-stu-id="21b7f-130">There are several ways that the Entity Framework can load related data into the navigation properties of an entity:</span></span>

- <span data-ttu-id="21b7f-131">*Carregamento lento*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-131">*Lazy loading*.</span></span> <span data-ttu-id="21b7f-132">Quando a entidade é lida pela primeira vez, os dados relacionados não são recuperados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-132">When the entity is first read, related data isn't retrieved.</span></span> <span data-ttu-id="21b7f-133">No entanto, na primeira vez que você tenta acessar uma propriedade de navegação, os dados necessários para essa propriedade de navegação são recuperados automaticamente.</span><span class="sxs-lookup"><span data-stu-id="21b7f-133">However, the first time you attempt to access a navigation property, the data required for that navigation property is automatically retrieved.</span></span> <span data-ttu-id="21b7f-134">Isso resulta em várias consultas enviadas ao banco de dados — um para a própria entidade e um cada vez que os dados para a entidade relacionados deve ser recuperado.</span><span class="sxs-lookup"><span data-stu-id="21b7f-134">This results in multiple queries sent to the database — one for the entity itself and one each time that related data for the entity must be retrieved.</span></span> 

    <span data-ttu-id="21b7f-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-135">[![Image05](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image2.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image1.png)</span></span>

<span data-ttu-id="21b7f-136">*Carregamento adiantado*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-136">*Eager loading*.</span></span> <span data-ttu-id="21b7f-137">Quando a entidade é lida, os dados relacionados são recuperados com ela.</span><span class="sxs-lookup"><span data-stu-id="21b7f-137">When the entity is read, related data is retrieved along with it.</span></span> <span data-ttu-id="21b7f-138">Normalmente, isso resulta em uma única consulta de junção que recupera todos os dados necessários.</span><span class="sxs-lookup"><span data-stu-id="21b7f-138">This typically results in a single join query that retrieves all of the data that's needed.</span></span> <span data-ttu-id="21b7f-139">Especifique o carregamento rápido usando o `Include` método, como já vimos nos tutoriais.</span><span class="sxs-lookup"><span data-stu-id="21b7f-139">You specify eager loading by using the `Include` method, as you've seen already in these tutorials.</span></span>

<span data-ttu-id="21b7f-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-140">[![Image07](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image4.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image3.png)</span></span>

- <span data-ttu-id="21b7f-141">*Carregamento explícito*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-141">*Explicit loading*.</span></span> <span data-ttu-id="21b7f-142">Isso é semelhante ao carregamento lento, exceto que você explicitamente recuperar os dados relacionados no código; Isso não acontece automaticamente quando você acessa uma propriedade de navegação.</span><span class="sxs-lookup"><span data-stu-id="21b7f-142">This is similar to lazy loading, except that you explicitly retrieve the related data in code; it doesn't happen automatically when you access a navigation property.</span></span> <span data-ttu-id="21b7f-143">Carregar dados relacionados manualmente usando o `Load` método da propriedade de navegação para coleções, ou usar o `Load` método da propriedade de referência para propriedades que contêm um único objeto.</span><span class="sxs-lookup"><span data-stu-id="21b7f-143">You load related data manually using the `Load` method of the navigation property for collections, or you use the `Load` method of the reference property for properties that hold a single object.</span></span> <span data-ttu-id="21b7f-144">(Por exemplo, você chama o `PersonReference.Load` método ao carregar o `Person` propriedade de navegação de um `Department` entidade.)</span><span class="sxs-lookup"><span data-stu-id="21b7f-144">(For example, you call the `PersonReference.Load` method to load the `Person` navigation property of a `Department` entity.)</span></span>

    <span data-ttu-id="21b7f-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-145">[![Image06](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image6.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image5.png)</span></span>

<span data-ttu-id="21b7f-146">Porque eles imediatamente não recuperarem os valores de propriedade, carregamento lento e carregamento explícito também são ambos conhecidos como *carregamento diferido*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-146">Because they don't immediately retrieve the property values, lazy loading and explicit loading are also both known as *deferred loading*.</span></span>

<span data-ttu-id="21b7f-147">Carregamento lento é o comportamento padrão de um contexto de objeto que foi gerado pelo designer.</span><span class="sxs-lookup"><span data-stu-id="21b7f-147">Lazy loading is the default behavior for an object context that has been generated by the designer.</span></span> <span data-ttu-id="21b7f-148">Se você abrir o *SchoolModel.Designer.cs* arquivo que define a classe de contexto de objeto, você encontrará três métodos de construtor, e cada um deles inclui a instrução a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-148">If you open the *SchoolModel.Designer.cs* file that defines the object context class, you'll find three constructor methods, and each of them includes the following statement:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample1.cs)]

<span data-ttu-id="21b7f-149">Em geral, se você souber terá dados relacionados para cada entidade recuperado, eager carregamento oferece o melhor desempenho, porque uma única consulta enviada para o banco de dados é geralmente mais eficiente do que consultas separadas para cada entidade recuperada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-149">In general, if you know you need related data for every entity retrieved, eager loading offers the best performance, because a single query sent to the database is typically more efficient than separate queries for each entity retrieved.</span></span> <span data-ttu-id="21b7f-150">Por outro lado, se você precisar acessar as propriedades de navegação de uma entidade raramente ou apenas para um pequeno conjunto de entidades, o carregamento lento ou o carregamento explícito pode ser mais eficiente, porque mais dados que você precisa recuperar o carregamento rápido.</span><span class="sxs-lookup"><span data-stu-id="21b7f-150">On the other hand, if you need to access an entity's navigation properties only infrequently or only for a small set of the entities, lazy loading or explicit loading may be more efficient, because eager loading would retrieve more data than you need.</span></span>

<span data-ttu-id="21b7f-151">Em um aplicativo web, carregamento lento pode ser relativamente pouco valor mesmo assim, porque ações de usuário que afetam a necessidade de dados relacionados ocorrem no navegador, que não tem nenhuma conexão para o contexto de objeto que a página renderizada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-151">In a web application, lazy loading may be of relatively little value anyway, because user actions that affect the need for related data take place in the browser, which has no connection to the object context that rendered the page.</span></span> <span data-ttu-id="21b7f-152">Por outro lado, quando você databind um controle, você normalmente sabe quais dados você precisa e geralmente é melhor escolher carregamento adiantado ou carregamento adiado com base no que é apropriado em cada cenário.</span><span class="sxs-lookup"><span data-stu-id="21b7f-152">On the other hand, when you databind a control, you typically know what data you need, and so it's generally best to choose eager loading or deferred loading based on what's appropriate in each scenario.</span></span>

<span data-ttu-id="21b7f-153">Além disso, um controle de ligação de dados pode usar um objeto de entidade depois que o contexto do objeto é descartado.</span><span class="sxs-lookup"><span data-stu-id="21b7f-153">In addition, a databound control might use an entity object after the object context is disposed.</span></span> <span data-ttu-id="21b7f-154">Nesse caso, uma tentativa de uma propriedade de navegação lento carga falhará.</span><span class="sxs-lookup"><span data-stu-id="21b7f-154">In that case, an attempt to lazy-load a navigation property would fail.</span></span> <span data-ttu-id="21b7f-155">Você recebe a mensagem de erro é clara: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span><span class="sxs-lookup"><span data-stu-id="21b7f-155">The error message you receive is clear: &quot;`The ObjectContext instance has been disposed and can no longer be used for operations that require a connection.`&quot;</span></span>

<span data-ttu-id="21b7f-156">O `EntityDataSource` desabilita o controle de carregamento lento por padrão.</span><span class="sxs-lookup"><span data-stu-id="21b7f-156">The `EntityDataSource` control disables lazy loading by default.</span></span> <span data-ttu-id="21b7f-157">Para o `ObjectDataSource` controle que você está usando para o tutorial atual (ou se você acessar o contexto de objeto de código da página), há várias maneiras que você pode tornar lenta carregamento desabilitado por padrão.</span><span class="sxs-lookup"><span data-stu-id="21b7f-157">For the `ObjectDataSource` control that you're using for the current tutorial (or if you access the object context from page code), there are several ways you can make lazy loading disabled by default.</span></span> <span data-ttu-id="21b7f-158">Você pode desabilitá-lo quando você criar uma instância de um contexto de objeto.</span><span class="sxs-lookup"><span data-stu-id="21b7f-158">You can disable it when you instantiate an object context.</span></span> <span data-ttu-id="21b7f-159">Por exemplo, você pode adicionar a linha a seguir para o método de construtor do `SchoolRepository` classe:</span><span class="sxs-lookup"><span data-stu-id="21b7f-159">For example, you can add the following line to the constructor method of the `SchoolRepository` class:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample2.cs)]

<span data-ttu-id="21b7f-160">Para o aplicativo da Contoso University, você fará o contexto de objeto desabilitar o carregamento preguiçoso para que essa propriedade não precisa ser definido sempre que um contexto de instância é criado automaticamente.</span><span class="sxs-lookup"><span data-stu-id="21b7f-160">For the Contoso University application, you'll make the object context automatically disable lazy loading so that this property doesn't have to be set whenever a context is instantiated.</span></span>

<span data-ttu-id="21b7f-161">Abra o *SchoolModel.edmx* dados de modelo, clique na superfície de design e, em seguida, no painel Propriedades, defina o **carregamento lento habilitada** propriedade `False`.</span><span class="sxs-lookup"><span data-stu-id="21b7f-161">Open the *SchoolModel.edmx* data model, click the design surface, and then in the properties pane set the **Lazy Loading Enabled** property to `False`.</span></span> <span data-ttu-id="21b7f-162">Salve e feche o modelo de dados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-162">Save and close the data model.</span></span>

<span data-ttu-id="21b7f-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-163">[![Image04](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image8.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image7.png)</span></span>

## <a name="managing-view-state"></a><span data-ttu-id="21b7f-164">Gerenciamento de estado de exibição</span><span class="sxs-lookup"><span data-stu-id="21b7f-164">Managing View State</span></span>

<span data-ttu-id="21b7f-165">Para fornecer funcionalidade de atualização, uma página da web deve armazenar os valores de propriedade original de uma entidade quando uma página é processada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-165">In order to provide update functionality, an ASP.NET web page must store the original property values of an entity when a page is rendered.</span></span> <span data-ttu-id="21b7f-166">Durante um postback para processar o controle pode recriar o estado original da entidade e chamar a entidade `Attach` método antes de aplicar as alterações e chamar o `SaveChanges` método.</span><span class="sxs-lookup"><span data-stu-id="21b7f-166">During postback processing the control can re-create the original state of the entity and call the entity's `Attach` method before applying changes and calling the `SaveChanges` method.</span></span> <span data-ttu-id="21b7f-167">Por padrão, os controles de formulários da Web ASP.NET de dados usam o estado de exibição para armazenar os valores originais.</span><span class="sxs-lookup"><span data-stu-id="21b7f-167">By default, ASP.NET Web Forms data controls use view state to store the original values.</span></span> <span data-ttu-id="21b7f-168">No entanto, o estado de exibição pode afetar o desempenho, porque ela está armazenada nos campos ocultos que podem aumentar consideravelmente o tamanho da página que é enviado para e do navegador.</span><span class="sxs-lookup"><span data-stu-id="21b7f-168">However, view state can affect performance, because it's stored in hidden fields that can substantially increase the size of the page that's sent to and from the browser.</span></span>

<span data-ttu-id="21b7f-169">Técnicas para gerenciar o estado de exibição ou alternativas, como estado de sessão, não são exclusivas para o Entity Framework para que este tutorial não entram nesse tópico em detalhes.</span><span class="sxs-lookup"><span data-stu-id="21b7f-169">Techniques for managing view state, or alternatives such as session state, aren't unique to the Entity Framework, so this tutorial doesn't go into this topic in detail.</span></span> <span data-ttu-id="21b7f-170">Para obter mais informações, consulte os links no final do tutorial.</span><span class="sxs-lookup"><span data-stu-id="21b7f-170">For more information see the links at the end of the tutorial.</span></span>

<span data-ttu-id="21b7f-171">No entanto, a versão 4 do ASP.NET fornece uma nova maneira de trabalhar com o estado de exibição que todos os desenvolvedores do ASP.NET de aplicativos Web Forms devem estar atento: o `ViewStateMode` propriedade.</span><span class="sxs-lookup"><span data-stu-id="21b7f-171">However, version 4 of ASP.NET provides a new way of working with view state that every ASP.NET developer of Web Forms applications should be aware of: the `ViewStateMode` property.</span></span> <span data-ttu-id="21b7f-172">Essa nova propriedade pode ser definida no nível de página ou controle e permite que você desabilite o estado de exibição por padrão para uma página e habilitá-lo somente para controles que precisam dela.</span><span class="sxs-lookup"><span data-stu-id="21b7f-172">This new property can be set at the page or control level, and it enables you to disable view state by default for a page and enable it only for controls that need it.</span></span>

<span data-ttu-id="21b7f-173">Para aplicativos em que o desempenho for crítico, uma boa prática é sempre desabilitar o estado de exibição no nível da página e habilitá-lo somente para controles que a exigem.</span><span class="sxs-lookup"><span data-stu-id="21b7f-173">For applications where performance is critical, a good practice is to always disable view state at the page level and enable it only for controls that require it.</span></span> <span data-ttu-id="21b7f-174">O tamanho do estado de exibição nas páginas de Contoso Universidade não diminuir substancialmente por esse método, mas para ver como isso funciona, você fará isso o *Instructors.aspx* página.</span><span class="sxs-lookup"><span data-stu-id="21b7f-174">The size of view state in the Contoso University pages wouldn't be substantially decreased by this method, but to see how it works, you'll do it for the *Instructors.aspx* page.</span></span> <span data-ttu-id="21b7f-175">Essa página contém vários controles, incluindo um `Label` controle com estado de exibição desabilitado.</span><span class="sxs-lookup"><span data-stu-id="21b7f-175">That page contains many controls, including a `Label` control that has view state disabled.</span></span> <span data-ttu-id="21b7f-176">Nenhum dos controles nesta página, na verdade, precisa ter o estado ativado de modo de exibição.</span><span class="sxs-lookup"><span data-stu-id="21b7f-176">None of the controls on this page actually need to have view state enabled.</span></span> <span data-ttu-id="21b7f-177">(O `DataKeyNames` propriedade o `GridView` controle especifica o estado que deve ser mantido entre postbacks, mas esses valores são mantidos no estado de controle, que não é afetado pelo `ViewStateMode` propriedade.)</span><span class="sxs-lookup"><span data-stu-id="21b7f-177">(The `DataKeyNames` property of the `GridView` control specifies state that must be maintained between postbacks, but these values are kept in control state, which isn't affected by the `ViewStateMode` property.)</span></span>

<span data-ttu-id="21b7f-178">O `Page` diretiva e `Label` marcação controle atualmente se parece com o exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-178">The `Page` directive and `Label` control markup currently resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample3.aspx)]

<span data-ttu-id="21b7f-179">Faça as seguintes alterações:</span><span class="sxs-lookup"><span data-stu-id="21b7f-179">Make the following changes:</span></span>

- <span data-ttu-id="21b7f-180">Adicionar `ViewStateMode="Disabled"` para o `Page` diretiva.</span><span class="sxs-lookup"><span data-stu-id="21b7f-180">Add `ViewStateMode="Disabled"` to the `Page` directive.</span></span>
- <span data-ttu-id="21b7f-181">Remover `ViewStateMode="Disabled"` do `Label` controle.</span><span class="sxs-lookup"><span data-stu-id="21b7f-181">Remove `ViewStateMode="Disabled"` from the `Label` control.</span></span>

<span data-ttu-id="21b7f-182">A marcação agora se parece com o exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-182">The markup now resembles the following example:</span></span>

[!code-aspx[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample4.aspx)]

<span data-ttu-id="21b7f-183">Estado de exibição agora é desabilitado para todos os controles.</span><span class="sxs-lookup"><span data-stu-id="21b7f-183">View state is now disabled for all controls.</span></span> <span data-ttu-id="21b7f-184">Se mais tarde você adicionar um controle que precisam usar o estado de exibição, tudo o que você precisa fazer é incluir o `ViewStateMode="Enabled"` atributo para o controle.</span><span class="sxs-lookup"><span data-stu-id="21b7f-184">If you later add a control that does need to use view state, all you need to do is include the `ViewStateMode="Enabled"` attribute for that control.</span></span>

## <a name="using-the-notracking-merge-option"></a><span data-ttu-id="21b7f-185">Usando a opção de mesclagem NoTracking</span><span class="sxs-lookup"><span data-stu-id="21b7f-185">Using The NoTracking Merge Option</span></span>

<span data-ttu-id="21b7f-186">Quando um contexto de objeto recupera linhas do banco de dados e cria objetos de entidade que representam-los, por padrão ele também controla os objetos de entidade usando o Gerenciador de estado do objeto.</span><span class="sxs-lookup"><span data-stu-id="21b7f-186">When an object context retrieves database rows and creates entity objects that represent them, by default it also tracks those entity objects using its object state manager.</span></span> <span data-ttu-id="21b7f-187">Dados de controle atua como um cache e são usados quando você atualizar uma entidade.</span><span class="sxs-lookup"><span data-stu-id="21b7f-187">This tracking data acts as a cache and is used when you update an entity.</span></span> <span data-ttu-id="21b7f-188">Como um aplicativo da web geralmente tem instâncias de contexto do objeto de curta duração, consultas normalmente retornam dados que não precisam ser controlados, porque o contexto de objeto que lê-los será descartado antes de qualquer uma das entidades lê usadas novamente ou atualizada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-188">Because a web application typically has short-lived object context instances, queries often return data that doesn't need to be tracked, because the object context that reads them will be disposed before any of the entities it reads are used again or updated.</span></span>

<span data-ttu-id="21b7f-189">O Entity Framework, você pode especificar se o contexto do objeto controla os objetos de entidade, definindo um *opção de mesclagem*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-189">In the Entity Framework, you can specify whether the object context tracks entity objects by setting a *merge option*.</span></span> <span data-ttu-id="21b7f-190">Você pode definir a opção de mesclagem para consultas individuais ou para conjuntos de entidades.</span><span class="sxs-lookup"><span data-stu-id="21b7f-190">You can set the merge option for individual queries or for entity sets.</span></span> <span data-ttu-id="21b7f-191">Se você defini-lo para um conjunto de entidades, que significa que você está definindo a opção de mesclagem padrão para todas as consultas que são criados para esse conjunto de entidades.</span><span class="sxs-lookup"><span data-stu-id="21b7f-191">If you set it for an entity set, that means that you're setting the default merge option for all queries that are created for that entity set.</span></span>

<span data-ttu-id="21b7f-192">Para o aplicativo da Contoso University, o controle não é necessária para qualquer um dos conjuntos de entidades que você acessa do repositório, você pode definir a opção de mesclagem `NoTracking` para esses conjuntos de entidade quando você criar uma instância de contexto do objeto da classe do repositório.</span><span class="sxs-lookup"><span data-stu-id="21b7f-192">For the Contoso University application, tracking isn't needed for any of the entity sets that you access from the repository, so you can set the merge option to `NoTracking` for those entity sets when you instantiate the object context in the repository class.</span></span> <span data-ttu-id="21b7f-193">(Observe que neste tutorial, definindo a opção de mesclagem não terá um efeito significativo no desempenho do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-193">(Note that in this tutorial, setting the merge option won't have a noticeable effect on the application's performance.</span></span> <span data-ttu-id="21b7f-194">O `NoTracking` opção é provável que faça uma melhoria de desempenho observável apenas em determinados cenários de alto volume de dados.)</span><span class="sxs-lookup"><span data-stu-id="21b7f-194">The `NoTracking` option is likely to make an observable performance improvement only in certain high-data-volume scenarios.)</span></span>

<span data-ttu-id="21b7f-195">Na pasta DAL, abra o *SchoolRepository.cs* de arquivos e adicionar um método de construtor que define a opção de mesclagem para a entidade define que acessa o repositório:</span><span class="sxs-lookup"><span data-stu-id="21b7f-195">In the DAL folder, open the *SchoolRepository.cs* file and add a constructor method that sets the merge option for the entity sets that the repository accesses:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample5.cs)]

## <a name="pre-compiling-linq-queries"></a><span data-ttu-id="21b7f-196">Pré-compilação consultas do LINQ</span><span class="sxs-lookup"><span data-stu-id="21b7f-196">Pre-Compiling LINQ Queries</span></span>

<span data-ttu-id="21b7f-197">Na primeira vez que o Entity Framework executa uma consulta de Entity SQL dentro de vida de um determinado `ObjectContext` instância, levará algum tempo para compilar a consulta.</span><span class="sxs-lookup"><span data-stu-id="21b7f-197">The first time that the Entity Framework executes an Entity SQL query within the life of a given `ObjectContext` instance, it takes some time to compile the query.</span></span> <span data-ttu-id="21b7f-198">O resultado da compilação é armazenado em cache, que significa que as execuções subsequentes da consulta serão muito mais rápidas.</span><span class="sxs-lookup"><span data-stu-id="21b7f-198">The result of compilation is cached, which means that subsequent executions of the query are much quicker.</span></span> <span data-ttu-id="21b7f-199">Consultas LINQ seguem um padrão semelhante, exceto que parte do trabalho necessário para compilar a consulta é feita sempre que a consulta é executada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-199">LINQ queries follow a similar pattern, except that some of the work required to compile the query is done every time the query is executed.</span></span> <span data-ttu-id="21b7f-200">Em outras palavras, para consultas LINQ, por padrão não todos os resultados da compilação são armazenados em cache.</span><span class="sxs-lookup"><span data-stu-id="21b7f-200">In other words, for LINQ queries, by default not all of the results of compilation are cached.</span></span>

<span data-ttu-id="21b7f-201">Se você tiver uma consulta LINQ que você pretende executar repetidamente na vida de um contexto de objeto, você pode escrever código que faz com que todos os resultados da compilação a ser armazenado em cache a primeira vez que a consulta LINQ é executada.</span><span class="sxs-lookup"><span data-stu-id="21b7f-201">If you have a LINQ query that you expect to run repeatedly in the life of an object context, you can write code that causes all of the results of compilation to be cached the first time the LINQ query is run.</span></span>

<span data-ttu-id="21b7f-202">Como ilustração, isso será feito de duas `Get` métodos o `SchoolRepository` classe, um dos quais não usa nenhum parâmetro (o `GetInstructorNames` método) e outra que requer um parâmetro (o `GetDepartmentsByAdministrator` método).</span><span class="sxs-lookup"><span data-stu-id="21b7f-202">As an illustration, you'll do this for two `Get` methods in the `SchoolRepository` class, one of which doesn't take any parameters (the `GetInstructorNames` method), and one that does require a parameter (the `GetDepartmentsByAdministrator` method).</span></span> <span data-ttu-id="21b7f-203">Esses métodos como estão agora, na verdade, não precisam ser compilado porque eles não são consultas LINQ:</span><span class="sxs-lookup"><span data-stu-id="21b7f-203">These methods as they stand now actually don't need to be compiled because they aren't LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample6.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample7.cs)]

<span data-ttu-id="21b7f-204">No entanto, para que você pode experimentar consultas compiladas, você vai continuar como se esses tinham sido escritos como as consultas LINQ a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-204">However, so that you can try out compiled queries, you'll proceed as if these had been written as the following LINQ queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample8.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample9.cs)]

<span data-ttu-id="21b7f-205">Você pode alterar o código desses métodos que tem mostrado acima e execute o aplicativo para verificar se ele funciona antes de continuar.</span><span class="sxs-lookup"><span data-stu-id="21b7f-205">You could change the code in these methods to what's shown above and run the application to verify that it works before continuing.</span></span> <span data-ttu-id="21b7f-206">Mas as instruções a seguir ir diretamente para a criação de versões pré-compilado deles.</span><span class="sxs-lookup"><span data-stu-id="21b7f-206">But the following instructions jump right into creating pre-compiled versions of them.</span></span>

<span data-ttu-id="21b7f-207">Criar um arquivo de classe no *DAL* pasta, nomeie-o *SchoolEntities.cs*e substitua o código existente pelo seguinte código:</span><span class="sxs-lookup"><span data-stu-id="21b7f-207">Create a class file in the *DAL* folder, name it *SchoolEntities.cs*, and replace the existing code with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample10.cs)]

<span data-ttu-id="21b7f-208">Esse código cria uma classe parcial que estende a classe de contexto de objeto gerado automaticamente.</span><span class="sxs-lookup"><span data-stu-id="21b7f-208">This code creates a partial class that extends the automatically generated object context class.</span></span> <span data-ttu-id="21b7f-209">A classe parcial inclui duas consultas do LINQ compiladas usando o `Compile` método o `CompiledQuery` classe.</span><span class="sxs-lookup"><span data-stu-id="21b7f-209">The partial class includes two compiled LINQ queries using the `Compile` method of the `CompiledQuery` class.</span></span> <span data-ttu-id="21b7f-210">Ele também cria métodos que você pode usar para chamar as consultas.</span><span class="sxs-lookup"><span data-stu-id="21b7f-210">It also creates methods that you can use to call the queries.</span></span> <span data-ttu-id="21b7f-211">Salve e feche o arquivo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-211">Save and close this file.</span></span>

<span data-ttu-id="21b7f-212">Em seguida, na *SchoolRepository.cs*, alterar existente `GetInstructorNames` e `GetDepartmentsByAdministrator` métodos no repositório de classe para que eles chamam de consultas compiladas:</span><span class="sxs-lookup"><span data-stu-id="21b7f-212">Next, in *SchoolRepository.cs*, change the existing `GetInstructorNames` and `GetDepartmentsByAdministrator` methods in the repository class so that they call the compiled queries:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample11.cs)]

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample12.cs)]

<span data-ttu-id="21b7f-213">Execute o *Departments.aspx* página para verificar se ele funciona como antes.</span><span class="sxs-lookup"><span data-stu-id="21b7f-213">Run the *Departments.aspx* page to verify that it works as it did before.</span></span> <span data-ttu-id="21b7f-214">O `GetInstructorNames` método é chamado para preencher a lista suspensa de administrador e o `GetDepartmentsByAdministrator` método é chamado quando você clicar em **atualização** para verificar se nenhum instrutor é um administrador de mais de um departamento.</span><span class="sxs-lookup"><span data-stu-id="21b7f-214">The `GetInstructorNames` method is called in order to populate the administrator drop-down list, and the `GetDepartmentsByAdministrator` method is called when you click **Update** in order to verify that no instructor is an administrator of more than one department.</span></span>

<span data-ttu-id="21b7f-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-215">[![Image03](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image10.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image9.png)</span></span>

<span data-ttu-id="21b7f-216">Você tem consultas pré-compiladas no aplicativo Contoso University somente para ver como fazer isso, não porque ele seria, melhorar o desempenho.</span><span class="sxs-lookup"><span data-stu-id="21b7f-216">You've pre-compiled queries in the Contoso University application only to see how to do it, not because it would measurably improve performance.</span></span> <span data-ttu-id="21b7f-217">Pré-compilando consultas LINQ adicionar um nível de complexidade ao seu código, portanto certifique-se de que fazer isso apenas para consultas que realmente representam afunilamentos de desempenho em seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-217">Pre-compiling LINQ queries does add a level of complexity to your code, so make sure you do it only for queries that actually represent performance bottlenecks in your application.</span></span>

## <a name="examining-queries-sent-to-the-database"></a><span data-ttu-id="21b7f-218">Examinando as consultas enviadas ao banco de dados</span><span class="sxs-lookup"><span data-stu-id="21b7f-218">Examining Queries Sent to the Database</span></span>

<span data-ttu-id="21b7f-219">Quando você estiver investigando problemas de desempenho, às vezes é útil saber os comandos SQL exatos que está enviando o Entity Framework para o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-219">When you're investigating performance issues, sometimes it's helpful to know the exact SQL commands that the Entity Framework is sending to the database.</span></span> <span data-ttu-id="21b7f-220">Se você estiver trabalhando com um `IQueryable` do objeto, uma maneira de fazer isso é usar o `ToTraceString` método.</span><span class="sxs-lookup"><span data-stu-id="21b7f-220">If you're working with an `IQueryable` object, one way to do this is to use the `ToTraceString` method.</span></span>

<span data-ttu-id="21b7f-221">Em *SchoolRepository.cs*, altere o código no `GetDepartmentsByName` método para corresponder ao exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-221">In *SchoolRepository.cs*, change the code in the `GetDepartmentsByName` method to match the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample13.cs)]

<span data-ttu-id="21b7f-222">O `departments` variável deve ser convertida em um `ObjectQuery` tipo porque somente o `Where` método no final da linha anterior cria um `IQueryable` objeto; sem o `Where` método, a conversão não é necessária.</span><span class="sxs-lookup"><span data-stu-id="21b7f-222">The `departments` variable must be cast to an `ObjectQuery` type only because the `Where` method at the end of the preceding line creates an `IQueryable` object; without the `Where` method, the cast would not be necessary.</span></span>

<span data-ttu-id="21b7f-223">Defina um ponto de interrupção a `return` de linha e, em seguida, execute o *Departments.aspx* página no depurador.</span><span class="sxs-lookup"><span data-stu-id="21b7f-223">Set a breakpoint on the `return` line, and then run the *Departments.aspx* page in the debugger.</span></span> <span data-ttu-id="21b7f-224">Quando você atinge o ponto de interrupção, examine o `commandText` variável o **locais** janela e use o Visualizador de texto (na Lupa no **valor** coluna) para exibir seu valor no **Visualizador de texto** janela.</span><span class="sxs-lookup"><span data-stu-id="21b7f-224">When you hit the breakpoint, examine the `commandText` variable in the **Locals** window and use the text visualizer (the magnifying glass in the **Value** column) to display its value in the **Text Visualizer** window.</span></span> <span data-ttu-id="21b7f-225">Você pode ver o comando SQL inteiro resultante este código:</span><span class="sxs-lookup"><span data-stu-id="21b7f-225">You can see the entire SQL command that results from this code:</span></span>

<span data-ttu-id="21b7f-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-226">[![Image08](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image12.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image11.png)</span></span>

<span data-ttu-id="21b7f-227">Como alternativa, o recurso IntelliTrace no Visual Studio Ultimate fornece uma maneira de exibir comandos SQL gerados pelo Entity Framework que não exigem que você altere seu código ou até mesmo definir um ponto de interrupção.</span><span class="sxs-lookup"><span data-stu-id="21b7f-227">As an alternative, the IntelliTrace feature in Visual Studio Ultimate provides a way to view SQL commands generated by the Entity Framework that doesn't require you to change your code or even set a breakpoint.</span></span>

> [!NOTE]
> <span data-ttu-id="21b7f-228">Você pode executar os procedimentos a seguir somente se você tiver o Visual Studio Ultimate.</span><span class="sxs-lookup"><span data-stu-id="21b7f-228">You can perform the following procedures only if you have Visual Studio Ultimate.</span></span>


<span data-ttu-id="21b7f-229">Restaurar o código original no `GetDepartmentsByName` método e, em seguida, execute o *Departments.aspx* página no depurador.</span><span class="sxs-lookup"><span data-stu-id="21b7f-229">Restore the original code in the `GetDepartmentsByName` method, and then run the *Departments.aspx* page in the debugger.</span></span>

<span data-ttu-id="21b7f-230">No Visual Studio, selecione o **depurar** menu, em seguida, **IntelliTrace**e, em seguida, **eventos do IntelliTrace**.</span><span class="sxs-lookup"><span data-stu-id="21b7f-230">In Visual Studio, select the **Debug** menu, then **IntelliTrace**, and then **IntelliTrace Events**.</span></span>

<span data-ttu-id="21b7f-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-231">[![Image11](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image14.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image13.png)</span></span>

<span data-ttu-id="21b7f-232">No **IntelliTrace** janela, clique em **interromper tudo**.</span><span class="sxs-lookup"><span data-stu-id="21b7f-232">In the **IntelliTrace** window, click **Break All**.</span></span>

<span data-ttu-id="21b7f-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-233">[![Image12](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image16.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image15.png)</span></span>

<span data-ttu-id="21b7f-234">O **IntelliTrace** janela exibe uma lista de eventos recentes:</span><span class="sxs-lookup"><span data-stu-id="21b7f-234">The **IntelliTrace** window displays a list of recent events:</span></span>

<span data-ttu-id="21b7f-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-235">[![Image09](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image18.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image17.png)</span></span>

<span data-ttu-id="21b7f-236">Clique o **ADO.NET** linha.</span><span class="sxs-lookup"><span data-stu-id="21b7f-236">Click the **ADO.NET** line.</span></span> <span data-ttu-id="21b7f-237">Expande para mostrar o texto do comando:</span><span class="sxs-lookup"><span data-stu-id="21b7f-237">It expands to show you the command text:</span></span>

<span data-ttu-id="21b7f-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-238">[![Image10](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image20.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image19.png)</span></span>

<span data-ttu-id="21b7f-239">Você pode copiar a cadeia de caracteres de texto de comando inteiro para a área de transferência do **locais** janela.</span><span class="sxs-lookup"><span data-stu-id="21b7f-239">You can copy the entire command text string to the clipboard from the **Locals** window.</span></span>

<span data-ttu-id="21b7f-240">Suponha que você estava trabalhando com um banco de dados com mais tabelas, relações e colunas que simples `School` banco de dados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-240">Suppose you were working with a database with more tables, relationships, and columns than the simple `School` database.</span></span> <span data-ttu-id="21b7f-241">Você pode achar que uma consulta que reúne todas as informações que você precisa em um único `Select` instrução contendo várias `Join` cláusulas torna-se muito complexo para trabalhar com eficiência.</span><span class="sxs-lookup"><span data-stu-id="21b7f-241">You might find that a query that gathers all the information you need in a single `Select` statement containing multiple `Join` clauses becomes too complex to work efficiently.</span></span> <span data-ttu-id="21b7f-242">Nesse caso, você pode alternar de carregamento para carregamento explícito para simplificar a consulta rápido.</span><span class="sxs-lookup"><span data-stu-id="21b7f-242">In that case you can switch from eager loading to explicit loading to simplify the query.</span></span>

<span data-ttu-id="21b7f-243">Por exemplo, tente alterar o código de `GetDepartmentsByName` método *SchoolRepository.cs*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-243">For example, try changing the code in the `GetDepartmentsByName` method in *SchoolRepository.cs*.</span></span> <span data-ttu-id="21b7f-244">No momento em que método você tem uma consulta de objeto que tem `Include` métodos para o `Person` e `Courses` propriedades de navegação.</span><span class="sxs-lookup"><span data-stu-id="21b7f-244">Currently in that method you have an object query that has `Include` methods for the `Person` and `Courses` navigation properties.</span></span> <span data-ttu-id="21b7f-245">Substitua o `return` instrução com o código que executa o carregamento explícito, conforme mostrado no exemplo a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-245">Replace the `return` statement with code that performs explicit loading, as shown in the following example:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample14.cs)]

<span data-ttu-id="21b7f-246">Execute o *Departments.aspx* página no depurador e verifique o **IntelliTrace** janela novamente como você fez antes.</span><span class="sxs-lookup"><span data-stu-id="21b7f-246">Run the *Departments.aspx* page in the debugger and check the **IntelliTrace** window again as you did before.</span></span> <span data-ttu-id="21b7f-247">Agora, em que houve uma única consulta antes, você verá uma sequência longa de-los.</span><span class="sxs-lookup"><span data-stu-id="21b7f-247">Now, where there was a single query before, you see a long sequence of them.</span></span>

<span data-ttu-id="21b7f-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-248">[![Image13](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image22.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image21.png)</span></span>

<span data-ttu-id="21b7f-249">Clique no primeiro **ADO.NET** linha para ver o que aconteceu com a consulta complexa é visualizado anteriormente.</span><span class="sxs-lookup"><span data-stu-id="21b7f-249">Click the first **ADO.NET** line to see what has happened to the complex query you viewed earlier.</span></span>

<span data-ttu-id="21b7f-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-250">[![Image14](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image24.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image23.png)</span></span>

<span data-ttu-id="21b7f-251">A consulta de departamentos se tornou um simples `Select` consulta sem nenhum `Join` cláusula, mas ele é seguido por consultas separadas que recuperam cursos relacionados e um administrador, usando um conjunto de duas consultas para cada departamento retornado pelo original consulta.</span><span class="sxs-lookup"><span data-stu-id="21b7f-251">The query from Departments has become a simple `Select` query with no `Join` clause, but it's followed by separate queries that retrieve related courses and an administrator, using a set of two queries for each department returned by the original query.</span></span>

> [!NOTE]
> <span data-ttu-id="21b7f-252">Se você deixar lento carregamento habilitado, o padrão que você vê aqui, com a mesma consulta repetida várias vezes, pode resultar de carregamento lento.</span><span class="sxs-lookup"><span data-stu-id="21b7f-252">If you leave lazy loading enabled, the pattern you see here, with the same query repeated many times, might result from lazy loading.</span></span> <span data-ttu-id="21b7f-253">Um padrão que você geralmente deseja evitar é dados relacionados de carregamento lento para cada linha da tabela primária.</span><span class="sxs-lookup"><span data-stu-id="21b7f-253">A pattern that you typically want to avoid is lazy-loading related data for every row of the primary table.</span></span> <span data-ttu-id="21b7f-254">A menos que você verificou que uma consulta de junção único é muito complexa para ser eficiente, normalmente seria capaz de melhorar o desempenho em tais casos, alterando a consulta principal para usar o carregamento rápido.</span><span class="sxs-lookup"><span data-stu-id="21b7f-254">Unless you've verified that a single join query is too complex to be efficient, you'd typically be able to improve performance in such cases by changing the primary query to use eager loading.</span></span>


## <a name="pre-generating-views"></a><span data-ttu-id="21b7f-255">Pré-geração de modos de exibição</span><span class="sxs-lookup"><span data-stu-id="21b7f-255">Pre-Generating Views</span></span>

<span data-ttu-id="21b7f-256">Quando um `ObjectContext` objeto é criado pela primeira vez em um novo domínio de aplicativo, o Entity Framework gera um conjunto de classes que ele usa para acessar o banco de dados.</span><span class="sxs-lookup"><span data-stu-id="21b7f-256">When an `ObjectContext` object is first created in a new application domain, the Entity Framework generates a set of classes that it uses to access the database.</span></span> <span data-ttu-id="21b7f-257">Essas classes são chamadas *exibições*, e se você tiver um modelo de dados muito grandes, gerando esses modos de exibição pode atrasar a resposta do site da web para a primeira solicitação para uma página depois que um novo domínio de aplicativo é inicializado.</span><span class="sxs-lookup"><span data-stu-id="21b7f-257">These classes are called *views*, and if you have a very large data model, generating these views can delay the web site's response to the first request for a page after a new application domain is initialized.</span></span> <span data-ttu-id="21b7f-258">Você pode reduzir esse atraso da primeira solicitação criando os modos de exibição em tempo de compilação em vez de em tempo de execução.</span><span class="sxs-lookup"><span data-stu-id="21b7f-258">You can reduce this first-request delay by creating the views at compile time rather than at run time.</span></span>

> [!NOTE]
> <span data-ttu-id="21b7f-259">Se seu aplicativo não tiver um modelo de dados muito grande, ou se ele tem um modelo de dados grandes, mas você não estiver preocupado com um problema de desempenho que afeta apenas a primeira solicitação de página depois que o IIS é reciclado, você poderá ignorar esta seção.</span><span class="sxs-lookup"><span data-stu-id="21b7f-259">If your application doesn't have an extremely large data model, or if it does have a large data model but you aren't concerned about a performance problem that affects only the very first page request after IIS is recycled, you can skip this section.</span></span> <span data-ttu-id="21b7f-260">Exibição de criação não acontece sempre que você criar uma instância de um `ObjectContext` o objeto, pois os modos de exibição são armazenados em cache no domínio do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-260">View creation doesn't happen every time you instantiate an `ObjectContext` object, because the views are cached in the application domain.</span></span> <span data-ttu-id="21b7f-261">Portanto, a menos que você está frequentemente reciclagem de seu aplicativo no IIS, poucas solicitações de páginas pode se beneficiar do exibições pré-geradas.</span><span class="sxs-lookup"><span data-stu-id="21b7f-261">Therefore, unless you're frequently recycling your application in IIS, very few page requests would benefit from pre-generated views.</span></span>


<span data-ttu-id="21b7f-262">Pré-você pode gerar exibições usando o *EdmGen.exe* ferramenta de linha de comando ou usando um *Text Template Transformation Toolkit* modelo (T4).</span><span class="sxs-lookup"><span data-stu-id="21b7f-262">You can pre-generate views using the *EdmGen.exe* command-line tool or by using a *Text Template Transformation Toolkit* (T4) template.</span></span> <span data-ttu-id="21b7f-263">Neste tutorial, você usará um modelo T4.</span><span class="sxs-lookup"><span data-stu-id="21b7f-263">In this tutorial you'll use a T4 template.</span></span>

<span data-ttu-id="21b7f-264">No *DAL* pasta, adicionar um arquivo usando o **modelo de texto** modelo (está sob o **geral** nó o **modelos instalados** lista), e nomeie-o *SchoolModel.Views.tt*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-264">In the *DAL* folder, add a file using the **Text Template** template (it's under the **General** node in the **Installed Templates** list), and name it *SchoolModel.Views.tt*.</span></span> <span data-ttu-id="21b7f-265">Substitua o código existente no arquivo com o código a seguir:</span><span class="sxs-lookup"><span data-stu-id="21b7f-265">Replace the existing code in the file with the following code:</span></span>

[!code-csharp[Main](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/samples/sample15.cs)]

<span data-ttu-id="21b7f-266">Esse código gera os modos de exibição para um *. edmx* arquivo que está localizado na mesma pasta que o modelo e que tem o mesmo nome do arquivo de modelo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-266">This code generates views for an *.edmx* file that's located in the same folder as the template and that has the same name as the template file.</span></span> <span data-ttu-id="21b7f-267">Por exemplo, se o arquivo de modelo é denominado *SchoolModel.Views.tt*, ela procurará um arquivo de modelo de dados chamado *SchoolModel.edmx*.</span><span class="sxs-lookup"><span data-stu-id="21b7f-267">For example, if your template file is named *SchoolModel.Views.tt*, it will look for a data model file named *SchoolModel.edmx*.</span></span>

<span data-ttu-id="21b7f-268">Salve o arquivo, em seguida, clique no arquivo em **Solution Explorer** e selecione **executar personalizado ferramenta**.</span><span class="sxs-lookup"><span data-stu-id="21b7f-268">Save the file, then right-click the file in **Solution Explorer** and select **Run Custom Tool**.</span></span>

<span data-ttu-id="21b7f-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-269">[![Image02](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image26.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image25.png)</span></span>

<span data-ttu-id="21b7f-270">O Visual Studio gera um arquivo de código que cria os modos de exibição, que é chamado de *SchoolModel.Views.cs* com base no modelo.</span><span class="sxs-lookup"><span data-stu-id="21b7f-270">Visual Studio generates a code file that creates the views, which is named *SchoolModel.Views.cs* based on the template.</span></span> <span data-ttu-id="21b7f-271">(Você deve ter notado que o arquivo de código é gerado, mesmo antes de selecionar **executar personalizado ferramenta**, assim que você salvar o arquivo de modelo.)</span><span class="sxs-lookup"><span data-stu-id="21b7f-271">(You might have noticed that the code file is generated even before you select **Run Custom Tool**, as soon as you save the template file.)</span></span>

<span data-ttu-id="21b7f-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span><span class="sxs-lookup"><span data-stu-id="21b7f-272">[![Image01](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image28.png)](maximizing-performance-with-the-entity-framework-in-an-asp-net-web-application/_static/image27.png)</span></span>

<span data-ttu-id="21b7f-273">Agora você pode executar o aplicativo e verificar se ela funciona como antes.</span><span class="sxs-lookup"><span data-stu-id="21b7f-273">You can now run the application and verify that it works as it did before.</span></span>

<span data-ttu-id="21b7f-274">Para obter mais informações sobre modos de exibição pré-gerados, consulte os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="21b7f-274">For more information about pre-generated views, see the following resources:</span></span>

- <span data-ttu-id="21b7f-275">[Como: gerar previamente exibições para melhorar o desempenho da consulta](https://msdn.microsoft.com/library/bb896240.aspx) no site do MSDN.</span><span class="sxs-lookup"><span data-stu-id="21b7f-275">[How to: Pre-Generate Views to Improve Query Performance](https://msdn.microsoft.com/library/bb896240.aspx) on the MSDN web site.</span></span> <span data-ttu-id="21b7f-276">Explica como usar o `EdmGen.exe` ferramenta de linha de comando para gerar previamente modos de exibição.</span><span class="sxs-lookup"><span data-stu-id="21b7f-276">Explains how to use the `EdmGen.exe` command-line tool to pre-generate views.</span></span>
- <span data-ttu-id="21b7f-277">[Isolamento de desempenho com pré-compilado/pré-generated exibições no Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) no blog da equipe de consultoria do Windows Server AppFabric ao cliente.</span><span class="sxs-lookup"><span data-stu-id="21b7f-277">[Isolating Performance with Precompiled/Pre-generated Views in the Entity Framework 4](https://blogs.msdn.com/b/appfabriccat/archive/2010/08/06/isolating-performance-with-precompiled-pre-generated-views-in-the-entity-framework-4.aspx) on the Windows Server AppFabric Customer Advisory Team blog.</span></span>

<span data-ttu-id="21b7f-278">Isso conclui a introdução para melhorar o desempenho de um aplicativo web ASP.NET que usa o Entity Framework.</span><span class="sxs-lookup"><span data-stu-id="21b7f-278">This completes the introduction to improving performance in an ASP.NET web application that uses the Entity Framework.</span></span> <span data-ttu-id="21b7f-279">Para obter mais informações, consulte os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="21b7f-279">For more information, see the following resources:</span></span>

- <span data-ttu-id="21b7f-280">[Considerações de desempenho (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) no site do MSDN.</span><span class="sxs-lookup"><span data-stu-id="21b7f-280">[Performance Considerations (Entity Framework)](https://msdn.microsoft.com/library/cc853327.aspx) on the MSDN web site.</span></span>
- <span data-ttu-id="21b7f-281">[Relacionados ao desempenho postagens no blog da equipe do Entity Framework](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span><span class="sxs-lookup"><span data-stu-id="21b7f-281">[Performance-related posts on the Entity Framework Team blog](https://blogs.msdn.com/b/adonet/archive/tags/performance/).</span></span>
- <span data-ttu-id="21b7f-282">[EF mesclagem opções e consultas compiladas](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span><span class="sxs-lookup"><span data-stu-id="21b7f-282">[EF Merge Options and Compiled Queries](https://blogs.msdn.com/b/dsimmons/archive/2010/01/12/ef-merge-options-and-compiled-queries.aspx).</span></span> <span data-ttu-id="21b7f-283">Postagem do blog que explica os comportamentos inesperados de consultas compiladas e mesclagem opções como `NoTracking`.</span><span class="sxs-lookup"><span data-stu-id="21b7f-283">Blog post that explains unexpected behaviors of compiled queries and merge options such as `NoTracking`.</span></span> <span data-ttu-id="21b7f-284">Se você planeja usar consultas compiladas ou manipular as configurações de opção de mesclagem em seu aplicativo, leia primeiro.</span><span class="sxs-lookup"><span data-stu-id="21b7f-284">If you plan to use compiled queries or manipulate merge option settings in your application, read this first.</span></span>
- <span data-ttu-id="21b7f-285">[Postagens no blog de dados e modelagem a equipe de consultoria do cliente no Entity Framework relacionadas](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span><span class="sxs-lookup"><span data-stu-id="21b7f-285">[Entity Framework-related posts in the Data and Modeling Customer Advisory Team blog](https://blogs.msdn.com/b/dmcat/archive/tags/entity+framework/).</span></span> <span data-ttu-id="21b7f-286">Inclui postagens em consultas compiladas e usando o Visual Studio 2010 Profiler para descobrir problemas de desempenho.</span><span class="sxs-lookup"><span data-stu-id="21b7f-286">Includes posts on compiled queries and using the Visual Studio 2010 Profiler to discover performance issues.</span></span>
- <span data-ttu-id="21b7f-287">[Thread do Fórum do Entity Framework com avisos sobre como melhorar o desempenho de consultas complexas altamente](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span><span class="sxs-lookup"><span data-stu-id="21b7f-287">[Entity Framework forum thread with advice on improving performance of highly complex queries](https://social.msdn.microsoft.com/Forums/adodotnetentityframework/thread/ffe8b2ab-c5b5-4331-8988-33a872d0b5f6).</span></span>
- <span data-ttu-id="21b7f-288">[Recomendações de gerenciamento de estado do ASP.NET](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span><span class="sxs-lookup"><span data-stu-id="21b7f-288">[ASP.NET State Management Recommendations](https://msdn.microsoft.com/library/z1hkazw7.aspx).</span></span>
- <span data-ttu-id="21b7f-289">[Usando o Entity Framework e o ObjectDataSource: paginação personalizada](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span><span class="sxs-lookup"><span data-stu-id="21b7f-289">[Using the Entity Framework and the ObjectDataSource: Custom Paging](http://geekswithblogs.net/Frez/articles/using-the-entity-framework-and-the-objectdatasource-custom-paging.aspx).</span></span> <span data-ttu-id="21b7f-290">Postagem do blog que se baseia no aplicativo ContosoUniversity criado nos tutoriais para explicar como implementar a paginação no *Departments.aspx* página.</span><span class="sxs-lookup"><span data-stu-id="21b7f-290">Blog post that builds on the ContosoUniversity application created in these tutorials to explain how to implement paging in the *Departments.aspx* page.</span></span>

<span data-ttu-id="21b7f-291">O seguinte tutorial examina alguns dos aprimoramentos importantes para o Entity Framework que são novos na versão 4.</span><span class="sxs-lookup"><span data-stu-id="21b7f-291">The next tutorial reviews some of the important enhancements to the Entity Framework that are new in version 4.</span></span>

> [!div class="step-by-step"]
> <span data-ttu-id="21b7f-292">[Anterior](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
> [Próximo](what-s-new-in-the-entity-framework-4.md)</span><span class="sxs-lookup"><span data-stu-id="21b7f-292">[Previous](handling-concurrency-with-the-entity-framework-in-an-asp-net-web-application.md)
[Next](what-s-new-in-the-entity-framework-4.md)</span></span>
