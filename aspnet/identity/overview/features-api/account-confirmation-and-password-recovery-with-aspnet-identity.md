---
uid: identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
title: Confirmação de conta e recuperação de senha com a identidade do ASP.NET (c#) | Microsoft Docs
author: HaoK
description: Antes de fazer este tutorial, que você deve concluir primeiro crie um aplicativo de web do ASP.NET MVC 5 seguro com logon, redefinição de senha e de confirmação de email. Este tutorial...
ms.author: aspnetcontent
ms.date: 03/26/2015
ms.assetid: 8d54180d-f826-4df7-b503-7debf5ed9fb3
msc.legacyurl: /identity/overview/features-api/account-confirmation-and-password-recovery-with-aspnet-identity
msc.type: authoredcontent
ms.openlocfilehash: 08a954f8fab4a92b84bd79b4f644bcc1f55b1bc6
ms.sourcegitcommit: b28cd0313af316c051c2ff8549865bff67f2fbb4
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 07/05/2018
ms.locfileid: "37831077"
---
<a name="account-confirmation-and-password-recovery-with-aspnet-identity-c"></a><span data-ttu-id="d9ae3-104">Confirmação de conta e recuperação de senha com a identidade do ASP.NET (c#)</span><span class="sxs-lookup"><span data-stu-id="d9ae3-104">Account Confirmation and Password Recovery with ASP.NET Identity (C#)</span></span>
====================
<span data-ttu-id="d9ae3-105">por [Kung Hao](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span><span class="sxs-lookup"><span data-stu-id="d9ae3-105">by [Hao Kung](https://github.com/HaoK), [Pranav Rastogi](https://github.com/rustd), [Rick Anderson](https://github.com/Rick-Anderson), [Suhas Joshi](https://github.com/suhasj)</span></span>

> <span data-ttu-id="d9ae3-106">Antes de fazer este tutorial você deve primeiro concluir [criar um aplicativo de web do ASP.NET MVC 5 seguro com logon, redefinição de senha e de confirmação de email](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-106">Before doing this tutorial you should first complete [Create a secure ASP.NET MVC 5 web app with log in, email confirmation and password reset](../../../mvc/overview/security/create-an-aspnet-mvc-5-web-app-with-email-confirmation-and-password-reset.md).</span></span> <span data-ttu-id="d9ae3-107">Este tutorial contém mais detalhes e mostrará a você como configurar o email de confirmação de conta local e permitir que os usuários a redefinir sua senha esquecida no ASP.NET Identity.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-107">This tutorial contains more details and will show you how to set up email for local account confirmation and allow users to reset their forgotten password in ASP.NET Identity.</span></span> <span data-ttu-id="d9ae3-108">Este artigo foi escrito por Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung e Suhas Joshi.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-108">This article was written by Rick Anderson ([@RickAndMSFT](https://twitter.com/#!/RickAndMSFT)), Pranav Rastogi ([@rustd](https://twitter.com/rustd)), Hao Kung, and Suhas Joshi.</span></span> <span data-ttu-id="d9ae3-109">O exemplo do NuGet foi escrito principalmente por Hao Kung.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-109">The NuGet sample was written primarily by Hao Kung.</span></span>


<span data-ttu-id="d9ae3-110">Uma conta de usuário local requer que o usuário crie uma senha para a conta e senha é armazenada (com segurança) no aplicativo web.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-110">A local user account requires the user to create a password for the account, and that password is stored (securely) in the web app.</span></span> <span data-ttu-id="d9ae3-111">Identidade do ASP.NET também dá suporte a contas sociais, que não exigem que o usuário crie uma senha para o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-111">ASP.NET Identity also supports social accounts, which don't require the user to create a password for the app.</span></span> <span data-ttu-id="d9ae3-112">[Contas sociais](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) usam um terceiro (por exemplo, Google, Twitter, Facebook ou Microsoft) para autenticar usuários.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-112">[Social accounts](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) use a third party (such as Google, Twitter, Facebook or Microsoft) to authenticate users.</span></span> <span data-ttu-id="d9ae3-113">Este tópico aborda o seguinte:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-113">This topic covers the following:</span></span>

- <span data-ttu-id="d9ae3-114">[Criar um aplicativo ASP.NET MVC](#createMvc) e explorar os recursos de identidade do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-114">[Create an ASP.NET MVC app](#createMvc) and explore ASP.NET Identity features.</span></span>
- [<span data-ttu-id="d9ae3-115">Compilando o exemplo de identidade</span><span class="sxs-lookup"><span data-stu-id="d9ae3-115">Building the Identity sample</span></span>](#build)
- [<span data-ttu-id="d9ae3-116">Configurar o email de confirmação</span><span class="sxs-lookup"><span data-stu-id="d9ae3-116">Set up email confirmation</span></span>](#email)

<span data-ttu-id="d9ae3-117">Novos usuários se registram seu alias de email, que cria uma conta local.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-117">New users register their email alias, which creates a local account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image1.png)

<span data-ttu-id="d9ae3-118">Clicar no botão registrar envia um email de confirmação que contém um token de validação para o seu endereço de email.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-118">Clicking the Register button sends a confirmation email containing a validation token to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image2.png)

<span data-ttu-id="d9ae3-119">O usuário é enviado um email com um token de confirmação para sua conta.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-119">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image3.png)

<span data-ttu-id="d9ae3-120">Ao clicar no link confirma a conta.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-120">Clicking the link confirms the account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image4.png)

<a id="passwordReset"></a>

## <a name="password-recoveryreset"></a><span data-ttu-id="d9ae3-121">Recuperação/redefinição de senha</span><span class="sxs-lookup"><span data-stu-id="d9ae3-121">Password recovery/reset</span></span>

<span data-ttu-id="d9ae3-122">Usuários locais que esquecem a senha podem ter um token de segurança enviado para a conta de email, habilitá-los a redefinir sua senha.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-122">Local users who forget their password can have a security token sent to their email account, enabling them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image5.png)  
  
<span data-ttu-id="d9ae3-123">O usuário receberá em breve um email com um link, permitindo que eles redefinam sua senha.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-123">The user will soon get an email with a link allowing them to reset their password.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image6.png)  
<span data-ttu-id="d9ae3-124">Ao clicar no link vai levá-los para a página de redefinição.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-124">Clicking the link will take them to the Reset page.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image7.png)  
  
<span data-ttu-id="d9ae3-125">Clicar a **redefinir** botão confirmará a senha foi redefinida.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-125">Clicking the **Reset** button will confirm the password has been reset.</span></span>  
  
![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image8.png)

<a id="createMvc"></a>

## <a name="create-an-aspnet-web-app"></a><span data-ttu-id="d9ae3-126">Criar um aplicativo Web do ASP.NET</span><span class="sxs-lookup"><span data-stu-id="d9ae3-126">Create an ASP.NET Web app</span></span>

<span data-ttu-id="d9ae3-127">Comece instalando e executando [Visual Studio Express 2013 para Web](https://go.microsoft.com/fwlink/?LinkId=299058) ou [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-127">Start by installing and running [Visual Studio Express 2013 for Web](https://go.microsoft.com/fwlink/?LinkId=299058) or [Visual Studio 2013](https://go.microsoft.com/fwlink/?LinkId=306566).</span></span> <span data-ttu-id="d9ae3-128">Instalar o Visual Studio [2013 atualização 2](https://go.microsoft.com/fwlink/?LinkId=390521) ou superior.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-128">Install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) or higher.</span></span>

> [!NOTE]
> <span data-ttu-id="d9ae3-129">Aviso: Você deve instalar o Visual Studio [2013 atualização 2](https://go.microsoft.com/fwlink/?LinkId=390521) para concluir este tutorial.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-129">Warning: You must install Visual Studio [2013 Update 2](https://go.microsoft.com/fwlink/?LinkId=390521) to complete this tutorial.</span></span>


1. <span data-ttu-id="d9ae3-130">Crie um novo projeto da Web do ASP.NET e selecione o modelo MVC.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-130">Create a new ASP.NET Web project and select the MVC template.</span></span> <span data-ttu-id="d9ae3-131">Web Forms também oferece suporte a identidade do ASP.NET, você pode seguir etapas semelhantes em um aplicativo de formulários da web.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-131">Web Forms also supports ASP.NET Identity, so you could follow similar steps in a web forms app.</span></span>
2. <span data-ttu-id="d9ae3-132">Deixe a autenticação padrão como **contas de usuário individuais**.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-132">Leave the default authentication as **Individual User Accounts**.</span></span>
3. <span data-ttu-id="d9ae3-133">Execute o aplicativo, clique no **registrar** vincular e registrar um usuário.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-133">Run the app, click the **Register** link and register a user.</span></span> <span data-ttu-id="d9ae3-134">Neste ponto, a validação apenas no email é com o [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) atributo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-134">At this point, the only validation on the email is with the [[EmailAddress]](https://msdn.microsoft.com/library/system.componentmodel.dataannotations.emailaddressattribute(v=vs.110).aspx) attribute.</span></span>
4. <span data-ttu-id="d9ae3-135">No Server Explorer, navegue até **dados Connections\DefaultConnection\Tables\AspNetUsers**, clique com o botão direito e selecione **abrir definição de tabela**.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-135">In Server Explorer, navigate to **Data Connections\DefaultConnection\Tables\AspNetUsers**, right click and select **Open table definition**.</span></span>

    <span data-ttu-id="d9ae3-136">A imagem a seguir mostra o `AspNetUsers` esquema:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-136">The following image shows the `AspNetUsers` schema:</span></span>

    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image9.png)
5. <span data-ttu-id="d9ae3-137">Clique com botão direito do **AspNetUsers** de tabela e selecione **Mostrar dados da tabela**.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-137">Right click on the **AspNetUsers** table and select **Show Table Data**.</span></span>  
  
    ![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image10.png)  
  
   <span data-ttu-id="d9ae3-138">Neste ponto o email não foi confirmado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-138">At this point the email has not been confirmed.</span></span>

<span data-ttu-id="d9ae3-139">O armazenamento de dados padrão para a identidade do ASP.NET é o Entity Framework, mas você pode configurá-lo para usar outros armazenamentos de dados e adicionar outros campos.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-139">The default data store for ASP.NET Identity is Entity Framework, but you can configure it to use other data stores and to add additional fields.</span></span> <span data-ttu-id="d9ae3-140">Ver [recursos adicionais](#addRes) seção no final deste tutorial.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-140">See [Additional Resources](#addRes) section at the end of this tutorial.</span></span>

<span data-ttu-id="d9ae3-141">O [classe de inicialização OWIN](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) é chamado quando o aplicativo é iniciado e invoca o `ConfigureAuth` método na *aplicativo\_Start\Startup.Auth.cs*, que configura o pipeline do OWIN e inicializa a identidade do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-141">The [OWIN startup class](../../../aspnet/overview/owin-and-katana/owin-startup-class-detection.md) ( *Startup.cs* ) is called when the app starts and invokes the `ConfigureAuth` method in *App\_Start\Startup.Auth.cs*, which configures the OWIN pipeline and initializes ASP.NET Identity.</span></span> <span data-ttu-id="d9ae3-142">Examine o método `ConfigureAuth`.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-142">Examine the `ConfigureAuth` method.</span></span> <span data-ttu-id="d9ae3-143">Cada `CreatePerOwinContext` chamada registra um retorno de chamada (salvo no `OwinContext`) que será chamado uma vez por solicitação para criar uma instância do tipo especificado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-143">Each `CreatePerOwinContext` call registers a callback (saved in the `OwinContext`) that will be called once per request to create an instance of the specified type.</span></span> <span data-ttu-id="d9ae3-144">Você pode definir um ponto de interrupção no construtor e `Create` método de cada tipo (`ApplicationDbContext, ApplicationUserManager`) e verifique se eles são chamados em cada solicitação.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-144">You can set a break point in the constructor and `Create` method of each type (`ApplicationDbContext, ApplicationUserManager`) and verify they are called on each request.</span></span> <span data-ttu-id="d9ae3-145">Uma instância do `ApplicationDbContext` e `ApplicationUserManager` é armazenado no contexto OWIN, que pode ser acessado em todo o aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-145">A instance of `ApplicationDbContext` and `ApplicationUserManager` is stored in the OWIN context, which can be accessed throughout the application.</span></span> <span data-ttu-id="d9ae3-146">Ganchos de identidade do ASP.NET no pipeline OWIN por meio do middleware de cookie.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-146">ASP.NET Identity hooks into the OWIN pipeline through cookie middleware.</span></span> <span data-ttu-id="d9ae3-147">Para obter mais informações, consulte [por gerenciamento de tempo de vida de solicitação para a classe UserManager no ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-147">For more information, see [Per request lifetime management for UserManager class in ASP.NET Identity](https://blogs.msdn.com/b/webdev/archive/2014/02/12/per-request-lifetime-management-for-usermanager-class-in-asp-net-identity.aspx).</span></span>

<span data-ttu-id="d9ae3-148">Quando você altera seu perfil de segurança, um novo carimbo de segurança é gerado e armazenado na `SecurityStamp` campo do *AspNetUsers* tabela.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-148">When you change your security profile, a new security stamp is generated and stored in the `SecurityStamp` field of the *AspNetUsers* table.</span></span> <span data-ttu-id="d9ae3-149">Observe que o `SecurityStamp` campo é diferente do que o cookie de segurança.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-149">Note, the `SecurityStamp` field is different from the security cookie.</span></span> <span data-ttu-id="d9ae3-150">O cookie de segurança não é armazenado no `AspNetUsers` tabela (ou qualquer outro lugar no banco de dados de identidade).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-150">The security cookie is not stored in the `AspNetUsers` table (or anywhere else in the Identity DB).</span></span> <span data-ttu-id="d9ae3-151">O token de cookie de segurança é autoassinado usando [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) e é criado com o `UserId, SecurityStamp` e informações de tempo de expiração.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-151">The security cookie token is self-signed using [DPAPI](https://msdn.microsoft.com/library/system.security.cryptography.protecteddata.aspx) and is created with the `UserId, SecurityStamp` and expiration time information.</span></span>

<span data-ttu-id="d9ae3-152">O middleware de cookie verifica o cookie em cada solicitação.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-152">The cookie middleware checks the cookie on each request.</span></span> <span data-ttu-id="d9ae3-153">O `SecurityStampValidator` método na `Startup` classe atinge o BD e verifica periodicamente, o carimbo de segurança conforme especificado com o `validateInterval`.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-153">The `SecurityStampValidator` method in the `Startup` class hits the DB and checks security stamp periodically, as specified with the `validateInterval`.</span></span> <span data-ttu-id="d9ae3-154">Isso ocorre apenas a cada 30 minutos (em nosso exemplo), a menos que você altere seu perfil de segurança.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-154">This only happens every 30 minutes (in our sample) unless you change your security profile.</span></span> <span data-ttu-id="d9ae3-155">O intervalo de 30 minutos foi escolhido para minimizar as viagens ao banco de dados.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-155">The 30 minute interval was chosen to minimize trips to the database.</span></span> <span data-ttu-id="d9ae3-156">Consulte minha [tutorial de autenticação de dois fatores](index.md) para obter mais detalhes.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-156">See my [two-factor authentication tutorial](index.md) for more details.</span></span>

<span data-ttu-id="d9ae3-157">Por que os comentários no código, o `UseCookieAuthentication` método dá suporte à autenticação de cookie.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-157">Per the comments in the code, the `UseCookieAuthentication` method supports cookie authentication.</span></span> <span data-ttu-id="d9ae3-158">O `SecurityStamp` associado e campo de código fornece uma camada extra de segurança ao seu aplicativo, quando você altera sua senha, você será conectado fora do navegador com você fez logon.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-158">The `SecurityStamp` field and associated code provides an extra layer of security to your app, when you change your password, you will be logged out of the browser you logged in with.</span></span> <span data-ttu-id="d9ae3-159">O `SecurityStampValidator.OnValidateIdentity` método permite que o aplicativo validar o token de segurança quando o usuário fizer logon, que é usado quando você altera uma senha ou usa o logon externo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-159">The `SecurityStampValidator.OnValidateIdentity` method enables the app to validate the security token when the user logs in, which is used when you change a password or use the external login.</span></span> <span data-ttu-id="d9ae3-160">Isso é necessário para garantir que todos os tokens (cookies) gerados com a senha antiga são invalidados.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-160">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="d9ae3-161">No projeto de exemplo, se você alterar a senha do usuário, em seguida, um novo token é gerada para o usuário, todos os tokens anteriores serão invalidados e o `SecurityStamp` campo é atualizado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-161">In the sample project, if you change the users password then a new token is generated for the user, any previous tokens are invalidated and the `SecurityStamp` field is updated.</span></span>

<span data-ttu-id="d9ae3-162">O sistema de identidade permitem que você configure seu aplicativo isso quando o perfil de segurança de usuários é alterado (por exemplo, quando o usuário altera sua senha ou alterações associado logon (por exemplo, Facebook, Google, conta da Microsoft, etc.), o usuário está conectado de todos os instâncias do navegador.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-162">The Identity system allow you to configure your app so when the users security profile changes (for example, when the user changes their password or changes associated login (such as from Facebook, Google, Microsoft account, etc.), the user is logged out of all browser instances.</span></span> <span data-ttu-id="d9ae3-163">Por exemplo, a imagem abaixo mostra os [exemplo de saída única](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) aplicativo, que permite que o usuário saia de todas as instâncias do navegador (nesse caso, IE, Firefox e Chrome), clicando em um botão.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-163">For example, the image below shows the [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app, which allows the user to sign out of all browser instances (in this case, IE, Firefox and Chrome) by clicking one button.</span></span> <span data-ttu-id="d9ae3-164">Como alternativa, o exemplo permite que você apenas fazer logoff de uma instância de navegador específico.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-164">Alternatively, the sample allows you to only log out of a specific browser instance.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image11.png)

<span data-ttu-id="d9ae3-165">O [exemplo de saída única](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) aplicativo mostra como a identidade do ASP.NET permite que você regenerar o token de segurança.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-165">The [Single signout sample](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/SingleSignOutSample/readme.txt) app shows how ASP.NET Identity allows you to regenerate the security token.</span></span> <span data-ttu-id="d9ae3-166">Isso é necessário para garantir que todos os tokens (cookies) gerados com a senha antiga são invalidados.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-166">This is needed to ensure that any tokens (cookies) generated with the old password are invalidated.</span></span> <span data-ttu-id="d9ae3-167">Esse recurso fornece uma camada extra de segurança para seu aplicativo. Quando você altera sua senha, desconectado no qual você fez logon no aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-167">This feature provides an extra layer of security to your application; when you change your password, you will be logged out where you have logged into this application.</span></span>

<span data-ttu-id="d9ae3-168">O *App\_Start\IdentityConfig.cs* arquivo contém o `ApplicationUserManager`, `EmailService` e `SmsService` classes.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-168">The *App\_Start\IdentityConfig.cs* file contains the `ApplicationUserManager`, `EmailService` and `SmsService` classes.</span></span> <span data-ttu-id="d9ae3-169">O `EmailService` e `SmsService` classes cada implementam o `IIdentityMessageService` da interface, para que você tenha métodos comuns em cada classe para configurar o email e SMS.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-169">The `EmailService` and `SmsService` classes each implement the `IIdentityMessageService` interface, so you have common methods in each class to configure email and SMS.</span></span> <span data-ttu-id="d9ae3-170">Embora este tutorial apenas mostra como adicionar notificação por email por meio [SendGrid](http://sendgrid.com/), você pode enviar emails usando SMTP e outros mecanismos.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-170">Although this tutorial only shows how to add email notification through [SendGrid](http://sendgrid.com/), you can send email using SMTP and other mechanisms.</span></span>

<span data-ttu-id="d9ae3-171">O `Startup` classe também contém chapa clichê para adicionar logons sociais (Facebook, Twitter, etc.), consulte meu tutorial [aplicativo do MVC 5 com o Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) para obter mais informações.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-171">The `Startup` class also contains boiler plate to add social logins (Facebook, Twitter, etc.), see my tutorial [MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) for more info.</span></span>

<span data-ttu-id="d9ae3-172">Examinar o `ApplicationUserManager` classe, que contém as informações de identidade de usuários e configura os seguintes recursos:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-172">Examine the `ApplicationUserManager` class, which contains the users identity information and configures the following features:</span></span>

- <span data-ttu-id="d9ae3-173">Requisitos de força de senha.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-173">Password strength requirements.</span></span>
- <span data-ttu-id="d9ae3-174">Bloqueio de usuário (tentativas e tempo).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-174">User lock out (attempts and time).</span></span>
- <span data-ttu-id="d9ae3-175">Autenticação de dois fatores (2FA).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-175">Two-factor authentication (2FA).</span></span> <span data-ttu-id="d9ae3-176">Falarei sobre 2FA e SMS em outro tutorial.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-176">I'll cover 2FA and SMS in another tutorial.</span></span>
- <span data-ttu-id="d9ae3-177">Vinculando o email e serviços do SMS.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-177">Hooking up the email and SMS services.</span></span> <span data-ttu-id="d9ae3-178">(Falarei sobre SMS em outro tutorial).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-178">(I'll cover SMS in another tutorial).</span></span>

<span data-ttu-id="d9ae3-179">O `ApplicationUserManager` deriva de classe genérica `UserManager<ApplicationUser>` classe.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-179">The `ApplicationUserManager` class derives from the generic `UserManager<ApplicationUser>` class.</span></span> <span data-ttu-id="d9ae3-180">`ApplicationUser` deriva [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-180">`ApplicationUser` derives from [IdentityUser](https://msdn.microsoft.com/library/microsoft.aspnet.identity.entityframework.identityuser.aspx).</span></span> <span data-ttu-id="d9ae3-181">`IdentityUser` deriva o genérico `IdentityUser` classe:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-181">`IdentityUser` derives from the generic `IdentityUser` class:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample1.cs)]

<span data-ttu-id="d9ae3-182">As propriedades acima coincidirem com as propriedades no `AspNetUsers` tabela, como mostrada acima.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-182">The properties above coincide with the properties in the `AspNetUsers` table, shown above.</span></span>

<span data-ttu-id="d9ae3-183">Argumentos genéricos em `IUser` permitem que você derivar uma classe usando diferentes tipos para a chave primária.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-183">Generic arguments on `IUser` enable you to derive a class using different types for the primary key.</span></span> <span data-ttu-id="d9ae3-184">Consulte a [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) exemplo que mostra como alterar a chave primária da cadeia de caracteres em int ou GUID.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-184">See the [ChangePK](https://aspnet.codeplex.com/SourceControl/latest#Samples/Identity/ChangePK/readme.txt) sample which shows how to change the primary key from string to int or GUID.</span></span>

### <a name="applicationuser"></a><span data-ttu-id="d9ae3-185">ApplicationUser</span><span class="sxs-lookup"><span data-stu-id="d9ae3-185">ApplicationUser</span></span>

<span data-ttu-id="d9ae3-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) é definida no *Models\IdentityModels.cs* como:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-186">`ApplicationUser` (`public class ApplicationUserManager : UserManager<ApplicationUser>`) is defined in *Models\IdentityModels.cs* as:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample2.cs?highlight=8-9)]

<span data-ttu-id="d9ae3-187">O código realçado acima gera um [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-187">The highlighted code above generates a [ClaimsIdentity](https://msdn.microsoft.com/library/system.security.claims.claimsidentity.aspx).</span></span> <span data-ttu-id="d9ae3-188">Identidade do ASP.NET e OWIN Cookie de autenticação baseada em declarações, portanto o framework requer que o aplicativo para gerar um `ClaimsIdentity` para o usuário.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-188">ASP.NET Identity and OWIN Cookie Authentication are claims-based, therefore the framework requires the app to generate a `ClaimsIdentity` for the user.</span></span> <span data-ttu-id="d9ae3-189">`ClaimsIdentity` contém informações sobre todas as declarações para o usuário, como o nome do usuário, a idade e as funções que o usuário pertence.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-189">`ClaimsIdentity` has information about all the claims for the user, such as the user's name, age and what roles the user belongs to.</span></span> <span data-ttu-id="d9ae3-190">Você também pode adicionar mais declarações para o usuário neste estágio.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-190">You can also add more claims for the user at this stage.</span></span>

<span data-ttu-id="d9ae3-191">O OWIN `AuthenticationManager.SignIn` método passa o `ClaimsIdentity` e o usuário fizer logon:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-191">The OWIN `AuthenticationManager.SignIn` method passes in the `ClaimsIdentity` and signs in the user:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample3.cs?highlight=4-6)]

<span data-ttu-id="d9ae3-192">[Aplicativo do MVC 5 com o Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) mostra como você pode adicionar propriedades adicionais para o `ApplicationUser` classe.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-192">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) shows how you can add additional properties to the `ApplicationUser` class.</span></span>

## <a name="email-confirmation"></a><span data-ttu-id="d9ae3-193">Email de confirmação</span><span class="sxs-lookup"><span data-stu-id="d9ae3-193">Email confirmation</span></span>

<span data-ttu-id="d9ae3-194">É uma boa ideia para confirmar o email de um novo usuário se registrar para verificar se eles não são representando a outra pessoa (ou seja, eles ainda não registrados com o email de outra pessoa).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-194">It's a good idea to confirm the email a new user register with to verify they are not impersonating someone else (that is, they haven't registered with someone else's email).</span></span> <span data-ttu-id="d9ae3-195">Suponha que você tivesse um fórum de discussão, convém evitar `"bob@example.com"` de registrar como `"joe@contoso.com"`.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-195">Suppose you had a discussion forum, you would want to prevent `"bob@example.com"` from registering as `"joe@contoso.com"`.</span></span> <span data-ttu-id="d9ae3-196">Sem email de confirmação, `"joe@contoso.com"` poderia obter email indesejado do seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-196">Without email confirmation, `"joe@contoso.com"` could get unwanted email from your app.</span></span> <span data-ttu-id="d9ae3-197">Suponha que Bob acidentalmente registrado como `"bib@example.com"` e ainda não tenha notado, ele não seria capaz de usar a senha de recuperação porque o aplicativo não tiver seu email correto.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-197">Suppose Bob accidently registered as `"bib@example.com"` and hadn't noticed it, he wouldn't be able to use password recover because the app doesn't have his correct email.</span></span> <span data-ttu-id="d9ae3-198">Email de confirmação fornece apenas proteção limitada de bots e não fornece proteção de determinado remetentes de spam, eles têm muitos aliases de email de trabalho, que eles podem usar para se registrar. No exemplo a seguir, o usuário não poderá alterar sua senha até que sua conta foi confirmada (por eles clicando em um link de confirmação recebido na conta de email, eles registrados com o.) Você pode aplicar esse fluxo de trabalho a outros cenários, por exemplo, enviando um link para confirmar e redefinir a senha em novas contas criadas pelo administrador, enviar um email de usuário quando eles forem alterados seu perfil e assim por diante.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-198">Email confirmation provides only limited protection from bots and doesn't provide protection from determined spammers, they have many working email aliases they can use to register.In the sample below, the user won't be able to change their password until their account has been confirmed (by them clicking on a confirmation link received on the email account they registered with.) You can apply this work flow to other scenarios, for example sending a link to confirm and reset the password on new accounts created by the administrator, sending the user an email when they have changed their profile and so on.</span></span> <span data-ttu-id="d9ae3-199">Você geralmente deseja impedir que usuários novos lançamentos de todos os dados para seu site da web antes de confirmar por email, uma mensagem de texto SMS ou outro mecanismo.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-199">You generally want to prevent new users from posting any data to your web site before they have been confirmed by email, a SMS text message or another mechanism.</span></span> <a id="build"></a>

## <a name="building-a-more-complete-sample"></a><span data-ttu-id="d9ae3-200">Criando um exemplo mais completo</span><span class="sxs-lookup"><span data-stu-id="d9ae3-200">Building a more complete sample</span></span>

<span data-ttu-id="d9ae3-201">Nesta seção, você usará o NuGet para baixar um exemplo mais completo, com que trabalharemos.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-201">In this section, you'll use NuGet to download a more complete sample we will work with.</span></span>

1. <span data-ttu-id="d9ae3-202">Criar um novo ***vazio*** projeto Web do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-202">Create a new ***empty*** ASP.NET Web project.</span></span>
2. <span data-ttu-id="d9ae3-203">No Console do Gerenciador de pacotes, digite o seguinte os comandos a seguir:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-203">In the Package Manager Console, enter the following the following commands:</span></span> 

    [!code-console[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample4.cmd)]

   <span data-ttu-id="d9ae3-204">Neste tutorial, usaremos [SendGrid](http://sendgrid.com/) para enviar email.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-204">In this tutorial, we'll use [SendGrid](http://sendgrid.com/) to send email.</span></span> <span data-ttu-id="d9ae3-205">O `Identity.Samples` pacote instala o código que podemos trabalhará.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-205">The `Identity.Samples` package installs the code we will be working with.</span></span>
3. <span data-ttu-id="d9ae3-206">Defina as [projeto para usar SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-206">Set the [project to use SSL](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md).</span></span>
4. <span data-ttu-id="d9ae3-207">Criação de conta local de teste, executando o aplicativo, clicando na **registrar** vincular e, em seguida, postar o formulário de registro.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-207">Test local account creation by running the app, clicking on the **Register** link, and posting the registration form.</span></span>
5. <span data-ttu-id="d9ae3-208">Clique no link de email de demonstração, que simula o email de confirmação.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-208">Click the demo email link, which simulates email confirmation.</span></span>
6. <span data-ttu-id="d9ae3-209">Remover o código de confirmação de link de email de demonstração de exemplo (o `ViewBag.Link` código no controlador da conta.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-209">Remove the demo email link confirmation code from the sample (The `ViewBag.Link` code in the account controller.</span></span> <span data-ttu-id="d9ae3-210">Consulte a `DisplayEmail` e `ForgotPasswordConfirmation` métodos de ação e as exibições do razor).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-210">See the `DisplayEmail` and `ForgotPasswordConfirmation` action methods and razor views ).</span></span>

> [!NOTE]
> <span data-ttu-id="d9ae3-211">Aviso: Se você alterar as configurações de segurança neste exemplo, aplicativos de produções precisará passar por uma auditoria de segurança que chama explicitamente as alterações feitas.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-211">Warning: If you change any of the security settings in this sample, productions apps will need to undergo a security audit that explicitly calls the changes made.</span></span>


## <a name="examine-the-code-in-appstartidentityconfigcs"></a><span data-ttu-id="d9ae3-212">Examine o código no aplicativo\_Start\IdentityConfig.cs</span><span class="sxs-lookup"><span data-stu-id="d9ae3-212">Examine the code in App\_Start\IdentityConfig.cs</span></span>

<span data-ttu-id="d9ae3-213">O exemplo mostra como criar uma conta e adicioná-lo para o *Admin* função.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-213">The sample shows how to create an account and add it to the *Admin* role.</span></span> <span data-ttu-id="d9ae3-214">Você deve substituir o email no exemplo com o email que você usará para a conta de administrador.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-214">You should replace the email in the sample with the email you will be using for the admin account.</span></span> <span data-ttu-id="d9ae3-215">A maneira mais fácil no momento para criar uma conta de administrador está em modo programático o `Seed` método.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-215">The easiest way right now to create an administrator account is programmatically in the `Seed` method.</span></span> <span data-ttu-id="d9ae3-216">Esperamos ter no futuro uma ferramenta que permitirá que você criar e administrar usuários e funções.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-216">We hope to have a tool in the future that will allow you to create and administer users and roles.</span></span> <span data-ttu-id="d9ae3-217">O exemplo de código permitem que você criar e gerenciar usuários e funções, mas você deve primeiramente ter uma conta de administradores para executar as funções e as páginas de administração de usuário.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-217">The sample code does let you create and manage users and roles, but you must first have an administrators account to run the roles and user admin pages.</span></span> <span data-ttu-id="d9ae3-218">Neste exemplo, a conta de administrador é criada quando o BD será propagado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-218">In this sample, the admin account is created when the DB is seeded.</span></span>

<span data-ttu-id="d9ae3-219">Alterar a senha e altere o nome para uma conta em que você pode receber notificações por email.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-219">Change the password and change the name to an account where you can receive email notifications.</span></span>

> [!WARNING]
> <span data-ttu-id="d9ae3-220">Security - nunca armazenar os dados confidenciais em seu código-fonte.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-220">Security - Never store sensitive data in your source code.</span></span>

<span data-ttu-id="d9ae3-221">Conforme mencionado anteriormente, o `app.CreatePerOwinContext` chamada na classe startup adiciona os retornos de chamada para o `Create` método os aplicativo banco de dados de conteúdo, manager e a função Gerenciador de classes de usuário.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-221">As mentioned previously, the `app.CreatePerOwinContext` call in the startup class adds callbacks to the `Create` method of the app DB content, user manager and role manger classes.</span></span> <span data-ttu-id="d9ae3-222">Chamadas de pipeline do OWIN a `Create` método sobre essas classes para cada solicitação e armazena o contexto para cada classe.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-222">The OWIN pipeline calls the `Create` method on these classes for each request and stores the context for each class.</span></span> <span data-ttu-id="d9ae3-223">O controlador de conta expõe o gerente do usuário do contexto HTTP (que contém o contexto do OWIN):</span><span class="sxs-lookup"><span data-stu-id="d9ae3-223">The account controller exposes the user manager from the HTTP context (which contains the OWIN context):</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample5.cs)]

<span data-ttu-id="d9ae3-224">Quando um usuário registra uma conta local, o `HTTP Post Register` método é chamado:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-224">When a user registers a local account, the `HTTP Post Register` method is called:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample6.cs)]

<span data-ttu-id="d9ae3-225">O código acima usa os dados de modelo para criar uma nova conta de usuário usando o email e a senha digitada.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-225">The code above uses the model data to create a new user account using the email and password entered.</span></span> <span data-ttu-id="d9ae3-226">Se o alias de email está no repositório de dados, falha na criação da conta e o formulário é exibido novamente.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-226">If the email alias is in the data store, account creation fails and the form is displayed again.</span></span> <span data-ttu-id="d9ae3-227">O `GenerateEmailConfirmationTokenAsync` método cria um token de confirmação seguro e o armazena no armazenamento de dados de identidade do ASP.NET.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-227">The `GenerateEmailConfirmationTokenAsync` method creates a secure confirmation token and stores it in the ASP.NET Identity data store.</span></span> <span data-ttu-id="d9ae3-228">O [Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) método cria um link que contém o `UserId` e token de confirmação.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-228">The [Url.Action](https://msdn.microsoft.com/library/dd505232(v=vs.118).aspx) method creates a link containing the `UserId` and confirmation token.</span></span> <span data-ttu-id="d9ae3-229">Esse link, em seguida, é enviado por email para o usuário, o usuário pode clicar no link no seu aplicativo de email para confirmar sua conta.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-229">This link is then emailed to the user, the user can click on the link in their email app to confirm their account.</span></span>

<a id="email"></a>

## <a name="set-up-email-confirmation"></a><span data-ttu-id="d9ae3-230">Configurar o email de confirmação</span><span class="sxs-lookup"><span data-stu-id="d9ae3-230">Set up email confirmation</span></span>

<span data-ttu-id="d9ae3-231">Vá para o [página de inscrição do Azure SendGrid](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) e registrar a conta gratuita.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-231">Go to the [Azure SendGrid sign up page](https://azure.microsoft.com/gallery/store/sendgrid/sendgrid-azure/) and register for free account.</span></span> <span data-ttu-id="d9ae3-232">Adicione código semelhante ao seguinte para configurar o SendGrid:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-232">Add code similar to the following to configure SendGrid:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample7.cs?highlight=5)]

> [!NOTE]
> <span data-ttu-id="d9ae3-233">Clientes de email com frequência aceitam apenas mensagens de texto (nenhum HTML).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-233">Email clients frequently accept only text messages (no HTML).</span></span> <span data-ttu-id="d9ae3-234">Você deve fornecer a mensagem de texto e HTML.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-234">You should provide the message in text and HTML.</span></span> <span data-ttu-id="d9ae3-235">No exemplo de SendGrid acima, isso é feito com o `myMessage.Text` e `myMessage.Html` código mostrado acima.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-235">In the SendGrid sample above, this is done with the `myMessage.Text` and `myMessage.Html` code shown above.</span></span>


<span data-ttu-id="d9ae3-236">O código a seguir mostra como enviar email usando o [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) classe onde `message.Body` retorna somente o link.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-236">The following code shows how to send email using the [MailMessage](https://msdn.microsoft.com/library/system.net.mail.mailmessage.aspx) class where `message.Body` returns only the link.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample8.cs)]

> [!WARNING]
> <span data-ttu-id="d9ae3-237">Security - nunca armazenar os dados confidenciais em seu código-fonte.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-237">Security - Never store sensitive data in your source code.</span></span> <span data-ttu-id="d9ae3-238">A conta e as credenciais são armazenadas na appSetting.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-238">The account and credentials are stored in the appSetting.</span></span> <span data-ttu-id="d9ae3-239">No Azure, você pode armazenar com segurança esses valores sobre o **[configurar](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** guia no portal do Azure.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-239">On Azure, you can securely store these values on the **[Configure](https://blogs.msdn.com/b/webdev/archive/2014/06/04/queuebackgroundworkitem-to-reliably-schedule-and-run-long-background-process-in-asp-net.aspx)** tab in the Azure portal.</span></span> <span data-ttu-id="d9ae3-240">Ver [práticas recomendadas para implantar senhas e outros dados confidenciais no ASP.NET e o Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-240">See [Best practices for deploying passwords and other sensitive data to ASP.NET and Azure](best-practices-for-deploying-passwords-and-other-sensitive-data-to-aspnet-and-azure.md).</span></span>


<span data-ttu-id="d9ae3-241">Insira suas credenciais do SendGrid, executar o aplicativo, registre-se com um alias de email pode clicar no link confirmar seu email.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-241">Enter your SendGrid credentials, run the app, register with an email alias can click the confirm link in your email.</span></span> <span data-ttu-id="d9ae3-242">Para ver como fazer isso com seus [Outlook.com](http://outlook.com) conta de email, consulte de John Atten [c# configuração de SMTP para o Host de SMTP do Outlook.Com](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) e o seu[ASP.NET 2.0 de identidade: validação da configuração de backup de conta Autorização de dois fatores e](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) postagens.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-242">To see how to do this with your [Outlook.com](http://outlook.com) email account, see John Atten's [C# SMTP Configuration for Outlook.Com SMTP Host](http://typecastexception.com/post/2013/12/20/C-SMTP-Configuration-for-OutlookCom-SMTP-Host.aspx) and his[ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) posts.</span></span>

<span data-ttu-id="d9ae3-243">Depois que um usuário clica o **registrar** botão um email de confirmação que contém um token de validação é enviado para seu endereço de email.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-243">Once a user clicks the **Register** button a confirmation email containing a validation token is sent to their email address.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image12.png)

<span data-ttu-id="d9ae3-244">O usuário é enviado um email com um token de confirmação para sua conta.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-244">The user is sent an email with a confirmation token for their account.</span></span>

![](account-confirmation-and-password-recovery-with-aspnet-identity/_static/image13.png)

## <a name="examine-the-code"></a><span data-ttu-id="d9ae3-245">Examinar o código</span><span class="sxs-lookup"><span data-stu-id="d9ae3-245">Examine the code</span></span>

<span data-ttu-id="d9ae3-246">O código a seguir mostra o método `POST ForgotPassword`.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-246">The following code shows the `POST ForgotPassword` method.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample9.cs)]

<span data-ttu-id="d9ae3-247">O método falhará silenciosamente se o email do usuário não foi confirmado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-247">The method fails silently if the user email has not been confirmed.</span></span> <span data-ttu-id="d9ae3-248">Se um erro foi lançado para um endereço de email inválido, usuários mal-intencionados poderiam usar essas informações para localizar a userId válido (alias de email) a ataques.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-248">If an error was posted for an invalid email address, malicious users could use that information to find valid userId (email aliases) to attack.</span></span>

<span data-ttu-id="d9ae3-249">O seguinte código mostra o `ConfirmEmail` método no controlador da conta que é chamado quando o usuário clica no link de confirmação no email enviado para eles:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-249">The following code shows the `ConfirmEmail` method in the account controller that is called when the user clicks the confirmation link in the email sent to them:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample10.cs)]

<span data-ttu-id="d9ae3-250">Depois que um token de senha esquecida tiver sido usado, ele será invalidado.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-250">Once a forgotten password token has been used, it's invalidated.</span></span> <span data-ttu-id="d9ae3-251">A seguinte alteração de código na `Create` método (em de *App\_Start\IdentityConfig.cs* arquivo) define os tokens para expirar em 3 horas.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-251">The following code change in the `Create` method (in the *App\_Start\IdentityConfig.cs* file) sets the tokens to expire in 3 hours.</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample11.cs?highlight=6-8)]

<span data-ttu-id="d9ae3-252">Com o código acima, a senha esquecida e os tokens de confirmação de email irá expirar em 3 horas.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-252">With the code above, the forgotten password and the email confirmation tokens will expire in 3 hours.</span></span> <span data-ttu-id="d9ae3-253">O padrão `TokenLifespan` é um dia.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-253">The default `TokenLifespan` is one day.</span></span>

<span data-ttu-id="d9ae3-254">O código a seguir mostra o método de confirmação de email:</span><span class="sxs-lookup"><span data-stu-id="d9ae3-254">The following code shows the email confirmation method:</span></span>

[!code-csharp[Main](account-confirmation-and-password-recovery-with-aspnet-identity/samples/sample12.cs)]

 <span data-ttu-id="d9ae3-255">Para tornar seu aplicativo mais seguro, a identidade do ASP.NET oferece suporte a autenticação de dois fatores (2FA).</span><span class="sxs-lookup"><span data-stu-id="d9ae3-255">To make your app more secure, ASP.NET Identity supports Two-Factor authentication (2FA).</span></span> <span data-ttu-id="d9ae3-256">Ver [identidade do ASP.NET 2.0: Configurando a validação da conta e a autorização de dois fatores](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) por John Atten.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-256">See [ASP.NET Identity 2.0: Setting Up Account Validation and Two-Factor Authorization](http://typecastexception.com/post/2014/04/20/ASPNET-Identity-20-Setting-Up-Account-Validation-and-Two-Factor-Authorization.aspx) by John Atten.</span></span> <span data-ttu-id="d9ae3-257">Embora você possa definir o bloqueio de conta em falhas de tentativa de senha de logon, essa abordagem torna seu logon suscetíveis a [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) bloqueios.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-257">Although you can set account lockout on login password attempt failures, that approach makes your login susceptible to [DOS](http://en.wikipedia.org/wiki/Denial-of-service_attack) lockouts.</span></span> <span data-ttu-id="d9ae3-258">É recomendável que você use o bloqueio de conta apenas com 2FA.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-258">We recommend you use account lockout only with 2FA.</span></span>  
<a id="addRes"></a>

## <a name="additional-resources"></a><span data-ttu-id="d9ae3-259">Recursos adicionais</span><span class="sxs-lookup"><span data-stu-id="d9ae3-259">Additional Resources</span></span>

- [<span data-ttu-id="d9ae3-260">Visão geral de provedores de armazenamento personalizados para a Identidade do ASP.NET</span><span class="sxs-lookup"><span data-stu-id="d9ae3-260">Overview of Custom Storage Providers for ASP.NET Identity</span></span>](../extensibility/overview-of-custom-storage-providers-for-aspnet-identity.md)
- <span data-ttu-id="d9ae3-261">[Aplicativo do MVC 5 com o Facebook, Twitter, LinkedIn e Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) também mostra como adicionar informações de perfil para a tabela de usuários.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-261">[MVC 5 App with Facebook, Twitter, LinkedIn and Google OAuth2 Sign-on](../../../mvc/overview/security/create-an-aspnet-mvc-5-app-with-facebook-and-google-oauth2-and-openid-sign-on.md) also shows how to add profile information to the users table.</span></span>
- <span data-ttu-id="d9ae3-262">[ASP.NET MVC e identidade 2.0: Noções básicas sobre os conceitos básicos](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) por John Atten.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-262">[ASP.NET MVC and Identity 2.0: Understanding the Basics](http://typecastexception.com/post/2014/04/20/ASPNET-MVC-and-Identity-20-Understanding-the-Basics.aspx) by John Atten.</span></span>
- [<span data-ttu-id="d9ae3-263">Introdução à Identidade do ASP.NET</span><span class="sxs-lookup"><span data-stu-id="d9ae3-263">Introduction to ASP.NET Identity</span></span>](../getting-started/introduction-to-aspnet-identity.md)
- <span data-ttu-id="d9ae3-264">[Anunciando o RTM do ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) de Pranav Rastogi.</span><span class="sxs-lookup"><span data-stu-id="d9ae3-264">[Announcing RTM of ASP.NET Identity 2.0.0](https://blogs.msdn.com/b/webdev/archive/2014/03/20/test-announcing-rtm-of-asp-net-identity-2-0-0.aspx) by Pranav Rastogi.</span></span>
