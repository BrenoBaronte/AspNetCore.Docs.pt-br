---
title: "Lógica de teste do controlador no núcleo do ASP.NET"
author: ardalis
description: "Aprenda a lógica do controlador de teste no núcleo do ASP.NET com Moq e xUnit."
keywords: "ASP.NET Core, controlador, teste, teste, teste de unidade, testes de unidade, teste de integração, testes de integração, xUnit"
ms.author: riande
manager: wpickett
ms.date: 10/14/2016
ms.topic: article
ms.assetid: dd4135ec-2b15-410c-b3fb-3d12eed4a1ac
ms.technology: aspnet
ms.prod: asp.net-core
uid: mvc/controllers/testing
ms.openlocfilehash: aa60912e06946bd0df4936d33c88d3bf7b69984c
ms.sourcegitcommit: 9a9483aceb34591c97451997036a9120c3fe2baf
ms.translationtype: MT
ms.contentlocale: pt-BR
ms.lasthandoff: 11/10/2017
---
# <a name="testing-controller-logic-in-aspnet-core"></a><span data-ttu-id="f8151-104">Lógica de teste do controlador no núcleo do ASP.NET</span><span class="sxs-lookup"><span data-stu-id="f8151-104">Testing controller logic in ASP.NET Core</span></span>

<span data-ttu-id="f8151-105">Por [Steve Smith](https://ardalis.com/)</span><span class="sxs-lookup"><span data-stu-id="f8151-105">By [Steve Smith](https://ardalis.com/)</span></span>

<span data-ttu-id="f8151-106">Os controladores em aplicativos ASP.NET MVC devem ser pequeno e se concentrem em questões de interface do usuário.</span><span class="sxs-lookup"><span data-stu-id="f8151-106">Controllers in ASP.NET MVC apps should be small and focused on user-interface concerns.</span></span> <span data-ttu-id="f8151-107">Grandes controladores que lidam com preocupações de interface de usuário não são mais difíceis de testar e manter.</span><span class="sxs-lookup"><span data-stu-id="f8151-107">Large controllers that deal with non-UI concerns are more difficult to test and maintain.</span></span>

[<span data-ttu-id="f8151-108">Exibir ou baixar o exemplo do GitHub</span><span class="sxs-lookup"><span data-stu-id="f8151-108">View or download sample from GitHub</span></span>](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample)

## <a name="testing-controllers"></a><span data-ttu-id="f8151-109">Controladores de teste</span><span class="sxs-lookup"><span data-stu-id="f8151-109">Testing controllers</span></span>

<span data-ttu-id="f8151-110">Os controladores são uma parte central de qualquer aplicativo MVC do ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="f8151-110">Controllers are a central part of any ASP.NET Core MVC application.</span></span> <span data-ttu-id="f8151-111">Como tal, você deve ter confiança que se comportam conforme o esperado para seu aplicativo.</span><span class="sxs-lookup"><span data-stu-id="f8151-111">As such, you should have confidence they behave as intended for your app.</span></span> <span data-ttu-id="f8151-112">Testes automatizados podem fornecer essa confiança e podem detectar erros antes que elas atinjam a produção.</span><span class="sxs-lookup"><span data-stu-id="f8151-112">Automated tests can provide you with this confidence and can detect errors before they reach production.</span></span> <span data-ttu-id="f8151-113">É importante evitar colocar desnecessárias responsabilidades dentro de seus controladores e certifique-se o foco de testes somente nas responsabilidades de controlador.</span><span class="sxs-lookup"><span data-stu-id="f8151-113">It's important to avoid placing unnecessary responsibilities within your controllers and ensure your tests focus only on controller responsibilities.</span></span>

<span data-ttu-id="f8151-114">Lógica do controlador deve ser mínima e não se concentrar na lógica ou infraestrutura do negócio (por exemplo, acesso a dados).</span><span class="sxs-lookup"><span data-stu-id="f8151-114">Controller logic should be minimal and not be focused on business logic or infrastructure concerns (for example, data access).</span></span> <span data-ttu-id="f8151-115">Lógica do controlador, não o framework de teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-115">Test controller logic, not the framework.</span></span> <span data-ttu-id="f8151-116">Teste como o controlador *se comporta* com base em entradas válidas ou inválidas.</span><span class="sxs-lookup"><span data-stu-id="f8151-116">Test how the controller *behaves* based on valid or invalid inputs.</span></span> <span data-ttu-id="f8151-117">Teste as respostas do controlador com base no resultado da operação de negócios que ele executa.</span><span class="sxs-lookup"><span data-stu-id="f8151-117">Test controller responses based on the result of the business operation it performs.</span></span>

<span data-ttu-id="f8151-118">Responsabilidades do controlador típico:</span><span class="sxs-lookup"><span data-stu-id="f8151-118">Typical controller responsibilities:</span></span>

* <span data-ttu-id="f8151-119">Verifique se `ModelState.IsValid`.</span><span class="sxs-lookup"><span data-stu-id="f8151-119">Verify `ModelState.IsValid`.</span></span>
* <span data-ttu-id="f8151-120">Retornar uma resposta de erro se `ModelState` é inválido.</span><span class="sxs-lookup"><span data-stu-id="f8151-120">Return an error response if `ModelState` is invalid.</span></span>
* <span data-ttu-id="f8151-121">Recupere uma entidade de negócios de persistência.</span><span class="sxs-lookup"><span data-stu-id="f8151-121">Retrieve a business entity from persistence.</span></span>
* <span data-ttu-id="f8151-122">Execute uma ação na entidade de negócios.</span><span class="sxs-lookup"><span data-stu-id="f8151-122">Perform an action on the business entity.</span></span>
* <span data-ttu-id="f8151-123">Salve a entidade de negócios para persistência.</span><span class="sxs-lookup"><span data-stu-id="f8151-123">Save the business entity to persistence.</span></span>
* <span data-ttu-id="f8151-124">Retornar um apropriado `IActionResult`.</span><span class="sxs-lookup"><span data-stu-id="f8151-124">Return an appropriate `IActionResult`.</span></span>

## <a name="unit-testing"></a><span data-ttu-id="f8151-125">Teste de unidade</span><span class="sxs-lookup"><span data-stu-id="f8151-125">Unit testing</span></span>

<span data-ttu-id="f8151-126">[Teste de unidade](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) envolve uma parte de um aplicativo de teste em isolamento de sua infraestrutura e as dependências.</span><span class="sxs-lookup"><span data-stu-id="f8151-126">[Unit testing](https://docs.microsoft.com/dotnet/articles/core/testing/unit-testing-with-dotnet-test) involves testing a part of an app in isolation from its infrastructure and dependencies.</span></span> <span data-ttu-id="f8151-127">Quando a lógica do controlador, somente o conteúdo de uma única ação de teste de unidade é testada, não o comportamento de suas dependências ou a própria estrutura.</span><span class="sxs-lookup"><span data-stu-id="f8151-127">When unit testing controller logic, only the contents of a single action is tested, not the behavior of its dependencies or of the framework itself.</span></span> <span data-ttu-id="f8151-128">Como você unidade suas ações do controlador de teste, verifique se que você se concentrar apenas em seu comportamento.</span><span class="sxs-lookup"><span data-stu-id="f8151-128">As you unit test your controller actions, make sure you focus only on its behavior.</span></span> <span data-ttu-id="f8151-129">Um teste de unidade do controlador evita coisas como [filtros](filters.md), [roteamento](../../fundamentals/routing.md), ou [associação de modelo](../models/model-binding.md).</span><span class="sxs-lookup"><span data-stu-id="f8151-129">A controller unit test avoids things like [filters](filters.md), [routing](../../fundamentals/routing.md), or [model binding](../models/model-binding.md).</span></span> <span data-ttu-id="f8151-130">Focalizar no teste apenas uma coisa, testes de unidade geralmente são simples de escrever e rápido executar.</span><span class="sxs-lookup"><span data-stu-id="f8151-130">By focusing on testing just one thing, unit tests are generally simple to write and quick to run.</span></span> <span data-ttu-id="f8151-131">Um conjunto bem escrito de testes de unidade pode ser executado com frequência sem muita sobrecarga.</span><span class="sxs-lookup"><span data-stu-id="f8151-131">A well-written set of unit tests can be run frequently without much overhead.</span></span> <span data-ttu-id="f8151-132">No entanto, os testes de unidade não detectam problemas na interação entre componentes, que é a finalidade de [testes de integração](xref:mvc/controllers/testing#integration-testing).</span><span class="sxs-lookup"><span data-stu-id="f8151-132">However, unit tests do not detect issues in the interaction between components, which is the purpose of [integration testing](xref:mvc/controllers/testing#integration-testing).</span></span>

<span data-ttu-id="f8151-133">Se você estiver escrevendo filtros personalizados, rotas, etc, faça o teste de unidade-los, mas não como parte de seus testes em uma ação do controlador específico.</span><span class="sxs-lookup"><span data-stu-id="f8151-133">If you're writing custom filters, routes, etc, you should unit test them, but not as part of your tests on a particular controller action.</span></span> <span data-ttu-id="f8151-134">Eles devem ser testados em isolamento.</span><span class="sxs-lookup"><span data-stu-id="f8151-134">They should be tested in isolation.</span></span>

> [!TIP]
> <span data-ttu-id="f8151-135">[Criar e executar testes de unidade com o Visual Studio](https://docs.microsoft.com/visualstudio/test/unit-test-your-code).</span><span class="sxs-lookup"><span data-stu-id="f8151-135">[Create and run unit tests with Visual Studio](https://docs.microsoft.com/visualstudio/test/unit-test-your-code).</span></span>

<span data-ttu-id="f8151-136">Para demonstrar o teste de unidade, examine o seguinte controlador.</span><span class="sxs-lookup"><span data-stu-id="f8151-136">To demonstrate unit testing, review the following controller.</span></span> <span data-ttu-id="f8151-137">Ele exibe uma lista de sessões de debate e permite que novas sessões serão criados com uma POSTAGEM de discussão:</span><span class="sxs-lookup"><span data-stu-id="f8151-137">It displays a list of brainstorming sessions and allows new brainstorming sessions to be created with a POST:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/HomeController.cs?highlight=12,16,21,42,43)]

<span data-ttu-id="f8151-138">O controlador é após o [princípio dependências explícitas](http://deviq.com/explicit-dependencies-principle/), esperando injeção de dependência para fornecê-la com uma instância do `IBrainstormSessionRepository`.</span><span class="sxs-lookup"><span data-stu-id="f8151-138">The controller is following the [explicit dependencies principle](http://deviq.com/explicit-dependencies-principle/), expecting dependency injection to provide it with an instance of `IBrainstormSessionRepository`.</span></span> <span data-ttu-id="f8151-139">Isso facilita bastante para teste usando uma estrutura de objeto, como [Moq](https://www.nuget.org/packages/Moq/).</span><span class="sxs-lookup"><span data-stu-id="f8151-139">This makes it fairly easy to test using a mock object framework, like [Moq](https://www.nuget.org/packages/Moq/).</span></span> <span data-ttu-id="f8151-140">O `HTTP GET Index` método não tem nenhum método de um loop ou ramificação e somente chamadas.</span><span class="sxs-lookup"><span data-stu-id="f8151-140">The `HTTP GET Index` method has no looping or branching and only calls one method.</span></span> <span data-ttu-id="f8151-141">Para testar isso `Index` método, precisamos verificar se um `ViewResult` for retornado, com um `ViewModel` do repositório de `List` método.</span><span class="sxs-lookup"><span data-stu-id="f8151-141">To test this `Index` method, we need to verify that a `ViewResult` is returned, with a `ViewModel` from the repository's `List` method.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=17-18&range=1-33,76-95)]

<span data-ttu-id="f8151-142">O `HomeController` `HTTP POST Index` método (mostrado acima) Verifique se:</span><span class="sxs-lookup"><span data-stu-id="f8151-142">The `HomeController` `HTTP POST Index` method (shown above) should verify:</span></span>

* <span data-ttu-id="f8151-143">O método de ação retorna uma solicitação incorreta `ViewResult` com os dados apropriados quando `ModelState.IsValid` é`false`</span><span class="sxs-lookup"><span data-stu-id="f8151-143">The action method returns a Bad Request `ViewResult` with the appropriate data when `ModelState.IsValid` is `false`</span></span>

* <span data-ttu-id="f8151-144">O `Add` é chamado de método no repositório e um `RedirectToActionResult` é retornado com os argumentos corretos quando `ModelState.IsValid` é verdadeiro.</span><span class="sxs-lookup"><span data-stu-id="f8151-144">The `Add` method on the repository is called and a `RedirectToActionResult` is returned with the correct arguments when `ModelState.IsValid` is true.</span></span>

<span data-ttu-id="f8151-145">Estado de modelo inválido pode ser testado com a adição de erros usando `AddModelError` conforme mostrado no primeiro teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-145">Invalid model state can be tested by adding errors using `AddModelError` as shown in the first test below.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/HomeControllerTests.cs?highlight=8,15-16,37-39&range=35-75)]

<span data-ttu-id="f8151-146">O primeiro teste confirma quando `ModelState` não é válido, o mesmo `ViewResult` é retornado como um `GET` solicitação.</span><span class="sxs-lookup"><span data-stu-id="f8151-146">The first test confirms when `ModelState` is not valid, the same `ViewResult` is returned as for a `GET` request.</span></span> <span data-ttu-id="f8151-147">Observe que o teste não tente passar de um modelo inválido.</span><span class="sxs-lookup"><span data-stu-id="f8151-147">Note that the test doesn't attempt to pass in an invalid model.</span></span> <span data-ttu-id="f8151-148">Não funciona mesmo assim como a associação de modelo não está em execução (embora uma [teste de integração](xref:mvc/controllers/testing#integration-testing) usaria exercício associação de modelo).</span><span class="sxs-lookup"><span data-stu-id="f8151-148">That wouldn't work anyway since model binding isn't running (though an [integration test](xref:mvc/controllers/testing#integration-testing) would use exercise model binding).</span></span> <span data-ttu-id="f8151-149">Nesse caso, associação de modelo não está sendo testada.</span><span class="sxs-lookup"><span data-stu-id="f8151-149">In this case, model binding is not being tested.</span></span> <span data-ttu-id="f8151-150">Esses testes de unidade estão testando apenas o que faz o código no método de ação.</span><span class="sxs-lookup"><span data-stu-id="f8151-150">These unit tests are only testing what the code in the action method does.</span></span>

<span data-ttu-id="f8151-151">O segundo teste verifica que, quando `ModelState` for válido, um novo `BrainstormSession` é adicionada (por meio do repositório), e o método retorna um `RedirectToActionResult` com as propriedades esperadas.</span><span class="sxs-lookup"><span data-stu-id="f8151-151">The second test verifies that when `ModelState` is valid, a new `BrainstormSession` is added (via the repository), and the method returns a `RedirectToActionResult` with the expected properties.</span></span> <span data-ttu-id="f8151-152">Fictícias chamadas que não forem chamadas são normalmente ignorado, mas a chamada `Verifiable` no final da instalação chamada permite que ele seja verificado no teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-152">Mocked calls that aren't called are normally ignored, but calling `Verifiable` at the end of the setup call allows it to be verified in the test.</span></span> <span data-ttu-id="f8151-153">Isso é feito com a chamada para `mockRepo.Verify`, que irá falhar no teste se o método esperado não foi chamado.</span><span class="sxs-lookup"><span data-stu-id="f8151-153">This is done with the call to `mockRepo.Verify`, which will fail the test if the expected method was not called.</span></span>

> [!NOTE]
> <span data-ttu-id="f8151-154">A biblioteca Moq usada neste exemplo torna fácil misturar simulações verificáveis ou "strict", com as simulações não verificável (também chamadas de "livre" simulações ou stubs).</span><span class="sxs-lookup"><span data-stu-id="f8151-154">The Moq library used in this sample makes it easy to mix verifiable, or "strict", mocks with non-verifiable mocks (also called "loose" mocks or stubs).</span></span> <span data-ttu-id="f8151-155">Saiba mais sobre [personalizar o comportamento de simulação com Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span><span class="sxs-lookup"><span data-stu-id="f8151-155">Learn more about [customizing Mock behavior with Moq](https://github.com/Moq/moq4/wiki/Quickstart#customizing-mock-behavior).</span></span>

<span data-ttu-id="f8151-156">Outro controlador no aplicativo exibe informações relacionadas a uma sessão de debate específico.</span><span class="sxs-lookup"><span data-stu-id="f8151-156">Another controller in the app displays information related to a particular brainstorming session.</span></span> <span data-ttu-id="f8151-157">Ele inclui alguma lógica para lidar com valores de id inválida:</span><span class="sxs-lookup"><span data-stu-id="f8151-157">It includes some logic to deal with invalid id values:</span></span>

[!code-csharp[Main](./testing/sample/TestingControllersSample/src/TestingControllersSample/Controllers/SessionController.cs?highlight=19,20,21,22,25,26,27,28)]

<span data-ttu-id="f8151-158">A ação do controlador tem três casos de teste, uma para cada `return` instrução:</span><span class="sxs-lookup"><span data-stu-id="f8151-158">The controller action has three cases to test, one for each `return` statement:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/SessionControllerTests.cs?highlight=27,28,29,46,47,64,65,66,67,68)]

<span data-ttu-id="f8151-159">O aplicativo expõe a funcionalidade como uma API (uma lista de ideias associados a uma sessão de debate e um método para adicionar novas ideias para uma sessão) da web:</span><span class="sxs-lookup"><span data-stu-id="f8151-159">The app exposes functionality as a web API (a list of ideas associated with a brainstorming session and a method for adding new ideas to a session):</span></span>

<a name="ideas-controller"></a>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Api/IdeasController.cs?highlight=21,22,27,30,31,32,33,34,35,36,41,42,46,52,65)]

<span data-ttu-id="f8151-160">O `ForSession` método retorna uma lista de `IdeaDTO` tipos.</span><span class="sxs-lookup"><span data-stu-id="f8151-160">The `ForSession` method returns a list of `IdeaDTO` types.</span></span> <span data-ttu-id="f8151-161">Evite retornar as entidades de domínio de negócios diretamente por meio de chamadas de API, desde frequentemente incluem mais dados do que o cliente API requer e eles desnecessariamente acoplar o modelo de domínio interno do aplicativo com a API que você expõe externamente.</span><span class="sxs-lookup"><span data-stu-id="f8151-161">Avoid returning your business domain entities directly via API calls, since frequently they include more data than the API client requires, and they unnecessarily couple your app's internal domain model with the API you expose externally.</span></span> <span data-ttu-id="f8151-162">Mapeamento entre as entidades de domínio e os tipos que você irá retornar eletronicamente pode ser feito manualmente (usando um LINQ `Select` conforme mostrado aqui) ou usando uma biblioteca como [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span><span class="sxs-lookup"><span data-stu-id="f8151-162">Mapping between domain entities and the types you will return over the wire can be done manually (using a LINQ `Select` as shown here) or using a library like [AutoMapper](https://github.com/AutoMapper/AutoMapper)</span></span>

<span data-ttu-id="f8151-163">Testes de unidade para o `Create` e `ForSession` métodos de API:</span><span class="sxs-lookup"><span data-stu-id="f8151-163">The unit tests for the `Create` and `ForSession` API methods:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/UnitTests/ApiIdeasControllerTests.cs?highlight=18,23,29,33,38-39,43,50,58-59,68-70,76-78&range=1-83,121-135)]

<span data-ttu-id="f8151-164">Como mencionado anteriormente, para testar o comportamento do método quando `ModelState` é inválido, adicionar um erro de modelo para o controlador como parte do teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-164">As stated previously, to test the behavior of the method when `ModelState` is invalid, add a model error to the controller as part of the test.</span></span> <span data-ttu-id="f8151-165">Não tente associação de modelo de validação ou modelo de teste nos testes de unidade - testar apenas o comportamento do seu método de ação quando houver uma com um determinado `ModelState` valor.</span><span class="sxs-lookup"><span data-stu-id="f8151-165">Don't try to test model validation or model binding in your unit tests - just test your action method's behavior when confronted with a particular `ModelState` value.</span></span>

<span data-ttu-id="f8151-166">O segundo teste depende do repositório retornando nulo, para que o repositório de simulação é configurado para retornar null.</span><span class="sxs-lookup"><span data-stu-id="f8151-166">The second test depends on the repository returning null, so the mock repository is configured to return null.</span></span> <span data-ttu-id="f8151-167">Não é necessário para criar um banco de dados de teste (na memória ou de outra forma) e criar uma consulta que retornará esse resultado - ele pode ser feito em uma única instrução, conforme mostrado.</span><span class="sxs-lookup"><span data-stu-id="f8151-167">There's no need to create a test database (in memory or otherwise) and construct a query that will return this result - it can be done in a single statement as shown.</span></span>

<span data-ttu-id="f8151-168">O último teste verifica se o repositório `Update` método é chamado.</span><span class="sxs-lookup"><span data-stu-id="f8151-168">The last test verifies that the repository's `Update` method is called.</span></span> <span data-ttu-id="f8151-169">Como foi feito anteriormente, a simulação é chamada com `Verifiable` e, em seguida, fictícios do repositório `Verify` método é chamado para confirmar se o método verificável foi executado.</span><span class="sxs-lookup"><span data-stu-id="f8151-169">As we did previously, the mock is called with `Verifiable` and then the mocked repository's `Verify` method is called to confirm the verifiable method was executed.</span></span> <span data-ttu-id="f8151-170">Não é a responsabilidade de teste de unidade para garantir que o `Update` método salva os dados; isso pode ser feito com um teste de integração.</span><span class="sxs-lookup"><span data-stu-id="f8151-170">It's not a unit test responsibility to ensure that the `Update` method saved the data; that can be done with an integration test.</span></span>

## <a name="integration-testing"></a><span data-ttu-id="f8151-171">Testes de integração</span><span class="sxs-lookup"><span data-stu-id="f8151-171">Integration testing</span></span>

<span data-ttu-id="f8151-172">[Testes de integração](../../testing/integration-testing.md) é feito para garantir módulos separados dentro de seu trabalho de aplicativo corretamente juntos.</span><span class="sxs-lookup"><span data-stu-id="f8151-172">[Integration testing](../../testing/integration-testing.md) is done to ensure separate modules within your app work correctly together.</span></span> <span data-ttu-id="f8151-173">Em geral, qualquer coisa que você pode testar com um teste de unidade, você também pode testar com um teste de integração, mas o contrário não é true.</span><span class="sxs-lookup"><span data-stu-id="f8151-173">Generally, anything you can test with a unit test, you can also test with an integration test, but the reverse isn't true.</span></span> <span data-ttu-id="f8151-174">No entanto, os testes de integração tendem a ser muito mais lento do que testes de unidade.</span><span class="sxs-lookup"><span data-stu-id="f8151-174">However, integration tests tend to be much slower than unit tests.</span></span> <span data-ttu-id="f8151-175">Assim, é melhor testar tudo o que você pode com testes de unidade e usar testes de integração para cenários que envolvem vários parceiros.</span><span class="sxs-lookup"><span data-stu-id="f8151-175">Thus, it's best to test whatever you can with unit tests, and use integration tests for scenarios that involve multiple collaborators.</span></span>

<span data-ttu-id="f8151-176">Embora ainda pode ser útil, objetos fictícios raramente são usados em testes de integração.</span><span class="sxs-lookup"><span data-stu-id="f8151-176">Although they may still be useful, mock objects are rarely used in integration tests.</span></span> <span data-ttu-id="f8151-177">Em testes de unidade, objetos fictícios são uma maneira eficiente para controlar o comportamento do parceiros fora a unidade que está sendo testada para fins de teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-177">In unit testing, mock objects are an effective way to control how collaborators outside of the unit being tested should behave for the purposes of the test.</span></span> <span data-ttu-id="f8151-178">Em um teste de integração, colaboradores reais são usadas para confirmar que o subsistema inteiro juntos funciona corretamente.</span><span class="sxs-lookup"><span data-stu-id="f8151-178">In an integration test, real collaborators are used to confirm the whole subsystem works together correctly.</span></span>

### <a name="application-state"></a><span data-ttu-id="f8151-179">Estado do aplicativo</span><span class="sxs-lookup"><span data-stu-id="f8151-179">Application state</span></span>

<span data-ttu-id="f8151-180">Uma consideração importante ao executar testes de integração é a configuração de estado do aplicativo.</span><span class="sxs-lookup"><span data-stu-id="f8151-180">One important consideration when performing integration testing is how to set your app's state.</span></span> <span data-ttu-id="f8151-181">Testes precisam ser executados independentemente um do outro e, portanto cada teste deve começar com o aplicativo em um estado conhecido.</span><span class="sxs-lookup"><span data-stu-id="f8151-181">Tests need to run independent of one another, and so each test should start with the app in a known state.</span></span> <span data-ttu-id="f8151-182">Se seu aplicativo não usar um banco de dados ou tiverem qualquer persistência, isso não pode ser um problema.</span><span class="sxs-lookup"><span data-stu-id="f8151-182">If your app doesn't use a database or have any persistence, this may not be an issue.</span></span> <span data-ttu-id="f8151-183">No entanto, a maioria dos aplicativos do mundo real manter seu estado para algum tipo de repositório de dados, para que as modificações feitas por um teste podem afetar outro teste, a menos que o repositório de dados é redefinido.</span><span class="sxs-lookup"><span data-stu-id="f8151-183">However, most real-world apps persist their state to some kind of data store, so any modifications made by one test could impact another test unless the data store is reset.</span></span> <span data-ttu-id="f8151-184">Usando o interno `TestServer`, é muito simples para hospedar aplicativos do ASP.NET Core em nossos testes de integração, mas que não necessariamente concede acesso aos dados que será usado.</span><span class="sxs-lookup"><span data-stu-id="f8151-184">Using the built-in `TestServer`, it's very straightforward to host ASP.NET Core apps within our integration tests, but that doesn't necessarily grant access to the data it will use.</span></span> <span data-ttu-id="f8151-185">Se você estiver usando um banco de dados real, uma abordagem é ter o aplicativo se conectar a um banco de dados de teste, que os testes podem acessar e verifique se é redefinido para um estado conhecido antes de executa cada teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-185">If you're using an actual database, one approach is to have the app connect to a test database, which your tests can access and ensure is reset to a known state before each test executes.</span></span>

<span data-ttu-id="f8151-186">Neste aplicativo de exemplo, estou usando o suporte de InMemoryDatabase do Entity Framework Core, portanto apenas não consigo conectar a ele do meu projeto de teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-186">In this sample application, I'm using Entity Framework Core's InMemoryDatabase support, so I can't just connect to it from my test project.</span></span> <span data-ttu-id="f8151-187">Em vez disso, expõem um `InitializeDatabase` método a partir do aplicativo `Startup` classe, o que posso chamar quando o aplicativo é iniciado se ele estiver no `Development` ambiente.</span><span class="sxs-lookup"><span data-stu-id="f8151-187">Instead, I expose an `InitializeDatabase` method from the app's `Startup` class, which I call when the app starts up if it's in the `Development` environment.</span></span> <span data-ttu-id="f8151-188">Meu testes de integração automaticamente se beneficiar com isso, desde definir o ambiente `Development`.</span><span class="sxs-lookup"><span data-stu-id="f8151-188">My integration tests automatically benefit from this as long as they set the environment to `Development`.</span></span> <span data-ttu-id="f8151-189">Não preciso se preocupar sobre como redefinir o banco de dados, pois o InMemoryDatabase é redefinido cada vez que o aplicativo reinicia.</span><span class="sxs-lookup"><span data-stu-id="f8151-189">I don't have to worry about resetting the database, since the InMemoryDatabase is reset each time the app restarts.</span></span>

<span data-ttu-id="f8151-190">O `Startup` classe:</span><span class="sxs-lookup"><span data-stu-id="f8151-190">The `Startup` class:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/src/TestingControllersSample/Startup.cs?highlight=19,20,34,35,43,52)]

<span data-ttu-id="f8151-191">Você verá o `GetTestSession` método costumam ser usado em testes de integração abaixo.</span><span class="sxs-lookup"><span data-stu-id="f8151-191">You'll see the `GetTestSession` method used frequently in the integration tests below.</span></span>

### <a name="accessing-views"></a><span data-ttu-id="f8151-192">Acessar modos de exibição</span><span class="sxs-lookup"><span data-stu-id="f8151-192">Accessing views</span></span>

<span data-ttu-id="f8151-193">Cada classe de teste de integração configura o `TestServer` que executará o aplicativo ASP.NET Core.</span><span class="sxs-lookup"><span data-stu-id="f8151-193">Each integration test class configures the `TestServer` that will run the ASP.NET Core app.</span></span> <span data-ttu-id="f8151-194">Por padrão, `TestServer` hospeda o aplicativo web na pasta onde ele está em execução - nesse caso, a pasta de projeto de teste.</span><span class="sxs-lookup"><span data-stu-id="f8151-194">By default, `TestServer` hosts the web app in the folder where it's running - in this case, the test project folder.</span></span> <span data-ttu-id="f8151-195">Assim, quando você tentar testar ações do controlador que retornam `ViewResult`, você pode ver este erro:</span><span class="sxs-lookup"><span data-stu-id="f8151-195">Thus, when you attempt to test controller actions that return `ViewResult`, you may see this error:</span></span>

```
The view 'Index' was not found. The following locations were searched:
(list of locations)
```

<span data-ttu-id="f8151-196">Para corrigir esse problema, você precisa configurar a raiz do conteúdo do servidor, para que ele possa localizar os modos de exibição para o projeto que está sendo testado.</span><span class="sxs-lookup"><span data-stu-id="f8151-196">To correct this issue, you need to configure the server's content root, so it can locate the views for the project being tested.</span></span> <span data-ttu-id="f8151-197">Isso é feito por uma chamada para `UseContentRoot` no `TestFixture` classe, como mostrado abaixo:</span><span class="sxs-lookup"><span data-stu-id="f8151-197">This is done by a call to `UseContentRoot` in the `TestFixture` class, shown below:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/TestFixture.cs?highlight=30,33)]

<span data-ttu-id="f8151-198">O `TestFixture` classe é responsável por configurar e criar o `TestServer`, configurar o um `HttpClient` para se comunicar com o `TestServer`.</span><span class="sxs-lookup"><span data-stu-id="f8151-198">The `TestFixture` class is responsible for configuring and creating the `TestServer`, setting up an `HttpClient` to communicate with the `TestServer`.</span></span> <span data-ttu-id="f8151-199">Cada uma da integração de testes usa o `Client` propriedade para se conectar ao servidor de teste e fazer uma solicitação.</span><span class="sxs-lookup"><span data-stu-id="f8151-199">Each of the integration tests uses the `Client` property to connect to the test server and make a request.</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/HomeControllerTests.cs?highlight=20,26,29,30,31,35,38,39,40,41,44,47,48)]

<span data-ttu-id="f8151-200">No primeiro teste acima, o `responseString` mantém real renderizado o HTML da exibição, que pode ser inspecionada para confirmar que ele contém os resultados esperados.</span><span class="sxs-lookup"><span data-stu-id="f8151-200">In the first test above, the `responseString` holds the actual rendered HTML from the View, which can be inspected to confirm it contains expected results.</span></span>

<span data-ttu-id="f8151-201">O segundo teste constrói um POSTAGEM de formulário com um nome de sessão exclusiva e publica o aplicativo, verifica se o redirecionamento esperado é retornado.</span><span class="sxs-lookup"><span data-stu-id="f8151-201">The second test constructs a form POST with a unique session name and POSTs it to the app, then verifies that the expected redirect is returned.</span></span>

### <a name="api-methods"></a><span data-ttu-id="f8151-202">Métodos de API</span><span class="sxs-lookup"><span data-stu-id="f8151-202">API methods</span></span>

<span data-ttu-id="f8151-203">Se seu aplicativo exponha APIs, ele é uma boa ideia ter testes automatizados confirmar que eles sejam executados conforme o esperado da web.</span><span class="sxs-lookup"><span data-stu-id="f8151-203">If your app exposes web APIs, it's a good idea to have automated tests confirm they execute as expected.</span></span> <span data-ttu-id="f8151-204">O interno `TestServer` torna mais fácil testar as APIs da web.</span><span class="sxs-lookup"><span data-stu-id="f8151-204">The built-in `TestServer` makes it easy to test web APIs.</span></span> <span data-ttu-id="f8151-205">Se seus métodos de API estiver usando a associação de modelo, você sempre deve verificar `ModelState.IsValid`, e testes de integração são o melhor lugar para confirmar se a validação de modelo está funcionando corretamente.</span><span class="sxs-lookup"><span data-stu-id="f8151-205">If your API methods are using model binding, you should always check `ModelState.IsValid`, and integration tests are the right place to confirm that your model validation is working properly.</span></span>

<span data-ttu-id="f8151-206">O seguinte conjunto de destino de testes de `Create` método o [IdeasController](xref:mvc/controllers/testing#ideas-controller) classe mostrado acima:</span><span class="sxs-lookup"><span data-stu-id="f8151-206">The following set of tests target the `Create` method in the [IdeasController](xref:mvc/controllers/testing#ideas-controller) class shown above:</span></span>

[!code-csharp[Main](testing/sample/TestingControllersSample/tests/TestingControllersSample.Tests/IntegrationTests/ApiIdeasControllerTests.cs)]

<span data-ttu-id="f8151-207">Diferentemente de testes de integração de ações que retorna os modos de exibição HTML, os métodos de API da web que retornam resultados podem normalmente ser desserializados como objetos fortemente tipados, como mostra o último teste acima.</span><span class="sxs-lookup"><span data-stu-id="f8151-207">Unlike integration tests of actions that returns HTML views, web API methods that return results can usually be deserialized as strongly typed objects, as the last test above shows.</span></span> <span data-ttu-id="f8151-208">Nesse caso, o teste desserializa o resultado para um `BrainstormSession` de instância e confirma que a ideia corretamente foi adicionada à sua coleção de ideias.</span><span class="sxs-lookup"><span data-stu-id="f8151-208">In this case, the test deserializes the result to a `BrainstormSession` instance, and confirms that the idea was correctly added to its collection of ideas.</span></span>

<span data-ttu-id="f8151-209">Você encontrará exemplos adicionais de testes de integração neste artigo [projeto de exemplo](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span><span class="sxs-lookup"><span data-stu-id="f8151-209">You'll find additional examples of integration tests in this article's [sample project](https://github.com/aspnet/Docs/tree/master/aspnetcore/mvc/controllers/testing/sample).</span></span>
